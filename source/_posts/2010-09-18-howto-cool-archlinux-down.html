---
layout: post
title: Arch不完全降溫筆記
tags:
- Arch
- Archlinux
- conky
- firefox
- Linux
- wifi
- 計算機
status: publish
type: post
published: true
comments: true
meta:
  _edit_last: '1'
  views: '2155'
  _wp_old_slug: ''
  posturl_add_url: 'yes'
  aktt_notify_twitter: 'no'
---
<p>主要目標是解決我的X200在Archlinux<em>（本文內容均基于此發行版）</em>下CPU溫度長期居高不下的問題，基本原理是使用<a href="http://wiki.archlinux.org/index.php/Cpufrequtils">cpufrequtils</a>根據CPU負載狀況自動變頻，和使用<a href="http://wiki.archlinux.org/index.php/Laptop_Mode_Tools">laptop-mode-tools</a>實現其它硬件設備的自動節能。最直接的效果是省電，從而延長電池的使用時間，產生的附加影響就是CPU及筆記本整體的溫度下降。我幾乎不用電池，所以節能不是我的關注點，但降溫卻是我所欲也。</p>

<p>首先安裝cpufrequtils，并將<strong>acpi-cpufreq</strong>、<strong>cpufreq_ondemand</strong>、<strong>cpufreq_powersave</strong>加入<strong>rc.conf</strong>的<strong>MODULES</strong>中，使系統在啟動時加載這些模塊。</p>

<p>默認情況下，內核采用cpufreq的performance模式，以獲得最高性能，現在用ondemand模式使CPU根據負載狀況自動變頻。修改<strong>/etc/conf.d/cpufreq</strong>文件，將<strong>governor</strong>項設為<strong>ondemand</strong>。</p>

<p>將<strong>cpufreq</strong>加入<strong>rc.conf</strong>的<strong>DAEMONS</strong>中，此守護進程會在系統啟動時讀取配置文件<strong>/etc/conf.d/cpufreq</strong>中的設置項，故上面設置的ondemand模式會在系統啟動時得以自動生效。</p>

<p>然後安裝laptop-mode-tools，并修改<strong>/etc/laptop-mode/laptop-mode.conf</strong>，打開所有的三個以<strong>ENABLE</strong>開頭的選項，和所有以<strong>CONTROL</strong>開頭的選項。</p>

<p>將<strong>laptop-mode</strong>加入<strong>rc.conf</strong>的<strong>DAEMONS</strong>中，使其隨系統自動啟動。</p>

<p>修改<strong>/etc/laptop-mode/conf.d/usb-autosuspend.conf</strong>，此配置文件用來配置laptop-mode如何管理USB設備的電源使用。我希望在任何時候都啟用USB設備自動節能，但需要把我的無線鼠標排除在外，故作如下配置：</p>

{% codeblock lang:bash %}
# 启用USB设备自动挂起
CONTROL_USB_AUTOSUSPEND="auto"

# 将不使用自动挂起的USB设备的ID填在下面，使用lsusb命令查看ID
AUTOSUSPEND_USBID_BLACKLIST="04fc:05dc"

# 总是启用USB自动挂起
BATT_SUSPEND_USB=1
LM_AC_SUSPEND_USB=1
NOLM_AC_SUSPEND_USB=1
{% endcodeblock %}

<p>類似地，修改<strong>intel-hda-powersave.conf</strong>，此配置文件用于配置laptop-mode如何管理Intel HDA音頻芯片的電源使用。我希望一直啟用聲卡自動節能，并適當地將自動進入節電模式的空閑時間增加到30秒，故配置如下：</p>

{% codeblock lang:bash %}
# 啟用Intel音頻芯片電源管理
CONTROL_INTEL_HDA_POWER="auto"

# 總是啟用
BATT_INTEL_HDA_POWERSAVE=1
LM_AC_INTEL_HDA_POWERSAVE=1
NOLM_AC_INTEL_HDA_POWERSAVE=1

# 適當地設置聲卡進入節電模式的超時時間
INTEL_HDA_DEVICE_TIMEOUT=30
{% endcodeblock %}

<p>類似地，修改<strong>intel-sata-powermgmt.conf</strong>，啟用sata硬盤接口的電源管理。由于我用Blueman控制藍牙設備，一般不用時都將其關閉，同時經常使用wifi，故藍牙和無線網卡均未作配置。</p>

<p>最後，关闭conky,Firefox和Chromium，<a href="http://www.lesswatts.org/projects/powertop/">powertop</a>显示conky是个很吵闹的东西，关掉它可以使<strong>Wakeups-from-idle per second</strong>的值下降很多，另外Chromium和Firefox也是耗电大户。</p>

<p><em>在此之前，系統空閑時CPU溫度一般是50多度，普通使用時一般在60多度，如果開了kvm虛擬機會達到60至90度間。經過以上設置，系统空闲时CPU温度一度下降到39度，即使開了虛擬機，一般也可維持在50到80度間。</em></p>

<p>另外，對于以上內容，我還有些沒搞明白的地方和要補充說明的東西：</p>

<ol>
<li>雖然將laptop-mode加入rc.conf且已隨系統啟動，但使用命令“<strong>cat /proc/sys/vm/laptop_mode</strong>”查詢得到的結果仍然是0，也就是說沒有自動啟用laptop-mode，必須使用命令“<strong>sudo /etc/rc.d/laptop-mode restart</strong>”手動重啟才行。目前沒有找到解決辦法。</li>
<li>雖然啟用laptop-mode接管聲卡電源管理，但沒找到查看是否生效的方法，于是在/etc/rc.local中加入命令“<strong>echo 1 &gt; /sys/module/snd<em>hda</em>intel/parameters/power_save</strong>”以強制聲卡節電。</li>
<li>Intel的powertop是個好東西，用它可以查看哪些進程最影響CPU節能。我們優化的標准之一就是使powertop中顯示的“Wakeups-from-idle per second”盡可能地減少。powertop的另一個特點就是通過自動檢查當前系統中電源使用的配置情況給出優化的建議，這是個很貼心的功能。</li>
</ol>

<p>鑒于目前存疑較多并將繼續嘗試，所以在標題中特別注明“不完全”三個字……</p>

<h3>參考</h3>

<ol>
<li>http://itgen.blogspot.com/2009/03/energy-management-in-linux.html</li>
<li>http://www.ibm.com/developerworks/cn/linux/l-cpufreq-1/index.html</li>
<li>http://www.lesswatts.org/</li>
</ol>
