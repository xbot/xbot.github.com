---
layout: post
title: 使用Vim寫博客
tags:
- Python
- Vim
- 博客
- 編程
status: publish
type: post
published: true
comments: true
meta:
  _edit_last: '1'
  views: '1263'
---
<p><a href="http://www.vim.org/scripts/script.php?script_id=3510">VimRepress</a>是Vim寫博客的插件中較新的一個，是久未更新的<a href="http://www.vim.org/scripts/script.php?script_id=1953">Vimpress</a>的一個衍生版。</p>

<p>雖然不是所有此類插件中功能最多的一個，但VimRepress非常實用，除包含最常用的幾個功能外，還支持<a href="http://daringfireball.net/projects/markdown/">Markdown</a>。但是當前版本的VimRepress在轉換Markdown格式的字符串到HTML時，是通過直接調用外部命令<strong>markdown</strong>來實現的，這顯然只是針對Linux（及其它類UNIX）系統設計的。</p>

<p>為了使VimRepress支持在Windows下使用Markdown寫文章，可以對它做一些改進。</p>

<p>修改VimRepress的源文件<strong>blog.vim</strong>，在<code>if __name__ == "__main__":</code>這一行的上方加入如下兩個函數：</p>

<p>
{% codeblock lang:python %}
def markdown_preview2():
    import sys
    reload(sys)
    sys.setdefaultencoding('utf-8')
    import markdown2 as mkd

    global vimpress_temp_dir
    if vimpress_temp_dir == '':
        vimpress_temp_dir = tempfile.mkdtemp(suffix="vimpress")
    temp_htm = os.path.join(vimpress_temp_dir, "vimpress_temp.htm")
    html_heads = \
"""<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
<head>
   <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
</head>
<body>
"""
    tmp_file = open(temp_htm, 'w')
    tmp_file.write(html_heads)
    txt = "\n".join(vim.current.buffer[:])
    #txt = unicode(txt,'cp936')
    tmp_file.write(mkd.markdown(txt))
    #tmp_file.write(mkd.markdown("\n".join(vim.current.buffer[:])))
    tmp_file.close()

    webbrowser.open("file://%s" % temp_htm)

def markdown_newpost2():
    import sys
    reload(sys)
    sys.setdefaultencoding('utf-8')
    import markdown2 as mkd

    global vimpress_temp_dir
    if vimpress_temp_dir == '':
        vimpress_temp_dir = tempfile.mkdtemp(suffix="vimpress")
    temp_htm = os.path.join(vimpress_temp_dir, "vimpress_post.htm")

    title = ""
    title_s = 0
    try:
        while title_s < 10:
            if vim.current.buffer[title_s].startswith("#"):
                title = vim.current.buffer[title_s].strip('#')
                break
            title_s += 1
    except IndexError:
        pass

    cur_file = vim.eval('expand("%:p")')
    if cur_file is None: 
        cur_file = os.path.join(vimpress_temp_dir, "tmp_vimpress.mkd")
        sys.stdout.write("\n\nCurrent buffer saved to %s\n\n" % cur_file)
    vim.command(":w! %s" % cur_file)
    tmp_file = open(temp_htm, 'w')
    tmp_file.write(mkd.markdown("\n".join(vim.current.buffer[:])))
    tmp_file.close()
    sys.stdout.write("Press ENTER to continue.")
    vim.command(":bdelete")
    vim.command(":r %s" % temp_htm)
    blog_new_post(title = title)
{% endcodeblock %}
</p>

<p>這兩個函數修改自原有的<strong>markdown<em>preview()</strong>和<strong>markdown</em>newpost()</strong>，由調用外部的<strong>markdown</strong>命令改為調用Python的<a href="http://code.google.com/p/python-markdown2/">markdown2</a>模塊來實現格式轉換。</p>

<p>然後，修改<strong>blog.vim</strong>中的命令映射，使VimRepress的<code>:MarkDownPreview</code>和<code>:MarkDownNewPost</code>命令在Windows下自動調用上述兩個函數：</p>

<p>
{% codeblock lang:vim %}
if has("win32")
    command! -nargs=0 MarkDownPreview exec('py markdown_preview2()')
    command! -nargs=0 MarkDownNewPost exec('py markdown_newpost2()')
else
    command! -nargs=0 MarkDownPreview exec('py markdown_preview()')
    command! -nargs=0 MarkDownNewPost exec('py markdown_newpost()')
endif
{% endcodeblock %}
</p>

<p>最後，只須安裝Python的markdown2模塊就可以用了。</p>

<p><strong>2011-03-23更新：</strong></p>

<p><a href="http://apt-blog.net/manage-multiple-wordpresses-with-new-vimpress">pentie</a>已合并這些功能到<a href="http://ptcoding.googlecode.com/svn/trunk/vimpress/">新版本</a>的VimRepress。</p>

<p><strong>2011-04-04更新：</strong></p>

<p>作為Markdown寫博的重度患者，我覺得Vim的其它相關插件都缺乏對Markdown源碼的有效管理，所以我幹脆寫了個新的插件<a href="http://0x3f.org/?p=1894">UltraBlog</a>。</p>
