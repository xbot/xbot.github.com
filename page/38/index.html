<!DOCTYPE html>
<html>
<head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="utf-8">
  
  <title>晴耕雨讀</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta property="og:type" content="website">
<meta property="og:title" content="晴耕雨讀">
<meta property="og:url" content="http://0x3f.org/page/38/index.html">
<meta property="og:site_name" content="晴耕雨讀">
<meta property="og:locale" content="zh-TW">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="晴耕雨讀">
  
  
    <link rel="icon" href="/favicon.png">
  
  <link href="/webfonts/ptserif/main.css" rel="stylesheet" type="text/css">
  <link href="/webfonts/source-code-pro/main.css" rel="stylesheet" type="text/css">
  <link rel="stylesheet" href="/css/style.css">
  
<!-- Google Analytics -->
<script type="text/javascript">
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-93233020-1', 'auto');
ga('send', 'pageview');

</script>
<!-- End Google Analytics -->


</head>
</html>
<body>
  <div id="container">
    <!-- blair add baidu tongji start... @2017.10.03 -->
<!-- blair add baidu tongji end ! @2017.10.03 -->

<header id="header">
  <div id="header-outer" class="outer">
    <div id="header-inner" class="inner">
      <a id="main-nav-toggle" class="nav-icon" href="javascript:;"></a>
      <a id="logo" class="logo" href="/"></a>
      <nav id="main-nav">
        
          <a class="main-nav-link" href="/archives">目录</a>
        
          <a class="main-nav-link" href="/categories">分类</a>
        
          <a class="main-nav-link" href="/tags">标签</a>
        
          <a class="main-nav-link" href="https://t.me/s/blingings">不灵</a>
        
          <a class="main-nav-link" href="/about">关于</a>
        
      </nav>
      <nav id="sub-nav">
        <div id="search-form-wrap">
          <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://0x3f.org"></form>
        </div>
      </nav>
    </div>
  </div>
</header>

    <br>
    <section id="main" class="outer">
      <article id="post-buuf-deuce-icon-theme" class="article article-type-post" itemscope="" itemprop="blogPost">
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <myh11 itemprop="name">
      <a class="article-title-index" href="/post/buuf-deuce-icon-theme/"><strong>Buuf-Deuce：搞怪的图标主题</strong></a>
      <small class="article-date-index">&nbsp; 2010-04-10</small>
      <!--<a>
      <div = post.date  </div>
      </a>-->
      <br>
      <br> <!-- blair add -->
    </myh11>
  


      </header>
    
    <div class="article-meta">
      <!--<a href="/post/buuf-deuce-icon-theme/" class="article-date">
  <time datetime="2010-04-09T16:00:00.000Z" itemprop="datePublished">2010-04-10</time>
</a>-->
      <!--
-->
      <!--
      
        <div class="article-comment-link-wrap">
          <a href="http://0x3f.org/post/buuf-deuce-icon-theme/#disqus_thread" class="article-comment-link">Comments</a>
        </div>
      
      -->
    </div>
	
    <div class="article-entry" itemprop="articleBody">
      
        <p>发现这个<a href="http://djany.deviantart.com/art/Gnome-Buuf-Deuce-1-1-R8-73339997" target="_blank" rel="noopener">图标主题</a>有段时间了，但直到今天偶然重新启用它，才突然觉得这套色调灰暗、风格搞怪的图标其实整体效果很好，很有个性，且极为闷骚，实为标榜非主流人士居家旅行必备。</p>
<p><a href="http://picasaweb.google.com/lh/photo/dGjc_mAUv2rQOLRDLlUZKw?feat=embedwebsite" target="_blank" rel="noopener"><img src="http://lh5.ggpht.com/_ceUJ_lBTHzc/S8CQfF_kpbI/AAAAAAAABZ8/UV3W7nTx3vA/s800/Gnome_Buuf_Deuce_1_1_R8_by_djany.jpg"></a></p>

      
    </div>
	
    <!--
	
    -->
    <!--
    
      <footer class="article-footer">
      </footer>
    
    -->
  </div>
  
</article>



    
      <article id="post-problem-about-icon-theme-on-gnome230" class="article article-type-post" itemscope="" itemprop="blogPost">
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <myh11 itemprop="name">
      <a class="article-title-index" href="/post/problem-about-icon-theme-on-gnome230/"><strong>Archlinux升级到GNOME2.30后的光标主题问题</strong></a>
      <small class="article-date-index">&nbsp; 2010-04-04</small>
      <!--<a>
      <div = post.date  </div>
      </a>-->
      <br>
      <br> <!-- blair add -->
    </myh11>
  


      </header>
    
    <div class="article-meta">
      <!--<a href="/post/problem-about-icon-theme-on-gnome230/" class="article-date">
  <time datetime="2010-04-03T16:00:00.000Z" itemprop="datePublished">2010-04-04</time>
</a>-->
      <!--
-->
      <!--
      
        <div class="article-comment-link-wrap">
          <a href="http://0x3f.org/post/problem-about-icon-theme-on-gnome230/#disqus_thread" class="article-comment-link">Comments</a>
        </div>
      
      -->
    </div>
	
    <div class="article-entry" itemprop="articleBody">
      
        <p>Archlinux下的GNOME升级到2.30后，若启用了Compiz，则光标主题只能使用X默认的主题，无法自定义。尚不清楚是GNOME新版本自身的问题还是仅限于Arch发行版。</p>

<p>在官方提供解决方案或更新之前，可以先使用Xdefault或Xresource文件实现。</p>

<p>以后者为例，编辑用户主目录下的<strong>.Xresource</strong>，在文件最后添加如下内容：</p>

<blockquote>
  <p>Xcursor.theme: faber-anthracite-shd-m</p>
</blockquote>

<p><strong>faber-anthracite-sdh-m</strong>是我使用的光标主题的文件夹名。</p>

<p>然后执行如下命令：</p>

<blockquote>
  <p>xrdb ~/.Xresource</p>
</blockquote>

<p>最后注销并重新登录即可。</p>

      
    </div>
	
    <!--
	
    -->
    <!--
    
      <footer class="article-footer">
      </footer>
    
    -->
  </div>
  
</article>



    
      <article id="post-phpsh" class="article article-type-post" itemscope="" itemprop="blogPost">
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <myh11 itemprop="name">
      <a class="article-title-index" href="/post/phpsh/"><strong>phpsh：PHP的交互式解释器</strong></a>
      <small class="article-date-index">&nbsp; 2010-03-29</small>
      <!--<a>
      <div = post.date  </div>
      </a>-->
      <br>
      <br> <!-- blair add -->
    </myh11>
  


      </header>
    
    <div class="article-meta">
      <!--<a href="/post/phpsh/" class="article-date">
  <time datetime="2010-03-28T16:00:00.000Z" itemprop="datePublished">2010-03-29</time>
</a>-->
      <!--
-->
      <!--
      
        <div class="article-comment-link-wrap">
          <a href="http://0x3f.org/post/phpsh/#disqus_thread" class="article-comment-link">Comments</a>
        </div>
      
      -->
    </div>
	
    <div class="article-entry" itemprop="articleBody">
      
        <p>时常需要测试一些简短的代码是否能得到需要的结果，如果去写测试脚本再执行，显然太麻烦。虽然PHP自身也支持通过<strong><em>-a</em></strong>参数启动交互模式，但功能较为局限。如果PHP有像<a href="http://bpython-interpreter.org/" target="_blank" rel="noopener">bpython</a>那样的交互式解释器，就太好了。</p>

<p><a href="http://www.phpsh.org/" target="_blank" rel="noopener">phpsh</a>就是这样一个工具，它是由<a href="http://zh.wikipedia.org/wiki/Facebook" target="_blank" rel="noopener">facebook</a>的开发者用Python实现的PHP的交互式解释器，并具备以下特性：</p>

<ol>
<li>命令行历史回溯</li>
<li>tab键自动补全</li>
<li>快速文档索引</li>
</ol>

      
    </div>
	
    <!--
	
    -->
    <!--
    
      <footer class="article-footer">
      </footer>
    
    -->
  </div>
  
</article>



    
      <article id="post-cx-freeze" class="article article-type-post" itemscope="" itemprop="blogPost">
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <myh11 itemprop="name">
      <a class="article-title-index" href="/post/cx-freeze/"><strong>使用cx_Freeze的distutils脚本打包Python程序</strong></a>
      <small class="article-date-index">&nbsp; 2010-03-26</small>
      <!--<a>
      <div = post.date  </div>
      </a>-->
      <br>
      <br> <!-- blair add -->
    </myh11>
  


      </header>
    
    <div class="article-meta">
      <!--<a href="/post/cx-freeze/" class="article-date">
  <time datetime="2010-03-25T16:00:00.000Z" itemprop="datePublished">2010-03-26</time>
</a>-->
      <!--
-->
      <!--
      
        <div class="article-comment-link-wrap">
          <a href="http://0x3f.org/post/cx-freeze/#disqus_thread" class="article-comment-link">Comments</a>
        </div>
      
      -->
    </div>
	
    <div class="article-entry" itemprop="articleBody">
      
        <p>cx_Freeze打包Python程序的命令基本格式如下：</p>

<p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cxfreeze main.py --target-dir appdir</span><br></pre></td></tr></table></figure>
</p>

<p>它表示把脚本main.py或以main.py为程序入口的程序打包并导出到当前路径中名为<strong>appdir</strong>的目录中。</p>

<p>对于Windows下的GUI应用程序，以上面的命令导出后，运行时会弹出<strong>cmd</strong>命令行的黑窗口，须加上如下命令中的参数：</p>

<p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cxfreeze main.py --target-dir appdir --base-name=win32gui</span><br></pre></td></tr></table></figure>
</p>

<p>对于比较复杂的程序，cx_Freeze支持<a href="http://www.ibm.com/developerworks/cn/linux/sdk/python/charm-19/" target="_blank" rel="noopener">distutils</a>格式的打包脚本，当然，彼此之间在引入的模块和支持的参数上还是有差别的。</p>

<p>cx_Freeze的文档中有其支持的全部命令参数及说明，写到setup.py脚本中时，所有参数中的<strong>-</strong>符号应换成下划线。</p>

<p>我的setup.py内容大致如下：</p>

<p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/python</span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="keyword">from</span> cx_Freeze <span class="keyword">import</span> setup,Executable</span><br><span class="line"></span><br><span class="line">includefiles = [(<span class="string">'settings.ini.jctest'</span>,<span class="string">'settings.ini'</span>)</span><br><span class="line">        ,<span class="string">'README.mkd'</span>]</span><br><span class="line">includes = []</span><br><span class="line">excludes = [<span class="string">'Tkinter'</span>]</span><br><span class="line">packages = [<span class="string">'sqlalchemy.engine'</span>, <span class="string">'sqlalchemy.orm'</span>, <span class="string">'sqlalchemy.dialects.mssql'</span>]</span><br><span class="line"></span><br><span class="line">setup(</span><br><span class="line">    name = <span class="string">'pyutil'</span>,</span><br><span class="line">    version = <span class="string">'0.1'</span>,</span><br><span class="line">    description = <span class="string">'A general enhancement utility for XXX'</span>,</span><br><span class="line">    author = <span class="string">'Lenin Lee'</span>,</span><br><span class="line">    author_email = <span class="string">'lenin.lee@xxx.com'</span>,</span><br><span class="line">    options = &#123;<span class="string">'build_exe'</span>:&#123;<span class="string">'excludes'</span>:excludes,<span class="string">'packages'</span>:packages,<span class="string">'include_files'</span>:includefiles&#125;&#125;,</span><br><span class="line">    executables = [Executable(<span class="string">'jcitk.py'</span>)</span><br><span class="line">        , Executable(<span class="string">'jcvfd.py'</span>)</span><br><span class="line">        , Executable(<span class="string">'jcvdupcr.py'</span>)</span><br><span class="line">        , Executable(<span class="string">'jcddupcr.py'</span>)</span><br><span class="line">        , Executable(<span class="string">'jcclostfd.py'</span>)</span><br><span class="line">        , Executable(<span class="string">'jcvcard.py'</span>)</span><br><span class="line">        , Executable(<span class="string">'jcvcardii.py'</span>)</span><br><span class="line">        , Executable(<span class="string">'jcclostsoid.py'</span>)]</span><br><span class="line">)</span><br></pre></td></tr></table></figure>
</p>

<p>在摸索如何写setup.py的过程中，遇到一些问题。</p>

<p>首先是如何将配置文件<strong>settings.ini</strong>自动复制到打包文件夹中。这个问题的解决办法是使用build_exe命令的参数<strong>include_files</strong>。此参数的值是一个列表，列表的每一项可以是一个表示要复制的文件的路径的字符串，或者是一个tuple。若是tuple，第一个元素是表示要复制的文件的路径，第二个元素是表示复制后要修改成的文件名。需要说明的是，文件夹可以和文件一样使用这样的方法复制到打包文件夹中。</p>

<p>其次，在打包引入了SQLAlchemy的程序后，若运行该程序时报某模块导入失败的错，应将报错信息中提示的模块所在的包填写到<strong>packages</strong>参数中。虽然也可以在程序中import这些包，但是在setup.py中使用packages参数的做法更合理。而且如果在程序中导入了没有被显式调用的模块或包的话，对于使用<a href="http://swik.net/PyFlakes" target="_blank" rel="noopener">pyflakes</a>检查语法错误的<a href="http://www.vim.org/scripts/script.php?script_id=2441" target="_blank" rel="noopener">环境</a>，会显示模块或包未被调用的警告，至少看起来不舒服。</p>

<p>再次，Windows下打包时应使用python 2.5，因为2.6版本需要<a href="http://www.microsoft.com/downloads/details.aspx?familyid=9B2DA534-3E03-4391-8A4D-074B9F2BC1BF&amp;displaylang=zh-cn" target="_blank" rel="noopener">Microsoft Visual C++ 2008 Redistributable</a>，一般非开发环境的系统中都没安装这个，运行程序时就会报错。</p>

      
    </div>
	
    <!--
	
    -->
    <!--
    
      <footer class="article-footer">
      </footer>
    
    -->
  </div>
  
</article>



    
      <article id="post-starting-tea-ceremony" class="article article-type-post" itemscope="" itemprop="blogPost">
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <myh11 itemprop="name">
      <a class="article-title-index" href="/post/starting-tea-ceremony/"><strong>开始玩儿茶道</strong></a>
      <small class="article-date-index">&nbsp; 2010-03-20</small>
      <!--<a>
      <div = post.date  </div>
      </a>-->
      <br>
      <br> <!-- blair add -->
    </myh11>
  


      </header>
    
    <div class="article-meta">
      <!--<a href="/post/starting-tea-ceremony/" class="article-date">
  <time datetime="2010-03-19T16:00:00.000Z" itemprop="datePublished">2010-03-20</time>
</a>-->
      <!--
-->
      <!--
      
        <div class="article-comment-link-wrap">
          <a href="http://0x3f.org/post/starting-tea-ceremony/#disqus_thread" class="article-comment-link">Comments</a>
        </div>
      
      -->
    </div>
	
    <div class="article-entry" itemprop="articleBody">
      
        <p>前年买了个倒把小西施开始喝茶，渐渐地就觉得喝茶的趣味一半在茶，一半在泡。这周买了茶盘、茶道组等一应物件儿，直到周五晚上才有时间过把瘾。怕睡不着觉，没敢泡生茶，新开了一饼易武大树熟茶。</p>
<p><a href="http://picasaweb.google.com/lh/photo/2OI8UYBIqMUejiDCtL3JKg?feat=embedwebsite" target="_blank" rel="noopener"><img src="http://lh6.ggpht.com/_ceUJ_lBTHzc/S6OqNZV5xgI/AAAAAAAABVg/nipIKJWV6xk/s400/%E8%8C%B6%E9%81%93%20002.JPG"></a></p>

      
    </div>
	
    <!--
	
    -->
    <!--
    
      <footer class="article-footer">
      </footer>
    
    -->
  </div>
  
</article>



    
      <article id="post-counting-days-between-dates-in-sqlserver" class="article article-type-post" itemscope="" itemprop="blogPost">
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <myh11 itemprop="name">
      <a class="article-title-index" href="/post/counting-days-between-dates-in-sqlserver/"><strong>SQL Server的自定义函数：统计两日期之间工作日的数量</strong></a>
      <small class="article-date-index">&nbsp; 2010-03-13</small>
      <!--<a>
      <div = post.date  </div>
      </a>-->
      <br>
      <br> <!-- blair add -->
    </myh11>
  


      </header>
    
    <div class="article-meta">
      <!--<a href="/post/counting-days-between-dates-in-sqlserver/" class="article-date">
  <time datetime="2010-03-12T16:00:00.000Z" itemprop="datePublished">2010-03-13</time>
</a>-->
      <!--
-->
      <!--
      
        <div class="article-comment-link-wrap">
          <a href="http://0x3f.org/post/counting-days-between-dates-in-sqlserver/#disqus_thread" class="article-comment-link">Comments</a>
        </div>
      
      -->
    </div>
	
    <div class="article-entry" itemprop="articleBody">
      
        <p>前段时间工作中遇到的一个需求，要求计算两个日期之间工作日的数量，即排除期间所有的周六和周日之后的天数。</p>

<p>在网上找到一个自定义函数，原函数有些小问题，例如如果传入的截止日期如果有时间且足够大，则计算结果可能出错，修正后代码如下：</p>

<p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">--函数：类似datediff，不统计期间所有的周六和周日</span></span><br><span class="line">if exists (<span class="keyword">select</span> * <span class="keyword">from</span> dbo.sysobjects <span class="keyword">where</span> <span class="keyword">id</span>=object_id(N<span class="string">'[dbo].[f_WorkDay]'</span>) <span class="keyword">and</span> xtype <span class="keyword">in</span> (N<span class="string">'FN'</span>,N<span class="string">'IF'</span>,N<span class="string">'TF'</span>)) </span><br><span class="line"><span class="keyword">drop</span> <span class="keyword">function</span> [dbo].[f_WorkDay] </span><br><span class="line"><span class="keyword">GO</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">FUNCTION</span> f_WorkDay(</span><br><span class="line">@dt_begin   datetime,</span><br><span class="line">@dt_end     datetime </span><br><span class="line">)<span class="keyword">RETURNS</span> <span class="built_in">int</span> </span><br><span class="line"><span class="keyword">AS</span> </span><br><span class="line"><span class="keyword">BEGIN</span> </span><br><span class="line">    <span class="keyword">DECLARE</span> @workday <span class="built_in">int</span>,@i <span class="built_in">int</span>,@bz <span class="built_in">bit</span>,@dt datetime </span><br><span class="line"></span><br><span class="line">    <span class="keyword">set</span> @dt_begin = <span class="keyword">convert</span>(datetime, <span class="keyword">convert</span>(<span class="keyword">nvarchar</span>(<span class="number">32</span>), @dt_begin, <span class="number">23</span>))</span><br><span class="line">    <span class="keyword">set</span> @dt_end = <span class="keyword">convert</span>(datetime, <span class="keyword">convert</span>(<span class="keyword">nvarchar</span>(<span class="number">32</span>), @dt_end, <span class="number">23</span>))    </span><br><span class="line"></span><br><span class="line">    <span class="keyword">IF</span> @dt_begin&gt;@dt_end </span><br><span class="line">        <span class="keyword">SELECT</span> @bz=<span class="number">1</span>,@dt=@dt_begin,@dt_begin=@dt_end,@dt_end=@dt </span><br><span class="line">    <span class="keyword">ELSE</span> </span><br><span class="line">        <span class="keyword">SET</span> @bz=<span class="number">0</span> </span><br><span class="line"></span><br><span class="line">    <span class="keyword">SELECT</span> @i=<span class="keyword">DATEDIFF</span>(<span class="keyword">Day</span>,@dt_begin,@dt_end),@workday=@i/<span class="number">7</span>*<span class="number">5</span>,@dt_begin=<span class="keyword">DATEADD</span>(<span class="keyword">Day</span>,@i/<span class="number">7</span>*<span class="number">7</span>,@dt_begin) </span><br><span class="line"></span><br><span class="line">    <span class="keyword">WHILE</span> @dt_begin&lt;@dt_end </span><br><span class="line">    <span class="keyword">BEGIN</span> </span><br><span class="line">        <span class="keyword">SELECT</span> @workday=<span class="keyword">CASE</span> <span class="keyword">WHEN</span> (@@DATEFIRST+<span class="keyword">DATEPART</span>(<span class="keyword">Weekday</span>,@dt_begin)<span class="number">-1</span>)%<span class="number">7</span> <span class="keyword">BETWEEN</span> <span class="number">1</span> <span class="keyword">AND</span> <span class="number">5</span> <span class="keyword">THEN</span> @workday+<span class="number">1</span> <span class="keyword">ELSE</span> @workday <span class="keyword">END</span>,@dt_begin=@dt_begin+<span class="number">1</span> </span><br><span class="line">    <span class="keyword">END</span> </span><br><span class="line"></span><br><span class="line">    <span class="keyword">RETURN</span>(<span class="keyword">CASE</span> <span class="keyword">WHEN</span> @bz=<span class="number">1</span> <span class="keyword">THEN</span> -@workday <span class="keyword">ELSE</span> @workday <span class="keyword">END</span>) </span><br><span class="line"><span class="keyword">END</span> </span><br><span class="line"><span class="keyword">GO</span></span><br></pre></td></tr></table></figure>
</p>

<p>此函数的原理是，使用datediff计算两日期之间的差值A，然后取A与7的商，即计算期间内有几个整周。然后使用这个商与5相乘，得到所有整周内的工作日天数B。接着，使用A除以7再乘以7得到C，这就约去了A中最后不到一个整周的天数。再在起始日期的基础上加上C，得到一个新的起始日期，然后从这个新的起始日期开始遍历至截止日期的每一天，每增加一天，判断若此日期是工作日，则在C的基础上累加一。判断一个日期（假设使用@dt_begin表示）是否是工作日的方法是：<strong>(@@datefirst+datepart(Weekday, @dt_begin)-1)%7</strong>的值在1和5之间。</p>

<p>此外还有一个需求是计算两个日期之间排除最后一个周六周日后的天数，仿照上面的函数实现了一个新函数，现在想来，有点儿把问题复杂化了，完全可以直接从后往前推的。</p>

<p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">--函数：类似datediff，不统计截止日期@dt_end前最近一次的周六和周日，若dt_end是周日，则不统计其前面的那个周六。</span></span><br><span class="line">if exists (<span class="keyword">select</span> * <span class="keyword">from</span> dbo.sysobjects <span class="keyword">where</span> <span class="keyword">id</span>=object_id(N<span class="string">'[dbo].[f_WorkDayOnce]'</span>) <span class="keyword">and</span> xtype <span class="keyword">in</span> (N<span class="string">'FN'</span>,N<span class="string">'IF'</span>,N<span class="string">'TF'</span>)) </span><br><span class="line"><span class="keyword">drop</span> <span class="keyword">function</span> [dbo].[f_WorkDayOnce]</span><br><span class="line"><span class="keyword">GO</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">FUNCTION</span> f_WorkDayOnce(</span><br><span class="line">@dt_begin   datetime,</span><br><span class="line">@dt_end     datetime </span><br><span class="line">)<span class="keyword">RETURNS</span> <span class="built_in">int</span> </span><br><span class="line"><span class="keyword">AS</span> </span><br><span class="line"><span class="keyword">BEGIN</span> </span><br><span class="line">    <span class="keyword">DECLARE</span> @day_count <span class="built_in">int</span>,@<span class="keyword">weekday</span> <span class="built_in">int</span>,@weekend_dropped <span class="built_in">int</span>,@i <span class="built_in">int</span>,@bz <span class="built_in">bit</span>,@dt datetime </span><br><span class="line"></span><br><span class="line">    <span class="keyword">set</span> @dt_begin = <span class="keyword">convert</span>(datetime, <span class="keyword">convert</span>(<span class="keyword">nvarchar</span>(<span class="number">32</span>), @dt_begin, <span class="number">23</span>))</span><br><span class="line">    <span class="keyword">set</span> @dt_end = <span class="keyword">convert</span>(datetime, <span class="keyword">convert</span>(<span class="keyword">nvarchar</span>(<span class="number">32</span>), @dt_end, <span class="number">23</span>))    </span><br><span class="line"></span><br><span class="line">    <span class="keyword">IF</span> @dt_begin&gt;@dt_end </span><br><span class="line">        <span class="keyword">SELECT</span> @bz=<span class="number">1</span>,@dt=@dt_begin,@dt_begin=@dt_end,@dt_end=@dt </span><br><span class="line">    <span class="keyword">ELSE</span> </span><br><span class="line">        <span class="keyword">SET</span> @bz=<span class="number">0</span> </span><br><span class="line"></span><br><span class="line">    <span class="keyword">SELECT</span> @i=<span class="keyword">DATEDIFF</span>(<span class="keyword">Day</span>,@dt_begin,@dt_end),@<span class="keyword">weekday</span>=(@@datefirst+<span class="keyword">datepart</span>(<span class="keyword">weekday</span>,@dt_end)<span class="number">-1</span>)%<span class="number">7</span>,@day_count=@i,@weekend_dropped=<span class="number">0</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> @i=<span class="number">0</span></span><br><span class="line">        <span class="keyword">set</span> @day_count=<span class="number">0</span></span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    <span class="keyword">begin</span></span><br><span class="line">        <span class="keyword">if</span> @<span class="keyword">weekday</span>=<span class="number">0</span></span><br><span class="line">            <span class="keyword">set</span> @day_count=@i<span class="number">-1</span></span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        <span class="keyword">begin</span></span><br><span class="line">            <span class="keyword">while</span> @dt_begin&lt;@dt_end <span class="keyword">and</span> @weekend_dropped&lt;<span class="number">2</span></span><br><span class="line">            <span class="keyword">begin</span></span><br><span class="line">                <span class="keyword">select</span> @weekend_dropped=@weekend_dropped+(<span class="keyword">case</span> <span class="keyword">when</span> (@@datefirst+<span class="keyword">datepart</span>(<span class="keyword">weekday</span>,@dt_begin)<span class="number">-1</span>)%<span class="number">7</span> <span class="keyword">between</span> <span class="number">1</span> <span class="keyword">and</span> <span class="number">5</span> <span class="keyword">then</span> <span class="number">0</span> <span class="keyword">else</span> <span class="number">1</span> <span class="keyword">end</span>),@dt_begin=@dt_begin+<span class="number">1</span></span><br><span class="line">            <span class="keyword">end</span></span><br><span class="line">            <span class="keyword">select</span> @day_count=@day_count-@weekend_dropped</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">RETURN</span>(<span class="keyword">CASE</span> <span class="keyword">WHEN</span> @bz=<span class="number">1</span> <span class="keyword">THEN</span> -@day_count <span class="keyword">ELSE</span> @day_count <span class="keyword">END</span>) </span><br><span class="line"><span class="keyword">END</span> </span><br><span class="line"><span class="keyword">GO</span></span><br></pre></td></tr></table></figure>
</p>

      
    </div>
	
    <!--
	
    -->
    <!--
    
      <footer class="article-footer">
      </footer>
    
    -->
  </div>
  
</article>



    
      <article id="post-supernatural-phenomenon-of-controlling-external-processes-in-python" class="article article-type-post" itemscope="" itemprop="blogPost">
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <myh11 itemprop="name">
      <a class="article-title-index" href="/post/supernatural-phenomenon-of-controlling-external-processes-in-python/"><strong>Python控制外部进程的灵异事件</strong></a>
      <small class="article-date-index">&nbsp; 2010-03-08</small>
      <!--<a>
      <div = post.date  </div>
      </a>-->
      <br>
      <br> <!-- blair add -->
    </myh11>
  


      </header>
    
    <div class="article-meta">
      <!--<a href="/post/supernatural-phenomenon-of-controlling-external-processes-in-python/" class="article-date">
  <time datetime="2010-03-07T16:00:00.000Z" itemprop="datePublished">2010-03-08</time>
</a>-->
      <!--
-->
      <!--
      
        <div class="article-comment-link-wrap">
          <a href="http://0x3f.org/post/supernatural-phenomenon-of-controlling-external-processes-in-python/#disqus_thread" class="article-comment-link">Comments</a>
        </div>
      
      -->
    </div>
	
    <div class="article-entry" itemprop="articleBody">
      
        <p>春节前的一段时间，重新拾起近一年没动过的<a href="http://0x3f.org/?tag=foreverfantasy">ForeverFantasy</a>。</p>

<p>虽然一年内没什么更新，但是我却一直都在用，基本上只限于将用Vim写好的<a href="http://en.wikipedia.org/wiki/Markdown" target="_blank" rel="noopener">Markdown</a>格式的文档转换成HTML。</p>

<p>重写了相当一部分代码，较大程度地改变了界面布局，突然发现经过一年的沉淀，对<a href="http://en.wikipedia.org/wiki/WxPython" target="_blank" rel="noopener">wxPython</a>的理解增进了不少，开发起来比起去年这个时候清楚了很多。</p>

<p><a href="http://picasaweb.google.com/lh/photo/bNRGQr0g6aLuqDUm8EQ6mg?feat=embedwebsite" target="_blank" rel="noopener"><img src="http://lh6.ggpht.com/_ceUJ_lBTHzc/S5UYPQmTAzI/AAAAAAAABUc/znMRxXuE8dE/s400/2010-03-08.23%3A27%3A03.%E5%B7%A5%E4%BD%9C%E5%8C%BA%201.01.png"></a></p>

<p>这些天来一直坚持着每天或多或少的做一些，如果说有什么主要的进展的话，那就是界面的重构，以及昨天实现了调用Vim编辑文档并回收文档内容的功能。</p>

<p>ForeverFantasy和Vim协同的一个最大的问题就是如何判断Vim已经退出。Python调用外部程序的方法有很多，比如传统的<a href="http://docs.python.org/library/commands.html" target="_blank" rel="noopener">commands</a>模块、<a href="http://docs.python.org/library/os.html" target="_blank" rel="noopener">os</a>.system()等，<a href="http://docs.python.org/library/subprocess.html" target="_blank" rel="noopener">subprocess</a>是致力于替代这些旧有的方式的一个模块，它的一个特点是可以在启动一个外部程序作为子进程后还能监控这个进程的运行状态。这为ForeverFantasy在Vim退出后回收文档内容提供了更简捷的途径。</p>

<p>下面的代码可以说明如何使用subprocess运行外部程序并监控运行状态：</p>

<p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> subprocess</span><br><span class="line">process = subprocess.Popen(<span class="string">'gvim'</span>, shell=<span class="keyword">True</span>)</span><br><span class="line">status = process.poll()</span><br><span class="line"><span class="keyword">if</span> <span class="number">0</span> == status:</span><br><span class="line">    <span class="keyword">print</span> <span class="string">'The external program exited.'</span></span><br><span class="line"><span class="keyword">if</span> status <span class="keyword">is</span> <span class="keyword">None</span>:</span><br><span class="line">    <span class="keyword">print</span> <span class="string">'The external program is still running.'</span></span><br></pre></td></tr></table></figure>
</p>

<p>理论上，可以拿实例process的poll()方法监视进程的运行状态，而且这一点在Windows上也确实可以做到，但是到了Linux下，诡异的事出现了，即使刚刚打开gvim，poll()方法也会马上返回一个0，同时process.pid的值总是和实际在运行的那个gvim进程的pid的值差3，而且在虚拟终端中输入gvim命令也不会阻塞终端，就像别的命令加上“<strong>&amp;</strong>”符号的效果一样。尝试用<a href="http://en.wikipedia.org/wiki/Strace" target="_blank" rel="noopener">strace</a>跟踪gvim的运行，试图找到问题原因，无果。我猜想可能/usr/bin/gvim是一个跳板，它启动后会启动一个新的gvim进程。总之，这个方法在Linux下是行不通的。</p>

<p>因此我觉得只能另寻出路了，既然不能监控gvim进程，那就监控gvim进程所编辑的文件，只要这个文件不被任何进程占用，就可以判定gvim已退出。这一点，在Linux下易如反掌，不用说，<a href="http://en.wikipedia.org/wiki/Lsof" target="_blank" rel="noopener">lsof</a>当仁不让。</p>

<p>用<strong>commands.getstatusoutput('lsof file.txt')</strong>测试发现，如果文件file.txt被某进程占用，则返回的状态值为0，反之，返回256。</p>

<p>最终，我在程序中使用了两种判断方式，在Windows平台使用subprocess跟踪gvim.exe进程，而在Linux及Unix平台使用lsof检查文档占用情况。</p>

<p>剩下的就是进行这个判断的时间问题了。</p>

<p>很显然，如果在子进程被启动后马上使用while循环不停的检查，一来必须使用多线程，二来系统资源占用也会很高。这时就需要利用wxPython的事件机制了，当ForeverFantasy启动Gvim时，主窗口失去焦点，而当Gvim退出时，ForeverFantasy又会获得焦点，只要能在ForeverFantasy窗口获得焦点时做一次检查即可。不过，在选择最合适的事件的问题上，又是一波三折。</p>

<p>在wxPython的<a href="http://www.wxpython.org/docs/api/frames.html" target="_blank" rel="noopener">API</a>文档中没有找到<a href="http://wiki.wxpython.org/ListOfEvents" target="_blank" rel="noopener">事件列表</a>，倒是在<a href="http://wiki.wxpython.org" target="_blank" rel="noopener">Wiki</a>中找到了。顾名思义，觉得wx.EVT_SET_FOCUS比较靠谱，但试用失败，看API中关于FocusEvent的说明，这个事件适用于窗口控件；然后又试了wx.EVT_CHILD_FOCUS，只有在窗口包含的控件中有获得焦点的情况才会触发；最后才发现<strong>wx.EVT_ACTIVATE</strong>，这个事件会在窗口失去焦点和获得焦点时各触发一次，使用GetActive()方法可以判断是获得焦点还是失去焦点。</p>

<p>完成与Vim的协同使ForeverFantasy在我手上由原来单纯的格式转换工具进化为基本可用的文档编辑器，就算是<strong>Milestone 2</strong>吧。</p>

<p>此外，还有一些小的经验：</p>

<p>1. 调用非环境变量下的程序，即命令中必须带程序所在的路径时，应当将程序所在目录的完整路径以自然字符串的形式传递给subprocess.Popen类的构造方法的cwd参数，即如下所示：</p>

<p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">process = subprocess.Popen(<span class="string">'gvim.exe'</span>, cwd=<span class="string">r'C:\program files\vim\vim72'</span>, shell=<span class="keyword">True</span>)</span><br></pre></td></tr></table></figure>
</p>

<p>这样可以有效避免路径中的空格和特殊字符对命令执行的影响。</p>

<p>2. Vim编辑一个文档时，实际操作的是一个临时文件，而不是原文件，这个临时文件与原文件同路径，名称为在原文件名的基础上，前面加一个句点，后面加后缀“.swp”。应该用lsof监控这个临时文件，才可以判断出编辑该文档的Vim进程的运行状态。由于对于不存在的文件使用lsof命令的返回值也是256，故可以同时判断临时文件和原文件的占用情况，这样就为对其它编辑器的支持奠定了基础。</p>

<p><strong>2010-03-10 Wednesday 22:52:13 更新</strong></p>

<p>感谢KL童鞋和依云童鞋指教，果然加上<strong>-f</strong>参数就可以了。</p>

      
    </div>
	
    <!--
	
    -->
    <!--
    
      <footer class="article-footer">
      </footer>
    
    -->
  </div>
  
</article>



    
      <article id="post-neocomplcache-vim" class="article article-type-post" itemscope="" itemprop="blogPost">
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <myh11 itemprop="name">
      <a class="article-title-index" href="/post/neocomplcache-vim/"><strong>Vim的终极自动补全插件：NeoComplCache</strong></a>
      <small class="article-date-index">&nbsp; 2010-02-27</small>
      <!--<a>
      <div = post.date  </div>
      </a>-->
      <br>
      <br> <!-- blair add -->
    </myh11>
  


      </header>
    
    <div class="article-meta">
      <!--<a href="/post/neocomplcache-vim/" class="article-date">
  <time datetime="2010-02-26T16:00:00.000Z" itemprop="datePublished">2010-02-27</time>
</a>-->
      <!--
  <div class="article-category-index">
    <a class="article-category-index-link" href="/categories/计算机/">计算机</a>
  </div>

-->
      <!--
      
        <div class="article-comment-link-wrap">
          <a href="http://0x3f.org/post/neocomplcache-vim/#disqus_thread" class="article-comment-link">Comments</a>
        </div>
      
      -->
    </div>
	
    <div class="article-entry" itemprop="articleBody">
      
        <img src="http://lh3.ggpht.com/_ceUJ_lBTHzc/SaV494hGreI/AAAAAAAAAzY/xExf7CzGyv0/s800/the-mug-of-vi.jpg">
<p>关于自动补全，最初用的是<a href="http://www.vim.org/scripts/script.php?script_id=1643" target="_blank" rel="noopener">SuperTab</a>，那个时候Vim的自动补全插件寥寥无几，也就SuperTab比较有名。不过实际使用过程中这个插件给我的体验不是很好，原因是补全的准确度不高。</p>

<p>后来出了一个新插件，<a href="http://www.vim.org/scripts/script.php?script_id=1879" target="_blank" rel="noopener">AutoComplPop</a>，功能和使用都很简单。但是很快我就又用回SuperTab，原因是AutoComplPop在输入的同时实时地查询匹配的关键词，导致输入极不流畅，效率很低。</p>

<p>一直就这么凑合着用着SuperTab，随着这个插件版本的更新，旧功能不断地完善，新功能也接二连三地引入，SuperTab在匹配关键词的准确度上有了一些改善，但是新的问题又出现了。SuperTab后来加入一个新功能，对于程序源文件，可以在其引入的文件以及API文件中匹配关键词。比如假设我当前正在编辑a.php，在a.php中有<strong>include ‘b.php’;</strong>这样的语句，当我输入<strong>array</strong>并按下Tab键时，SuperTab不但会在当前文件中查询所有匹配项，还会到b.php中查询，如果配置过vim、指定一个包含了php的API的文件，则SuperTab还会自动从这个文件中查询匹配项。按理说这个功能的理念很好，但问题就在于SuperTab做的是实时查询，如果源文件中包含的文件较多，各个文件又较大，问题就显而易见了。我不得不在写程序时小心地使用Tab键，否则有时就会出现按一下Tab键然后等着Vim在那狂搜的情况。</p>

<p>前两天发现了<a href="http://www.vim.org/scripts/script.php?script_id=2620" target="_blank" rel="noopener">NeoComplCache</a>，光看名字就让我有点儿兴奋，一般使用缓存的速度都很快。这个插件会在Vim打开文件的时候对上下文作一个索引，并把索引结果保存到缓存中。同时，文件更改的内容会在保存的时候被索引。此外，NeoComplCache支持多种关键词索引模式，例如它会判断当前路径下的文件或目录的名字是否匹配补全条件，也可以从缓存的程序语言API中匹配补全条件。到此为止，它就解决了SuperTab和AutoComplPop共同的效率问题，并具备它们各自的长处。看了一遍文档，发现这个插件的功能比较细致，大概有以下一些特点：</p>

<p>1、使用缓存，自动补全时效率高；<br>2、生成的关键词列表准确；<br>3、支持下划线分割的关键词，如apple_boy_cat，就可以只输入a_b_c，然后补全；<br>4、支持驼峰格式匹配关键词，如AppleBoyCat，就可以只输入ABC，然后补全；<br>5、既可以像AutoComplPop那样在Vim中输入的同时自动弹出补全列表，又可以自定义快捷键手动触发；<br>6、支持从文件名和目录名中匹配补全条件；<br>7、对于程序源文件，支持从语言API中匹配补全条件；</p>

<p>NeoComplCache的缺点是文档不全，虽然从只言片语中发现它还支持Snippet，但从文档中没有找到足够的有用信息。加之一直用<a href="http://www.vim.org/scripts/script.php?script_id=2540" target="_blank" rel="noopener">SnipMate</a>感觉不错，所以目前还是用它来实现snippet功能。</p>

<p>这就有个搭配问题：虽然NeoComplCache不存在补全时的效率问题，但我仍然打算只在需要补全时才用快捷键触发此功能，最主要的原因是我既希望用Tab键触发SnipMate的代码块补全功能，又希望修SuperTab那样用Tab选择补全列表中的选项。也就是要达到只用Tab键就可以完成打开自动补全列表、补全列表选项选择和SnipMate代码块替换的效果。但是，如果将Tab映射到触发自动补全，则补全列表选择和SnipMate均无法使用Tab，反之亦然。</p>

<p>所以我想如果能让NeoComplCache、SuperTab、SnipMate和谐共存，那问题就解决了，几经摸索，终于找到了办法：</p>

<p>1、设置NeoComplCache不自动弹出补全列表，即在vimrc中加入：</p>

<blockquote><br>  <p>let g:NeoComplCache_DisableAutoComplete = 1</p><br></blockquote>

<p>2、由于NeoComplCache在手工模式下使用快捷键组合<code>&lt;C-X&gt;&lt;C-U&gt;</code>打开补全列表，故设置SuperTab的默认补全操作为<code>&lt;C-X&gt;&lt;C-U&gt;</code>，即在vimrc中加入：</p>

<blockquote><br>  <p>let g:SuperTabDefaultCompletionType = ‘<code>&lt;C-X&gt;&lt;C-U&gt;</code>‘</p><br></blockquote>

<p>这样，NeoComplCache只负责补全关键词缓存的生成，SuperTab控制Tab键的行为并在需要触发补全操作时打开补全列表、进而在列表中的选项间移动焦点，而当光标前的关键词是snippet时，SnipMate会被优先调用并完成代码块的替换。</p>

<p>就在写这篇文章的时候，我突然觉得NeoComplCache自动弹出补全列表+SnipMate的方式也挺好，只是这样就不能用Tab键选择列表中的选项了。</p>

<h3 id="相关阅读："><a href="#相关阅读：" class="headerlink" title="相关阅读："></a>相关阅读：</h3><ul>
<li><a href="/post/replace-youcompleteme-with-neocomplete/">用neocomplete换掉了YouCompleteMe</a></li>
<li><a href="/post/make-youcompleteme-ultisnips-compatible/">How to Make YouCompleteMe Compatible with UltiSnips</a></li>
</ul>

      
    </div>
	
    <!--
	
    -->
    <!--
    
      <footer class="article-footer">
      </footer>
    
    -->
  </div>
  
</article>



    
      <article id="post-chinese-problem-of-sqlalchemy-with-sqlserver" class="article article-type-post" itemscope="" itemprop="blogPost">
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <myh11 itemprop="name">
      <a class="article-title-index" href="/post/chinese-problem-of-sqlalchemy-with-sqlserver/"><strong>SQLAlchemy操作SQL Server的中文问题</strong></a>
      <small class="article-date-index">&nbsp; 2010-02-24</small>
      <!--<a>
      <div = post.date  </div>
      </a>-->
      <br>
      <br> <!-- blair add -->
    </myh11>
  


      </header>
    
    <div class="article-meta">
      <!--<a href="/post/chinese-problem-of-sqlalchemy-with-sqlserver/" class="article-date">
  <time datetime="2010-02-23T16:00:00.000Z" itemprop="datePublished">2010-02-24</time>
</a>-->
      <!--
-->
      <!--
      
        <div class="article-comment-link-wrap">
          <a href="http://0x3f.org/post/chinese-problem-of-sqlalchemy-with-sqlserver/#disqus_thread" class="article-comment-link">Comments</a>
        </div>
      
      -->
    </div>
	
    <div class="article-entry" itemprop="articleBody">
      
        <p>最初将脚本的文件编码和coding行都设定为UTF-8，在windows下执行时，中文无法保存，报编码错误。将上述两个编码改为GBK后，保存正常，但查询时报错。</p>

<p>Traceback内容如下：</p>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">Traceback (most recent call last):</span><br><span class="line">File &quot;test.py&quot;, line 36, in &lt;code&gt;&amp;lt;module&amp;gt;&lt;/code&gt;</span><br><span class="line">&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;for obj in session.query(User):</span><br><span class="line">File &quot;C:\Python26\lib\site-packages\sqlalchemy-0.6beta1-py2.6.egg\sqlalchemy\orm\query.py&quot;, line 1411, in instances</span><br><span class="line">&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;rows = [process[0](row, None) for row in fetch]</span><br><span class="line">File &quot;C:\Python26\lib\site-packages\sqlalchemy-0.6beta1-py2.6.egg\sqlalchemy\orm\mapper.py&quot;, line 1788, in _instance</span><br><span class="line">&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;populate_state(state, dict_, row, isnew, only_load_props)</span><br><span class="line">File &quot;C:\Python26\lib\site-packages\sqlalchemy-0.6beta1-py2.6.egg\sqlalchemy\orm\mapper.py&quot;, line 1677, in populate_state</span><br><span class="line">&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;populator(state, dict_, row, isnew=isnew, **flags)</span><br><span class="line">File &quot;C:\Python26\lib\site-packages\sqlalchemy-0.6beta1-py2.6.egg\sqlalchemy\orm\strategies.py&quot;, line 118, in new_execute</span><br><span class="line">&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;dict_[key] = row[col]</span><br><span class="line">File &quot;C:\Python26\lib\site-packages\sqlalchemy-0.6beta1-py2.6.egg\sqlalchemy\engine\base.py&quot;, line 1634, in __getitem__</span><br><span class="line">&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;return self.__colfuncs[key][0](self.__row)</span><br><span class="line">File &quot;C:\Python26\lib\site-packages\sqlalchemy-0.6beta1-py2.6.egg\sqlalchemy\engine\base.py&quot;, line 1716, in getcol</span><br><span class="line">&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;return processor(row[index])</span><br><span class="line">File &quot;C:\Python26\lib\site-packages\sqlalchemy-0.6beta1-py2.6.egg\sqlalchemy\types.py&quot;, line 568, in process</span><br><span class="line">&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;return decoder(value)[0]</span><br><span class="line">File &quot;C:\Python26\lib\encodings\utf_8.py&quot;, line 16, in decode</span><br><span class="line">&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;return codecs.utf_8_decode(input, errors, True)</span><br><span class="line">UnicodeEncodeError: &apos;ascii&apos; codec can&apos;t encode characters in position 0-1: ordinal not in range(128)&lt;/p&gt;</span><br></pre></td></tr></table></figure>

<p>环境为：</p>

<p>OS：Windows XP简体中文版
DB：SQL Server 2008 Express简体中文版
DB模块：pyodbc
脚本文件编码：GBK
脚本coding行：GBK</p>

<p>脚本内容：</p>

<p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/python</span></span><br><span class="line"><span class="comment"># -*- encoding: gbk -*-</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> sqlalchemy <span class="keyword">import</span> create_engine</span><br><span class="line"><span class="keyword">from</span> sqlalchemy.ext.declarative <span class="keyword">import</span> declarative_base</span><br><span class="line"><span class="keyword">from</span> sqlalchemy.orm <span class="keyword">import</span> sessionmaker</span><br><span class="line"><span class="keyword">from</span> sqlalchemy <span class="keyword">import</span> Column, Integer, String, Text, ForeignKey, Numeric, Unicode</span><br><span class="line"></span><br><span class="line">Base = declarative_base()</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">User</span><span class="params">(Base)</span>:</span></span><br><span class="line">    <span class="string">"""User class"""</span></span><br><span class="line"></span><br><span class="line">    __tablename__ = <span class="string">'users'</span></span><br><span class="line"></span><br><span class="line">    id = Column(Numeric(<span class="number">22</span>,<span class="number">0</span>), primary_key=<span class="keyword">True</span>)</span><br><span class="line">    name = Column(Unicode(<span class="number">128</span>), nullable=<span class="keyword">False</span>, unique=<span class="keyword">True</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, id, name)</span>:</span></span><br><span class="line">        self.id = id</span><br><span class="line">        self.name = name</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    db_engine = create_engine(<span class="string">'mssql://sa:password@localhost/mydatabase'</span>, echo=<span class="keyword">True</span>)</span><br><span class="line">    Session = sessionmaker(bind=db_engine)</span><br><span class="line">    session = Session()</span><br><span class="line"></span><br><span class="line">    Base.metadata.drop_all(db_engine)</span><br><span class="line">    Base.metadata.create_all(db_engine)</span><br><span class="line"></span><br><span class="line">    jim = User(<span class="number">1</span>, <span class="string">'中文'</span>)</span><br><span class="line">    session.add(jim)</span><br><span class="line">    session.commit()</span><br><span class="line"></span><br><span class="line">    <span class="string">'''</span></span><br><span class="line"><span class="string">    for obj in session.query(User):</span></span><br><span class="line"><span class="string">        print obj.name</span></span><br><span class="line"><span class="string">    '''</span></span><br></pre></td></tr></table></figure>
</p>

<p>上面的脚本执行后，数据得以正常保存，在数据库中的查询结果也正常，没有乱码。但是，当把从drop_all()到commit()行注释掉，取消for循环前后的多行字符串起止符后，即运行查询时，抛出上面的Traceback。</p>

<p>Google了很长时间，没有找到有用的东西。CPyUG更没指望。</p>

<p>回溯Traceback，打开sqlalchemy的types.py，UnicodeEncodeError的抛出点在String类的result_processor()方法：</p>

<p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">result_processor</span><span class="params">(self, dialect, coltype)</span>:</span></span><br><span class="line">    wants_unicode = self.convert_unicode <span class="keyword">or</span> dialect.convert_unicode</span><br><span class="line">    needs_convert = wants_unicode <span class="keyword">and</span> \</span><br><span class="line">                    (<span class="keyword">not</span> dialect.returns_unicode_strings <span class="keyword">or</span> </span><br><span class="line">                    self.convert_unicode == <span class="string">'force'</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> needs_convert:</span><br><span class="line">        <span class="comment"># note we *assume* that we do not have a unicode object</span></span><br><span class="line">        <span class="comment"># here, instead of an expensive isinstance() check.</span></span><br><span class="line">        decoder = codecs.getdecoder(dialect.encoding)</span><br><span class="line">        <span class="function"><span class="keyword">def</span> <span class="title">process</span><span class="params">(value)</span>:</span></span><br><span class="line">            <span class="keyword">if</span> value <span class="keyword">is</span> <span class="keyword">not</span> <span class="keyword">None</span>:</span><br><span class="line">                <span class="comment"># decoder returns a tuple: (value, len)</span></span><br><span class="line">                <span class="keyword">return</span> decoder(value)[<span class="number">0</span>]</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                <span class="keyword">return</span> value</span><br><span class="line">        <span class="keyword">return</span> process</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">None</span></span><br></pre></td></tr></table></figure>
</p>

<p>这个方法就是根据数据库方言dialect和字段类型coltype返回一个字符串的解码函数。若在if语句上面将needs_convert置为False，即不对该字段使用解码器，则再执行上面的脚本时，查询正常。</p>

<p>由于前面create_engine()函数的encoding参数缺省为UTF-8，故dialect.encoding的值为“UTF-8”，故if语句中decoder实际引用的是codecs.utf_8_decode()。也就是说，result_processor()方法在实际执行过程中返回的是一个封装了utf_8_decode()函数的函数。即，UnicodeEncodeError是在对从数据库中查询出来的中文字符串进行UTF-8解码时抛出的。</p>

<p>对传入process()函数的值作isinstance(value,unicode)判断，显示为True，表明从数据库中查询出来的中文本身就是unicode字节码，当对它再进行UTF-8解码时，就抛出了UnicodeEncodeError的错误。为验证以上判断，做如下实验：</p>

<p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt;t = <span class="string">'中文'</span></span><br><span class="line">&gt;&gt;&gt;u = <span class="string">u'中文'</span></span><br><span class="line">&gt;&gt;&gt;isinstance(t, str)</span><br><span class="line"><span class="keyword">True</span></span><br><span class="line">&gt;&gt;&gt;isinstance(t, unicode)</span><br><span class="line"><span class="keyword">False</span></span><br><span class="line">&gt;&gt;&gt;isinstance(u, str)</span><br><span class="line"><span class="keyword">False</span></span><br><span class="line">&gt;&gt;&gt;isinstance(u, unicode)</span><br><span class="line"><span class="keyword">True</span></span><br><span class="line">&gt;&gt;&gt;x = t.decode(<span class="string">'utf-8'</span>)</span><br><span class="line">&gt;&gt;&gt;x</span><br><span class="line"><span class="string">u'\u4e2d\u6587'</span></span><br><span class="line">&gt;&gt;&gt;isinstance(x, unicode)</span><br><span class="line"><span class="keyword">True</span></span><br><span class="line">&gt;&gt;&gt;x == u</span><br><span class="line"><span class="keyword">True</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">import</span> codecs</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>dc = codecs.getdecoder(<span class="string">'utf-8'</span>)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>dc(u)</span><br><span class="line">Traceback (most recent call last):</span><br><span class="line">  File <span class="string">"&lt;input&gt;"</span>, line <span class="number">1</span>, <span class="keyword">in</span> &lt;module&gt;</span><br><span class="line">  File <span class="string">"/usr/lib/python2.6/encodings/utf_8.py"</span>, line <span class="number">16</span>, <span class="keyword">in</span> decode</span><br><span class="line">    <span class="keyword">return</span> codecs.utf_8_decode(input, errors, <span class="keyword">True</span>)</span><br><span class="line">UnicodeEncodeError: <span class="string">'ascii'</span> codec can<span class="string">'t encode characters in position 0-1: ordinal not in range(128)</span></span><br></pre></td></tr></table></figure>
</p>

<p>得证。</p>

<p>在Python中，字符串类型str和unicode类型是两种不同的数据类型，str类型的数据可以通过指定正确的编码来转换成unicode类型，对unicode类型的数据作重复的解码操作就会抛出类似上面的错误。</p>

<p>实事上，若将name字段声明为String类，则保存和查询操作均无问题。但由于我需要sqlalchemy建表时将相应字段的类型设为nvarchar，故必须使用Unicode类声明该列。</p>

<p>那有没有办法使result_processor()方法不返回一个对字段值作重复解码的函数呢？</p>

<p>返回result_processor()方法，self.convert_unicode对于Unicode类是True，dialect.convert_unicode由create_engine()函数的convert_unicode参数控制，缺省为False，故needs_convert变量为True，无法更改；dialect.returns_unicode_strings是由sqlalchemy.engine模块default.py中的DefaultDialect类的_check_unicode_returns()方法返回的，该方法内容为：</p>

<p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">_check_unicode_returns</span><span class="params">(self, connection)</span>:</span></span><br><span class="line">    cursor = connection.connection.cursor()</span><br><span class="line">    cursor.execute(</span><br><span class="line">        str(</span><br><span class="line">            expression.select( </span><br><span class="line">            [expression.cast(</span><br><span class="line">                expression.literal_column(<span class="string">"'test unicode returns'"</span>),sqltypes.VARCHAR(<span class="number">60</span>))</span><br><span class="line">            ]).compile(dialect=self)</span><br><span class="line">        )</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    row = cursor.fetchone()</span><br><span class="line">    result = isinstance(row[<span class="number">0</span>], unicode)</span><br><span class="line">    cursor.close()</span><br><span class="line">    <span class="keyword">return</span> result</span><br></pre></td></tr></table></figure>
</p>

<p>此方法的功能为生成一条SQL语句，在数据库中执行后，判断返回的值是否为unicode类型。由于SQL Server是ASCII编码，故此方法返回False。因此，dialect.returns_unicode_strings的值为False。最终，needs_convert只能为True。我觉得这是sqlalchemy的一个Bug。</p>

<p>在此条件下，目前尚未找到较好的解决办法，只能使用硬编码强制置result_processor()方法中的needs_convert变量为False。</p>

<p><strong>2010-02-25 更新：</strong></p>

<p>谢谢KL童鞋指出问题原因和解决办法，使问题得以完美解决。</p>

<p>1、由于Python在载入site模块时会删除setdefaultencoding()函数，故不能以在脚本开头调用此函数的方式指定默认编码；sitecustomize.py是一个python会自动导入的模块，故应当使用这个文件指定默认编码；</p>

<p>2、我这里需要使用utf-8作默认编码器，sitecustomize.py的内容如下：</p>

<p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/python</span></span><br><span class="line"><span class="comment"># -*- coding: gbk -*-</span></span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line">sys.setdefaultencoding(<span class="string">'utf-8'</span>)</span><br></pre></td></tr></table></figure>
</p>

<p>3、将sitecustomize.py保存到python安装目录下的Lib\site-packages目录中；</p>

<p>另外，在<a href="http://www.woodpecker.org.cn/diveintopython/xml_processing/unicode.html" target="_blank" rel="noopener">此处</a>发现了跟本问题相关的资料，辅助治疗，效果更佳。</p>

      
    </div>
	
    <!--
	
    -->
    <!--
    
      <footer class="article-footer">
      </footer>
    
    -->
  </div>
  
</article>



    
      <article id="post-switching-from-ums-to-kms" class="article article-type-post" itemscope="" itemprop="blogPost">
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <myh11 itemprop="name">
      <a class="article-title-index" href="/post/switching-from-ums-to-kms/"><strong>被迫弃UMS而用KMS</strong></a>
      <small class="article-date-index">&nbsp; 2010-02-13</small>
      <!--<a>
      <div = post.date  </div>
      </a>-->
      <br>
      <br> <!-- blair add -->
    </myh11>
  


      </header>
    
    <div class="article-meta">
      <!--<a href="/post/switching-from-ums-to-kms/" class="article-date">
  <time datetime="2010-02-12T16:00:00.000Z" itemprop="datePublished">2010-02-13</time>
</a>-->
      <!--
-->
      <!--
      
        <div class="article-comment-link-wrap">
          <a href="http://0x3f.org/post/switching-from-ums-to-kms/#disqus_thread" class="article-comment-link">Comments</a>
        </div>
      
      -->
    </div>
	
    <div class="article-entry" itemprop="articleBody">
      
        <p>昨天更新了一下系统，今天开机就白屏了。于是先关掉Compiz，看了一下Archlinux的<a href="http://www.archlinux.org/news/484/" target="_blank" rel="noopener">新闻</a>，发现新的<strong>xf86-video-intel</strong>中已经移除了UMS，也就意味着只能使用KMS做3D加速了。</p>

<p><a href="http://www.thinkwiki.org/wiki/Intel_Graphics_Media_Accelerator_950#User_mode_setting_.28UMS.29" target="_blank" rel="noopener">UMS</a>的全称是<strong>User Mode-Setting</strong>，是一种传统的图形界面初始化方案，即在X加载之后由它初始化图形界面。这种方案的弊端是虚拟终端不具备显示和处理图形的能力，同时虚拟终端和图形界面之间的切换显得缓慢并带有闪烁。</p>

<p><a href="http://wiki.archlinux.org/index.php/KMS" target="_blank" rel="noopener">KMS</a>的全称是<strong>Kernel Mode-Setting</strong>，是新一代图形界面初始化方案，它将图形界面的初始化由X加载之后由X负责进行改为在内核初始化时由内核进行。KMS的好处不仅仅是解决了上面UMS的问题，同时也使得Linux具备了在启动时显示漂亮的开机图示的能力。另外，在3D加速性能和低功耗方面，KMS也较UMS更胜一筹。</p>

<p>我的<a href="http://0x3f.org/?p=819">Thinkpad X200</a>使用的是Intel GMA 945的芯片组，而Archlinux的<a href="http://wiki.archlinux.org/index.php/Intel_(简体中文)#KMS_.28Kernel_Mode_Setting.29" target="_blank" rel="noopener">Wiki</a>上仍以915为例，所以尝试着做如下内容：</p>

<p>一、去除/boot/grub/menu.lst中Kernel启动参数中的<a href="http://0x3f.org/?p=866">vga参数</a>；</p>

<p>二、加入以下内容到/etc/modprobe.d/modprobe.conf：</p>

<blockquote>
  <p>options i945 modeset=1</p>
</blockquote>

<p>三、在/etc/rc.conf中的<strong>MODULES</strong>行加入<strong>intel_agp</strong>和<strong>i945</strong>；</p>

<p>重启系统后，Compiz白屏问题解决，3D加速性能似乎有所上升。</p>

      
    </div>
	
    <!--
	
    -->
    <!--
    
      <footer class="article-footer">
      </footer>
    
    -->
  </div>
  
</article>



    
      <nav id="page-nav">
        <a class="extend prev" rel="prev" href="/page/37/">&laquo; Prev</a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/36/">36</a><a class="page-number" href="/page/37/">37</a><span class="page-number current">38</span><a class="page-number" href="/page/39/">39</a><a class="page-number" href="/page/40/">40</a><a class="page-number" href="/page/41/">41</a><a class="extend next" rel="next" href="/page/39/">Next &raquo;</a>
      </nav>
    

</section>
    <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2020 晴耕雨讀&nbsp;
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>, theme by <a href="http://github.com/52binge/hexo-theme-blairos">blairos</a>
    </div>
  </div>
</footer>

<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    extensions: ["tex2jax.js"],
    jax: ["input/TeX"],
    tex2jax: {
      inlineMath: [ ['$','$'], ['\\(','\\)'] ],
      displayMath: [ ['$$','$$']],
      processEscapes: true
    }
  });
</script>
<script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS_HTML,http://myserver.com/MathJax/config/local/local.js">
</script>

    
<script type="text/javascript"> <!-- add by blair 0724 type=text/javascript -->
  var disqus_shortname = '0x3f';
  
  (function(){
    var dsq = document.createElement('script');
    dsq.type = 'text/javascript';
    dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/count.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  })();
</script>


<script src="/js/jquery.min.js"></script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  <script src="/fancybox/jquery.fancybox.pack.js"></script>


<script src="/js/script.js"></script>

  </div>
</body>
</html>
