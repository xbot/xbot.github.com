<!doctype html>
<html lang="en">
    <head><meta name="generator" content="Hexo 3.8.0">
		
        <meta http-equiv="Content-Type" content="text/html" charset="UTF-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
        <meta name="description" content="">
        <meta name="referrer" content="no-referrer">
        <link rel="shortcut icon" href="/asset/logo.jpg">
        <link rel="canonical" href="http://guolinn.com/">
        <link rel="alternate" type="application/rss+xml" title="晴耕雨讀" href="/atom.xml">
        <title>UltraBlog.vim v3.4.0: 正则表达式、批量替换和调试模式 | 晴耕雨讀</title>
        <meta name="description" content="{{meta_description}}">

        <link href="//cdn.bootcss.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet">
        <link rel="stylesheet" type="text/css" href="/styles/crisp.css">
        <meta name="HandheldFriendly" content="True">
        <meta name="MobileOptimized" content="320">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
        <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
        <![endif]-->

    </head>
    
		<body class="post-template">
	

        <header id="header">
            <a id="logo" href="/"><img src="/asset/logo.jpg" alt="晴耕雨讀"></a>
            <h1><a href="/">晴耕雨讀</a></h1>
            <p>程序員，最佳實踐和閱讀愛好者，Vim、Archlinux、Mac、iOS擁躉，帝都低端人口。</p>
            <div id="follow-icons">
          <a href="http://github.com/xbot"><i class="fa fa-github-square fa-2x"></i></a>
          <a href="http://twitter.com/leninlee"><i class="fa fa-twitter-square fa-2x"></i></a>
          <a href="/atom.xml"><i class="fa fa-rss-square fa-2x"></i></a>
  </div>
<h6><a href="/archives">歸檔</a></h6>
<h6><a href="/about">關於</a></h6>
<form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input"><input type="hidden" name="sitesearch" value="http://0x3f.org"></form>

        </header>

        <main id="content">
        

<article class="post">
  四月 29, 2012
  
    <span class="taglist">  &middot; 
    
    
      <a href="/tags/python/">Python</a> 
    
      <a href="/tags/编程/">编程</a> 
    
      <a href="/tags/vim/">Vim</a> 
    
      <a href="/tags/博客/">博客</a> 
    
      <a href="/tags/plugin/">Plugin</a> 
    
      <a href="/tags/ultrablog-vim/">UltraBlog.vim</a> 
    
    </span>
  

  <h1 class="post-title">UltraBlog.vim v3.4.0: 正则表达式、批量替换和调试模式</h1>
  <section class="post-content article-entry">
    <p>这次的更新主要引入了支持正则表达式的全文检索、批量替换和调试模式。</p>
<h2>正则表达式</h2>
<p>我一直觉得原来的全文检索有一个遗憾，虽然可以通过多个关键词实现较为精确的查询，但还是不如正则表达式灵活和精确。</p>
<p>这是个蓄谋已久的需求，但直到真正做起来，才发现很多有意思的东西。虽然SQLite3提供支持正则表达式查询的<strong>“REGEX”</strong>关键词，但并没有实际实现这个功能，而是需要写程序实现并在数据库接口中注册这个函数：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> sqlite3</span><br><span class="line"></span><br><span class="line">conn = sqlite3.connect(<span class="string">'/tmp/your-database-file.db'</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 使用正则表达式匹配给定内容的函数，返回布尔类型</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">regexp_search</span><span class="params">(expr, item)</span>:</span></span><br><span class="line">    <span class="string">"""Check if the item has a sub-string which matches the expr"""</span></span><br><span class="line">    reg = re.compile(expr)</span><br><span class="line">    <span class="keyword">return</span> reg.search(item) <span class="keyword">is</span> <span class="keyword">not</span> <span class="keyword">None</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 在数据库中注册这个函数</span></span><br><span class="line">conn.create_function(<span class="string">'REGEXP'</span>, <span class="number">2</span>, regexp_search)</span><br><span class="line"></span><br><span class="line">cur = conn.execute(<span class="string">'select id,title from post where content REGEXP ?'</span>, <span class="string">'\babc\b'</span>)</span><br><span class="line">row = cur.fetchone()</span><br><span class="line"><span class="keyword">print</span> row</span><br><span class="line"></span><br><span class="line">conn.close()</span><br></pre></td></tr></table></figure>

<p>在SQLAlchemy中具体的实现方式是：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 注册函数</span></span><br><span class="line">dbe = sqlalchemy.create_engine(<span class="string">"sqlite:///tmp/your-database-file.db"</span>)</span><br><span class="line">conn = dbe.connect()</span><br><span class="line">conn.connection.create_function(<span class="string">'REGEXP'</span>, <span class="number">2</span>, regexp_search)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 在SQL Expression Language中创建查询条件</span></span><br><span class="line">tbl = Post.__table__</span><br><span class="line">cond_1 = tbl.c.title.op(<span class="string">'regexp'</span>)(<span class="string">r'\babc\b'</span>)</span><br><span class="line">cond_2 = tbl.c.content.op(<span class="string">'regexp'</span>)(<span class="string">r'\babc\b'</span>)</span><br></pre></td></tr></table></figure>

<p>和普通的全文检索一样，正则表达式的全文检索也支持使用多个表达式作为查询条件，多个条件之间是与的关系。现在可以这样查询所有包含“UltraBlog.vim”但不把推广代码算在内的文章了：</p>
<figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">:UBRegexSearch [^\[]UltraBlog\.<span class="keyword">vim</span>[^\]]</span><br></pre></td></tr></table></figure>

<h2>批量替换</h2>
<p>在我换过新域名后，我就觉得这个功能很有必要了：</p>
<figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">:UBReplace http<span class="variable">s:</span>//sinolog.it http<span class="variable">s:</span>//<span class="number">0</span>x3f.org</span><br></pre></td></tr></table></figure>

<p>包含第一个参数内容并被替换的文章数目会显示在Vim的命令输出缓冲区中。</p>
<p>有了前面实现全文检索支持正则表达式的尝试，再实现支持正则表达式的批量替换就容易多了：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 转换字符串成raw格式的函数</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">raw</span><span class="params">(text)</span>:</span></span><br><span class="line">    <span class="string">"""Returns a raw string representation of text"""</span></span><br><span class="line">    escape_dict=&#123;<span class="string">'\a'</span>:<span class="string">r'\a'</span>, <span class="string">'\b'</span>:<span class="string">r'\b'</span>, <span class="string">'\c'</span>:<span class="string">r'\c'</span>, <span class="string">'\f'</span>:<span class="string">r'\f'</span>, <span class="string">'\n'</span>:<span class="string">r'\n'</span>,</span><br><span class="line">               <span class="string">'\r'</span>:<span class="string">r'\r'</span>, <span class="string">'\t'</span>:<span class="string">r'\t'</span>, <span class="string">'\v'</span>:<span class="string">r'\v'</span>, <span class="string">'\''</span>:<span class="string">r'\''</span>, <span class="string">'\"'</span>:<span class="string">r'\"'</span>,</span><br><span class="line">               <span class="string">'\0'</span>:<span class="string">r'\0'</span>, <span class="string">'\1'</span>:<span class="string">r'\1'</span>, <span class="string">'\2'</span>:<span class="string">r'\2'</span>, <span class="string">'\3'</span>:<span class="string">r'\3'</span>, <span class="string">'\4'</span>:<span class="string">r'\4'</span>,</span><br><span class="line">               <span class="string">'\5'</span>:<span class="string">r'\5'</span>, <span class="string">'\6'</span>:<span class="string">r'\6'</span>, <span class="string">'\7'</span>:<span class="string">r'\7'</span>, <span class="string">'\8'</span>:<span class="string">r'\8'</span>, <span class="string">'\9'</span>:<span class="string">r'\9'</span>&#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">""</span>.join([escape_dict.get(char,char) <span class="keyword">for</span> char <span class="keyword">in</span> text])</span><br><span class="line"></span><br><span class="line"><span class="comment"># 使用正则表达式替换字符串的函数</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">regex_replace</span><span class="params">(string, expr, repl)</span>:</span></span><br><span class="line">    <span class="string">"""Do substitutions on the string for repls matching the expr"""</span></span><br><span class="line">    r = re.compile(raw(expr))</span><br><span class="line">    <span class="keyword">return</span> r.sub(repl, string)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 在数据库中注册这个函数</span></span><br><span class="line">conn.connection.create_function(<span class="string">'regex_replace'</span>, <span class="number">3</span>, regex_replace)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 在SQL语句中使用这个函数</span></span><br><span class="line">sql_replace = <span class="string">"update post set title=regex_replace(title,:needle,:replacement),content=regex_replace(content,:needle,:replacement)"</span></span><br><span class="line">conn.execute(sql_replace, &#123;<span class="string">'needle'</span>:<span class="string">r'\babc\b'</span>, <span class="string">'replacement'</span>:<span class="string">'xyz'</span>&#125;)</span><br></pre></td></tr></table></figure>

<p>最终，这个命令是这样的：</p>
<figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">:UBRegexReplace \babc\<span class="keyword">b</span> xyz</span><br></pre></td></tr></table></figure>

<p>实现批量替换容易，但要解决由此引出的一个问题就费周折了，就是批量替换过文章内容后怎样和博客同步的问题，现在我还没有好的想法，留作以后实现。</p>
<h2>调试模式</h2>
<p>开启调试模式可以将所有被执行的SQL语句显示在Vim的命令输出缓冲区中，在有异常抛出时，也可以显示堆栈信息。由于开启调试模式既不需要修改代码，也不需要重启Vim，这可以极大地方便开发时对UltraBlog.vim的调试，也能使用户提交问题时能反馈更多更详细的信息。</p>
<p>以下三个命令用于控制调试模式的开启状态：</p>
<ul>
<li><code>:UBEnableDebug</code></li>
<li><code>:UBDisableDebug</code></li>
<li><code>:UBToggleDebug</code></li>
</ul>
<h2>其它内容</h2>
<p>本次更新的内容如下：</p>
<ul>
<li>Feature: Add the command <strong>:UBRegexSearch</strong>, doing full-text searches with regular expressions !</li>
<li>Feature: Add the command <strong>:UBReplace</strong>, doing full-text substitutions.</li>
<li>Feature: Add the command <strong>:UBRegexReplace</strong>, doing full-text substitutions with regular expressions.</li>
<li>Feature: Add commands <strong>:UBEnableDebug</strong>, <strong>:UBDisableDebug</strong>, <strong>:UBToggleDebug</strong> and an option <strong>ub_debug</strong>. In debug mode, SQL statements and stack traces of exceptions will be displayed.</li>
<li>Change:  Undo keywords highlighting after executing <strong>:UBList</strong>.</li>
<li>Bugfix:  Exceptions raised when opening the current item under cursor in item lists if the option <strong>ub_hotkey_save_current_item</strong> has not been set. Now this options comes with a default value.</li>
</ul>
<p>关于UB的详细信息在<a href="http://0x3f.org/?p=1894">这里</a>。</p>
<p>Posted via <a href="http://0x3f.org/?p=1894">UltraBlog.vim</a>.</p>

  </section>
  <footer class="post-footer">
    <!--
    <section class="author">
      <h4>晴耕雨讀</h4>
      <p></p>
    </section>
    -->
  </footer>
</article>

<nav class="pagination" role="pagination">
    
    <a class="newer-posts" href="/post/ultrablog-v350-released/">
        ← 新 <!--UltraBlog.vim v3.5.0: 内建浏览器-->
    </a>
    
    <span class="page-number">•</span>
    
    <a class="older-posts" href="/post/fsockopen-fails-connecting-localhost/">
        <!--慎用PHP的fsockopen()连接localhost--> 舊 →
    </a>
    
</nav>
<div id="comments">
  <div id="disqus_thread"></div>
  <script type="text/javascript">
      var disqus_shortname = '0x3f';
      (function() {
          var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
          dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
          (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
      })();
  </script>
  <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
  <a href="http://disqus.com" class="dsq-brlink">Comments powered by <span class="logo-disqus">Disqus</span></a>
</div>


        </main>
        <footer id="footer">
            <section id="footer-message">&copy; 2006 - 2019 晴耕雨讀. All rights reserved.</section>
        </footer>
        <script type="text/javascript" src="http://tajs.qq.com/stats?sId=61071954" charset="UTF-8"></script>
    </body>
</html>


