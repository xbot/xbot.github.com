<!doctype html>
<html lang="en">
    <head><meta name="generator" content="Hexo 3.8.0">
		
        <meta http-equiv="Content-Type" content="text/html" charset="UTF-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
        <meta name="description" content="">
        <meta name="referrer" content="no-referrer">
        <link rel="shortcut icon" href="/asset/logo.jpg">
        <link rel="canonical" href="http://guolinn.com/">
        <link rel="alternate" type="application/rss+xml" title="晴耕雨讀" href="/atom.xml">
        <title>基于Laravel的项目的单元测试规范 | 晴耕雨讀</title>
        <meta name="description" content="{{meta_description}}">

        <link href="//cdn.bootcss.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet">
        <link rel="stylesheet" type="text/css" href="/styles/crisp.css">
        <meta name="HandheldFriendly" content="True">
        <meta name="MobileOptimized" content="320">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
        <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
        <![endif]-->

    </head>
    
		<body class="post-template">
	

        <header id="header">
            <a id="logo" href="/"><img src="/asset/logo.jpg" alt="晴耕雨讀"></a>
            <h1><a href="/">晴耕雨讀</a></h1>
            <p>程序員，最佳實踐和閱讀愛好者，Vim、Archlinux、Mac、iOS擁躉，帝都低端人口。</p>
            <div id="follow-icons">
          <a href="http://github.com/xbot"><i class="fa fa-github-square fa-2x"></i></a>
          <a href="http://twitter.com/leninlee"><i class="fa fa-twitter-square fa-2x"></i></a>
          <a href="/atom.xml"><i class="fa fa-rss-square fa-2x"></i></a>
  </div>
<h6><a href="/archives">歸檔</a></h6>
<h6><a href="/about">關於</a></h6>
<form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input"><input type="hidden" name="sitesearch" value="http://0x3f.org"></form>

        </header>

        <main id="content">
        

<article class="post">
  三月 24, 2019
  
    <span class="taglist">  &middot; 
    
    
      <a href="/tags/编程/">编程</a> 
    
      <a href="/tags/php/">PHP</a> 
    
      <a href="/tags/单元测试/">单元测试</a> 
    
      <a href="/tags/laravel/">Laravel</a> 
    
    </span>
  

  <h1 class="post-title">基于Laravel的项目的单元测试规范</h1>
  <section class="post-content article-entry">
    <p>单元测试是个好东西，解决了我很多问题，不论开发效率还是代码质量，都给我助益良多。最近想在团队内部推广，就拟了个规范草稿：</p>
<ul>
<li><p>什么是单元？</p>
<p>单元是逻辑的最小单位，是函数或方法。</p>
<p>单元测试意味着只测试单元本身，单元内部调用的其它接口、函数和方法等均称为依赖关系。依赖关系自有它们对应的单元测试负责，不在本单元的测试范围内。</p>
</li>
<li><p>怎么测试单元？（Stub &amp; Mock）</p>
<p>依赖关系是脆弱的，它会导致单元测试的编写和运行效率低下，甚至易于失败。以下是项目中的一个测试用例，由于依赖了用户服务，且该服务在我家无法访问，导致测试失败：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">donie@Donies &gt; ~/Projects/app/service-biz &gt;&gt; master &gt; phpunitat57                                  -- INSERT --</span><br><span class="line">PHPUnit 5.7.26 by Sebastian Bergmann and contributors.</span><br><span class="line"></span><br><span class="line">......E.                                                            8 / 8 (100%)</span><br><span class="line"></span><br><span class="line">Time: 5.59 seconds, Memory: 22.00MB</span><br><span class="line"></span><br><span class="line">There was 1 error:</span><br><span class="line"></span><br><span class="line">1) Tests\\Quotation\\QuotationTest::testUpdateQuotationProject</span><br><span class="line">GuzzleHttp\\Exception\\ConnectException: cURL error 28: Connection timed out after 2003 milliseconds (see &lt;http://curl.haxx.se/libcurl/c/libcurl-errors.html&gt;)</span><br><span class="line"></span><br><span class="line">/Users/donie/Projects/app/service-biz/vendor/guzzlehttp/guzzle/src/Handler/CurlFactory.php:186</span><br><span class="line">/Users/donie/Projects/app/service-biz/vendor/guzzlehttp/guzzle/src/Handler/CurlFactory.php:150</span><br><span class="line">/Users/donie/Projects/app/service-biz/vendor/guzzlehttp/guzzle/src/Handler/CurlFactory.php:103</span><br><span class="line">/Users/donie/Projects/app/service-biz/vendor/guzzlehttp/guzzle/src/Handler/CurlHandler.php:43</span><br><span class="line">/Users/donie/Projects/app/service-biz/vendor/guzzlehttp/guzzle/src/Handler/Proxy.php:28</span><br><span class="line">/Users/donie/Projects/app/service-biz/vendor/guzzlehttp/guzzle/src/Handler/Proxy.php:51</span><br><span class="line">/Users/donie/Projects/app/service-biz/vendor/guzzlehttp/guzzle/src/PrepareBodyMiddleware.php:72</span><br><span class="line">/Users/donie/Projects/app/service-biz/vendor/guzzlehttp/guzzle/src/Middleware.php:30</span><br><span class="line">/Users/donie/Projects/app/service-biz/vendor/guzzlehttp/guzzle/src/RedirectMiddleware.php:68</span><br><span class="line">/Users/donie/Projects/app/service-biz/vendor/guzzlehttp/guzzle/src/Middleware.php:59</span><br><span class="line">/Users/donie/Projects/app/service-biz/vendor/guzzlehttp/guzzle/src/HandlerStack.php:67</span><br><span class="line">/Users/donie/Projects/app/service-biz/vendor/guzzlehttp/guzzle/src/Client.php:275</span><br><span class="line">/Users/donie/Projects/app/service-biz/vendor/guzzlehttp/guzzle/src/Client.php:123</span><br><span class="line">/Users/donie/Projects/app/service-biz/vendor/guzzlehttp/guzzle/src/Client.php:129</span><br><span class="line">/Users/donie/Projects/app/service-biz/app/Services/UserService.php:61</span><br><span class="line">/Users/donie/Projects/app/service-biz/app/Services/UserService.php:96</span><br><span class="line">/Users/donie/Projects/app/service-biz/app/Services/QuotationService.php:121</span><br><span class="line">/Users/donie/Projects/app/service-biz/vendor/illuminate/support/Facades/Facade.php:221</span><br><span class="line">/Users/donie/Projects/app/service-biz/tests/Quotation/QuotationTest.php:154</span><br><span class="line"></span><br><span class="line">ERRORS!</span><br><span class="line">Tests: 8, Assertions: 8, Errors: 1.</span><br></pre></td></tr></table></figure>
<p>要实现真正的单元测试，不可避免地要对单元内部的依赖关系进行伪造，即Mock。</p>
</li>
<li><p>规范</p>
<ul>
<li><p>目录结构</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">tests/</span><br><span class="line">    ↳ Api/</span><br><span class="line">    ↳ Services/</span><br><span class="line">    ↳ Repositories/</span><br><span class="line">    ↳ Helpers/</span><br><span class="line">    ↳ TestCase.php</span><br><span class="line">    ↳ TransactionalTestCase.php</span><br></pre></td></tr></table></figure>
</li>
<li><p>继承关系</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">App\Tests\TestCase</span><br><span class="line">    ↳Tests\TestCase</span><br><span class="line">        ↳Tests\Api\TagTest</span><br><span class="line">        ...</span><br><span class="line">    ↳Tests\TransactionalTestCase</span><br><span class="line">        ↳Tests\Services\TagTest</span><br><span class="line">        ...</span><br></pre></td></tr></table></figure>
</li>
<li><p>接口测试</p>
<ul>
<li>所有接口都必须有测试用例，代码覆盖率100%</li>
<li>位于<code>tests/Api</code>下，命名空间是<code>Tests/Api</code></li>
<li>和被测试的Controller对应</li>
<li>只测试路由和Action本单元的代码，不测试具体业务逻辑</li>
<li>具体业务逻辑封装在Service层，由该层的单元测试负责</li>
<li>测试代码中通过Facade实现对Service层的Mock</li>
</ul>
</li>
<li><p>单元测试</p>
<ul>
<li>Service <ul>
<li>所有Service层的方法都必须有测试用例，代码覆盖率不低于90%</li>
<li>位于<code>tests/Services</code>目录下，命名空间是<code>Tests/Services</code></li>
<li>和被测试的Service对应</li>
<li>通过Facade调用Service层并实现对被测试单元依赖关系的Mock</li>
</ul>
</li>
<li>Repository <ul>
<li>复杂的或有必要的方法要有测试用例，其余可以通过Service层的单元测试覆盖到，代码覆盖率不低于90%</li>
<li>位于<code>tests/Repositories</code>目录下，命名空间是<code>Tests/Repositories</code></li>
<li>和被测试的Repository对应</li>
</ul>
</li>
<li>Helper Functions <ul>
<li>复杂的或有必要的函数要有测试用例，其余可以通过其它层的单元测试覆盖到，代码覆盖率100%</li>
<li>位于<code>tests/Helpers</code>目录下，命名空间是<code>Tests/Helpers</code></li>
<li>每个测试用例和被测试的helper函数对应</li>
</ul>
</li>
</ul>
</li>
<li><p>辅助方法</p>
<p>基类中封装如下辅助方法：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Mock一个对象并返回伪造的实例</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * 可通过回调匿名函数定制Mock的实例的行为特征。</span></span><br><span class="line"><span class="comment"> * 当$inject参数为false时，Mock的实例不被注入容器，缺省为注入。</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> mixed $class 类名字符串或类本身</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> callable $handler 回调匿名函数，接收Mock的实例作为参数，用于定制实例自身行为特征</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> bool $inject 是否注入容器，缺省为true</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> \\Mockery\\MockInterface</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">mock</span><span class="params">($class, callable $handler = null, bool $inject = true)</span>: <span class="title">MockInterface</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    $mockedObj = \Mockery::mock($class);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (is_callable($handler)) &#123;</span><br><span class="line">        call_user_func($handler, $mockedObj);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ($inject) &#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;app-&gt;instance($class, $mockedObj);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> $mockedObj;</span><br><span class="line">&#125;</span><br><span class="line">  </span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Mock一个单例模式的类</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * 可通过回调匿名函数定制Mock的实例的行为特征。</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> mixed    $class   类名字符串或类本身</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> callable $handler 回调匿名函数，接收Mock的实例作为参数，用于定制实例自身行为特征</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">mockSingleton</span><span class="params">($class, callable $handler = null)</span>: <span class="title">void</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    $mockedObj = \Mockery::mock($class);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (is_callable($handler)) &#123;</span><br><span class="line">        call_user_func($handler, $mockedObj);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    $ref = <span class="keyword">new</span> \ReflectionProperty($class, <span class="string">'instance'</span>);</span><br><span class="line">    $ref-&gt;setAccessible(<span class="keyword">true</span>);</span><br><span class="line">    $ref-&gt;setValue(<span class="keyword">null</span>, $mockedObj);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
</ul>

  </section>
  <footer class="post-footer">
    <!--
    <section class="author">
      <h4>晴耕雨讀</h4>
      <p></p>
    </section>
    -->
  </footer>
</article>

<nav class="pagination" role="pagination">
    
    <a class="newer-posts" href="/post/investigation-report-of-git-flows/">
        ← 新 <!--Git工作流调研报告-->
    </a>
    
    <span class="page-number">•</span>
    
    <a class="older-posts" href="/post/replace-syntastic-with-ale/">
        <!--用ALE替换了Syntastic--> 舊 →
    </a>
    
</nav>
<div id="comments">
  <div id="disqus_thread"></div>
  <script type="text/javascript">
      var disqus_shortname = '0x3f';
      (function() {
          var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
          dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
          (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
      })();
  </script>
  <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
  <a href="http://disqus.com" class="dsq-brlink">Comments powered by <span class="logo-disqus">Disqus</span></a>
</div>


        </main>
        <footer id="footer">
            <section id="footer-message">&copy; 2006 - 2019 晴耕雨讀. All rights reserved.</section>
        </footer>
        <script type="text/javascript" src="http://tajs.qq.com/stats?sId=61071954" charset="UTF-8"></script>
    </body>
</html>


