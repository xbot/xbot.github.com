<!doctype html>
<html lang="en">
    <head>
		
        <meta http-equiv="Content-Type" content="text/html" charset="UTF-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
        <meta name="description" content="">
        <link rel="shortcut icon" href="/asset/logo.jpg"/>
        <link rel="canonical" href="http://guolinn.com/">
        <link rel="alternate" type="application/rss+xml" title="晴耕雨讀" href="/atom.xml">
        <title>Inno Setup执行SQL脚本的方法 | 晴耕雨讀</title>
        <meta name="description" content="{{meta_description}}">

        <link href="//cdn.bootcss.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet">
        <link rel="stylesheet" type="text/css" href="/styles/crisp.css">
        <meta name="HandheldFriendly" content="True" />
        <meta name="MobileOptimized" content="320" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
        <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
        <![endif]-->

    </head>
    
		<body class="post-template">
	

        <header id="header">
            <a id="logo" href="/"><img src="/asset/logo.jpg" alt="晴耕雨讀" /></a>
            <h1><a href="/">晴耕雨讀</a></h1>
            <p>程序員，最佳實踐和閱讀愛好者，Vim、Archlinux、Mac、iOS擁躉，帝都低端人口。</p>
            <div id="follow-icons">
          <a href="http://github.com/xbot"><i class="fa fa-github-square fa-2x"></i></a>
          <a href="http://twitter.com/leninlee"><i class="fa fa-twitter-square fa-2x"></i></a>
          <a href="/atom.xml"><i class="fa fa-rss-square fa-2x"></i></a>
  </div>
<h6><a href="/archives">歸檔</a></h6>
<h6><a href="/about">關於</a></h6>
<form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input"><input type="hidden" name="sitesearch" value="http://0x3f.org"></form>

        </header>

        <main id="content">
        

<article class="post">
  五月 17, 2010
  
    <span class="taglist">  &middot; 
    
    
      <a href='/tags/編程/'>編程</a> 
    
      <a href='/tags/windows/'>Windows</a> 
    
      <a href='/tags/数据库/'>数据库</a> 
    
      <a href='/tags/mysql/'>MySQL</a> 
    
      <a href='/tags/oracle/'>oracle</a> 
    
      <a href='/tags/安装/'>安装</a> 
    
      <a href='/tags/客户端/'>客户端</a> 
    
    </span>
  

  <h1 class="post-title">Inno Setup执行SQL脚本的方法</h1>
  <section class="post-content article-entry">
    <p>作为和<a href="http://zh.wikipedia.org/zh-cn/Nullsoft%E8%85%B3%E6%9C%AC%E5%AE%89%E8%A3%9D%E7%B3%BB%E7%B5%B1" target="_blank" rel="external">NSIS</a>并立的、两个最流行的免费Windows应用程序安装包制作工具之一，<a href="http://en.wikipedia.org/wiki/Inno_Setup" target="_blank" rel="external">Inno</a>在学习难度上相对要低一些，非常适合对一些简单的桌面程序打包。但对于较复杂的安装过程，或者Web应用程序来说，我个人觉得不是Inno的强项。当然，既然Inno内嵌了<a href="http://zh.wikipedia.org/zh-cn/Pascal" target="_blank" rel="external">Pascal</a>语言用以扩展功能，理论上不是不可以应付复杂的安装过程，但实现起来要复杂一些。</p>

<p>比如对于在安装过程中连接数据库并执行SQL脚本这样的需求，使用<a href="http://en.wikipedia.org/wiki/InstallShield" target="_blank" rel="external">InstallShield</a>应该会简单地多，而Inno却不支持直接操作数据库，并且相关的资料说明少之又少，还不如NSIS丰富，以至于我踏破铁鞋无觅处，最终却在NSIS的资料中找到了思路。</p>

<p>主要的思路是，在安装过程中，调用数据库客户端连接数据库并执行SQL脚本，然后将执行结果或错误信息输出到文件中，最后通过分析这个文件来判断命令执行的结果。但是，既然是调用特定的客户端，那么对不同数据库的操作自然就有所区别，具体情况如下所述。</p>

<p>首先在打包脚本的<strong>[Files]</strong>段将必需的文件包含进来：</p>

<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">[Files]</div><div class="line">Source: "D:\Development\MyDemoApp\code\*"; DestDir: "&#123;app&#125;"; Flags: ignoreversion recursesubdirs createallsubdirs</div><div class="line">Source: "D:\Development\MyDemoApp\sqlcmd.exe"; Flags: dontcopy</div><div class="line">Source: "D:\Development\MyDemoApp\sqlcmd.rll"; Flags: dontcopy</div><div class="line">Source: "D:\Development\MyDemoApp\mysql.exe"; Flags: dontcopy</div><div class="line">Source: "D:\Development\MyDemoApp\script_mssql.sql"; Flags: dontcopy</div><div class="line">Source: "D:\Development\MyDemoApp\script_mysql.sql"; Flags: dontcopy</div><div class="line">Source: "D:\Development\MyDemoApp\script_oracle.sql"; Flags: dontcopy</div></pre></td></tr></table></figure>

<p>在SQL Server中执行脚本的代码片断：</p>

<figure class="highlight pascal"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">ExecScriptInMSSQL</span><span class="params">(DBHost, DBLogin, DBPass, DBName: <span class="keyword">String</span>)</span>:</span> Boolean;</div><div class="line"><span class="keyword">var</span></div><div class="line">    ConnectExe: <span class="keyword">String</span>;</div><div class="line">    ConnectParam: <span class="keyword">String</span>;</div><div class="line"><span class="keyword">begin</span></div><div class="line">    <span class="comment">&#123;解压临时文件&#125;</span></div><div class="line">    ExtractTemporaryFile(<span class="string">'sqlcmd.exe'</span>);</div><div class="line">    ExtractTemporaryFile(<span class="string">'sqlcmd.rll'</span>);</div><div class="line">    ExtractTemporaryFile(<span class="string">'script_mssql.sql'</span>);</div><div class="line">    <span class="comment">&#123;构造数据库连接字符串&#125;</span></div><div class="line">    ConnectExe := ExpandConstant(<span class="string">'&#123;tmp&#125;'</span>) + <span class="string">'\sqlcmd.exe'</span>;</div><div class="line">    ConnectParam := <span class="string">' -S '</span> + DBHost</div><div class="line">        + <span class="string">' -U '</span> + DBLogin</div><div class="line">        + <span class="string">' -P '</span> + DBPass</div><div class="line">        + <span class="string">' -d '</span> + DBName</div><div class="line">        + <span class="string">' -i script_mssql.sql -o '</span></div><div class="line">        + ExpandConstant(<span class="string">'&#123;tmp&#125;'</span>) + <span class="string">'\dbstatus.txt'</span>;</div><div class="line">    <span class="comment">&#123;建立数据库连接并执行脚本&#125;</span></div><div class="line">    <span class="keyword">if</span> Exec(ConnectExe, ConnectParam, <span class="string">''</span>, SW_HIDE, ewWaitUntilTerminated, ResultCode) <span class="keyword">then</span> <span class="keyword">begin</span></div><div class="line">        Result := ResultCode = <span class="number">0</span>;</div><div class="line">        LoadStringFromFile(ExpandConstant(<span class="string">'&#123;tmp&#125;'</span>) + <span class="string">'\dbstatus.txt'</span>, StatusString);</div><div class="line">        <span class="keyword">if</span> StatusString &lt;&gt; <span class="string">''</span> <span class="keyword">then</span> <span class="keyword">begin</span></div><div class="line">            MsgBox(StatusString, mbError, MB_OK);</div><div class="line">            Result := False;</div><div class="line">        <span class="keyword">end</span> <span class="keyword">else</span> <span class="keyword">begin</span></div><div class="line">            Result := True;</div><div class="line">        <span class="keyword">end</span>;</div><div class="line">    <span class="keyword">end</span> <span class="keyword">else</span> <span class="keyword">begin</span></div><div class="line">        MsgBox(<span class="string">'Database update failed:'</span><span class="string">#10#10</span> + SysErrorMessage(ResultCode), mbError, MB_OK);</div><div class="line">        Result := False;</div><div class="line">    <span class="keyword">end</span>;</div><div class="line"><span class="keyword">end</span>;</div></pre></td></tr></table></figure>

<p>在MySQL中执行脚本的代码片断：</p>

<figure class="highlight pascal"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">ExecScriptInMYSQL</span><span class="params">(DBHost, DBLogin, DBPass, DBName: <span class="keyword">String</span>)</span>:</span> Boolean;</div><div class="line"><span class="keyword">var</span></div><div class="line">    ConnectExe: <span class="keyword">String</span>;</div><div class="line">    ConnectParam: <span class="keyword">String</span>;</div><div class="line"><span class="keyword">begin</span></div><div class="line">    <span class="comment">&#123;解压临时文件&#125;</span></div><div class="line">    ExtractTemporaryFile(<span class="string">'mysql.exe'</span>);</div><div class="line">    ExtractTemporaryFile(<span class="string">'script_mysql.sql'</span>);</div><div class="line">    <span class="comment">&#123;构造数据库连接字符串&#125;</span></div><div class="line">    ConnectExe := ExpandConstant(<span class="string">'cmd'</span>);</div><div class="line">    ConnectParam := <span class="string">' /c "'</span> + ExpandConstant(<span class="string">'&#123;tmp&#125;'</span>) + <span class="string">'\mysql.exe'</span></div><div class="line">        + <span class="string">' -h'</span> + DBHost</div><div class="line">        + <span class="string">' -u'</span> + DBLogin</div><div class="line">        + <span class="string">' -p'</span> + DBPass</div><div class="line">        + <span class="string">' -D'</span> + DBName</div><div class="line">        + <span class="string">' -e "source '</span> + ExpandConstant(<span class="string">'&#123;tmp&#125;'</span>) + <span class="string">'\script_mysql.sql"" &gt; '</span> + ExpandConstant(<span class="string">'&#123;tmp&#125;'</span>) + <span class="string">'\dbstatus.txt 2&gt;&amp;1'</span>;</div><div class="line">    <span class="comment">&#123;建立数据库连接并执行脚本&#125;</span></div><div class="line">    <span class="keyword">if</span> Exec(ConnectExe, ConnectParam, <span class="string">''</span>, SW_HIDE, ewWaitUntilTerminated, ResultCode) <span class="keyword">then</span> <span class="keyword">begin</span></div><div class="line">        Result := ResultCode = <span class="number">0</span>;</div><div class="line">        LoadStringFromFile(ExpandConstant(<span class="string">'&#123;tmp&#125;'</span>) + <span class="string">'\dbstatus.txt'</span>, StatusString);</div><div class="line">        <span class="keyword">if</span> StatusString &lt;&gt; <span class="string">''</span> <span class="keyword">then</span> <span class="keyword">begin</span></div><div class="line">            MsgBox(StatusString, mbError, MB_OK);</div><div class="line">            Result := False;</div><div class="line">        <span class="keyword">end</span> <span class="keyword">else</span> <span class="keyword">begin</span></div><div class="line">            Result := True;</div><div class="line">        <span class="keyword">end</span>;</div><div class="line">    <span class="keyword">end</span> <span class="keyword">else</span> <span class="keyword">begin</span></div><div class="line">        MsgBox(<span class="string">'Database update failed:'</span><span class="string">#10#10</span> + SysErrorMessage(ResultCode), mbError, MB_OK);</div><div class="line">        Result := False;</div><div class="line">    <span class="keyword">end</span>;</div><div class="line"><span class="keyword">end</span>;</div></pre></td></tr></table></figure>

<p>由于mysql.exe没有输出结果到文件的参数，故需要使用cmd.exe来运行mysql.exe以便将其输出重定向到文件dbstatus.txt中。此外，在命令的最后加上参数<strong>2&gt;&amp;1</strong>，将标准错误输出设备也重定向到文件上，否则命令执行的错误信息不会输出到文件中。</p>

<p>在Oracle中执行脚本的代码片断：</p>

<figure class="highlight pascal"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">ExecScriptInORACLE</span><span class="params">(ClientPath, DBInstance, DBLogin, DBPass: <span class="keyword">String</span>)</span>:</span> Boolean;</div><div class="line"><span class="keyword">begin</span></div><div class="line">    <span class="comment">&#123;解压临时文件&#125;</span></div><div class="line">    ExtractTemporaryFile(<span class="string">'script_oracle.sql'</span>);</div><div class="line">    <span class="comment">&#123;连接数据库并执行脚本&#125;</span></div><div class="line">    <span class="keyword">if</span> Exec(ExpandConstant(<span class="string">'cmd'</span>), <span class="string">' /c "'</span> + ClientPath + <span class="string">' -L -S '</span> + DBLogin</div><div class="line">        + <span class="string">'/'</span> + DBPass</div><div class="line">        + <span class="string">'@'</span> + DBInstance</div><div class="line">        + <span class="string">' @'</span> + ExpandConstant(<span class="string">'&#123;tmp&#125;'</span>) + <span class="string">'\script_oracle.sql &gt; '</span> + ExpandConstant(<span class="string">'&#123;tmp&#125;'</span>) + <span class="string">'\dbstatus.txt 2&gt;&amp;1'</span>,</div><div class="line">        <span class="string">''</span>,</div><div class="line">        SW_HIDE, ewWaitUntilTerminated, ResultCode)</div><div class="line">    <span class="keyword">then</span> <span class="keyword">begin</span></div><div class="line">        Result := ResultCode = <span class="number">0</span>;</div><div class="line">        LoadStringFromFile(ExpandConstant(<span class="string">'&#123;tmp&#125;'</span>) + <span class="string">'\dbstatus.txt'</span>, StatusString);</div><div class="line">        <span class="keyword">if</span> Pos(<span class="string">'holytail'</span>, StatusString) &lt;&gt; <span class="number">0</span> <span class="keyword">then</span> <span class="keyword">begin</span></div><div class="line">            <span class="comment">&#123;若输出信息中有“holytail”的子串，则表示脚本成功执行&#125;</span></div><div class="line">            <span class="comment">&#123;若执行有误，提示用户打开日志文件&#125;</span></div><div class="line">            <span class="keyword">if</span> Pos(<span class="string">'ORA-'</span>, StatusString) &lt;&gt; <span class="number">0</span> <span class="keyword">then</span> <span class="keyword">begin</span></div><div class="line">                <span class="comment">&#123;提示用户脚本执行出错&#125;</span></div><div class="line">                <span class="keyword">if</span> MsgBox(<span class="string">'数据库更新出错，是否打开日志文件？'</span>, mbConfirmation, MB_YESNO) = IDYES <span class="keyword">then</span> <span class="keyword">begin</span></div><div class="line">                    <span class="comment">&#123;打开日志&#125;</span></div><div class="line">                    <span class="keyword">if</span> <span class="keyword">not</span> ShellExec(<span class="string">''</span>, ExpandConstant(<span class="string">'&#123;tmp&#125;'</span>) + <span class="string">'\dbstatus.txt'</span>, <span class="string">''</span>, <span class="string">''</span>, SW_SHOW, ewNoWait, ErrorCode) <span class="keyword">then</span> <span class="keyword">begin</span></div><div class="line">                        MsgBox(<span class="string">'日志文件打开错误！'</span>, mbError, MB_OK);</div><div class="line">                    <span class="keyword">end</span>;</div><div class="line">                <span class="keyword">end</span>;</div><div class="line">                Result := False;</div><div class="line">            <span class="comment">&#123;若执行无误，返回True&#125;</span></div><div class="line">            <span class="keyword">end</span> <span class="keyword">else</span> <span class="keyword">begin</span></div><div class="line">                Result := True;</div><div class="line">            <span class="keyword">end</span>;</div><div class="line">        <span class="keyword">end</span> <span class="keyword">else</span> <span class="keyword">if</span> StatusString &lt;&gt; <span class="string">''</span> <span class="keyword">then</span> <span class="keyword">begin</span></div><div class="line">            MsgBox(StatusString, mbError, MB_OK);</div><div class="line">            Result := False;</div><div class="line">        <span class="keyword">end</span> <span class="keyword">else</span> <span class="keyword">begin</span></div><div class="line">            Result := True;</div><div class="line">        <span class="keyword">end</span>;</div><div class="line">    <span class="keyword">end</span> <span class="keyword">else</span> <span class="keyword">begin</span></div><div class="line">        MsgBox(<span class="string">'Database update failed:'</span><span class="string">#10#10</span> + SysErrorMessage(ResultCode), mbError, MB_OK);</div><div class="line">        Result := False;</div><div class="line">    <span class="keyword">end</span>;</div><div class="line"><span class="keyword">end</span>;</div></pre></td></tr></table></figure>

<p>Oracle的客户端太大，不能集成到安装包中，应使用一个<strong>TInputFileWizardPage</strong>由用户选择sqlplus.exe的安装位置。同时，由于sqlplus.exe也没有输出结果到文件的参数，也须使用cmd.exe来运行它并重定向输出到文件。此外，由于sqlplus.exe执行脚本时无论成功还是失败，都会输出信息，故无法像使用sqlcmd.exe和mysql.exe那样简单地判断脚本是否执行成功，需要在脚本的最后通过select语句输出一个特殊的字符串到文件中，然后通过判断dbstatus.txt中是否存在该字符串来判断脚本的执行情况；且由于sqlplus.exe执行完脚本后不会自动退出，还要在脚本最后加上exit语句；故<strong>script_oracle.sql</strong>的最后必须是如下内容：</p>

<figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">SELECT</span> <span class="string">'holytail'</span> <span class="keyword">FROM</span> dual;</div><div class="line">exit;</div></pre></td></tr></table></figure>

  </section>
  <footer class="post-footer">
    <!--
    <section class="author">
      <h4>晴耕雨讀</h4>
      <p></p>
    </section>
    -->
  </footer>
</article>

<nav class="pagination" role="pagination">
    
    <a class="newer-posts" href="/post/using-cpufrequtils-to-reduce-cpu-temperature/">
        ← 新 <!--低碳生活：使用 cpufrequtils降低CPU温度-->
    </a>
    
    <span class="page-number">•</span>
    
    <a class="older-posts" href="/post/freearc/">
        <!--FreeArc：兼顾压缩比率与效率的压缩程序--> 舊 →
    </a>
    
</nav>
<div id="comments">
  <div id="disqus_thread"></div>
  <script type="text/javascript">
      var disqus_shortname = '0x3f';
      (function() {
          var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
          dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
          (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
      })();
  </script>
  <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
  <a href="http://disqus.com" class="dsq-brlink">Comments powered by <span class="logo-disqus">Disqus</span></a>
</div>


        </main>
        <footer id="footer">
            <section id="footer-message">&copy; 2006 - 2017 晴耕雨讀. All rights reserved.</section>
        </footer>
        <script type="text/javascript" src="http://tajs.qq.com/stats?sId=61071954" charset="UTF-8"></script>
    </body>
</html>


