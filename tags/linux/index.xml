<rss xmlns:atom="http://www.w3.org/2005/Atom" version="2.0"><channel><title>Linux - 标签 - 晴耕雨讀</title><link>http://0x3f.org/tags/linux/</link><description>Linux - 标签 - 晴耕雨讀</description><generator>Hugo -- gohugo.io</generator><language>zh-CN</language><copyright>This work is licensed under a Creative Commons Attribution-NonCommercial 4.0 International License.</copyright><lastBuildDate>Mon, 19 Jun 2017 21:49:14 +0000</lastBuildDate><atom:link href="http://0x3f.org/tags/linux/" rel="self" type="application/rss+xml"/><item><title>CopyQ，也许是Linux最好的剪贴板管理工具</title><link>http://0x3f.org/post/copyq/</link><pubDate>Mon, 19 Jun 2017 21:49:14 +0000</pubDate><author>作者</author><guid>http://0x3f.org/post/copyq/</guid><description><![CDATA[<p>我对剪贴板管理工具的核心需求有四个：</p>
<ul>
<li>记录文本</li>
<li>记录图片</li>
<li>快速搜索</li>
<li>独立软件包</li>
</ul>
<p>CopyQ是Linux上唯一满足这些需求的实现，虽然体验上跟Mac下的竞品还有差距。</p>
<p>用法：</p>
<ul>
<li><code>copyq</code>：运行</li>
<li><code>copyq menu</code>：显示剪贴板历史管理菜单</li>
<li><code>copyq show</code>：显示剪贴板历史管理窗口</li>
</ul>
]]></description></item><item><title>自定义GVIM 8标签栏样式的方法</title><link>http://0x3f.org/post/how-to-customize-gvim8-tab-style/</link><pubDate>Sun, 04 Jun 2017 12:42:12 +0000</pubDate><author>作者</author><guid>http://0x3f.org/post/how-to-customize-gvim8-tab-style/</guid><description><![CDATA[<p>GVim 8用的是GTK 3，原来在<code>~/.gtkrc-2.0</code>里加样式的方法不能用了。</p>
<p>GTK 3的样式在<code>~/.config/gtk-3.0/gtk.css</code>里：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-css" data-lang="css"><span class="c">/**
</span><span class="c"> * Adapt to the nova colorscheme
</span><span class="c"> */</span>
<span class="p">@</span><span class="k">define-color</span> <span class="nt">VIM_BG_FIX</span> <span class="p">#</span><span class="nn">3C4C55</span><span class="p">;</span>

<span class="nt">window</span><span class="p">#</span><span class="nn">vim-main-window</span> <span class="p">{</span>
    <span class="k">background-color</span><span class="p">:</span> <span class="o">@</span><span class="n">VIM_BG_FIX</span><span class="p">;</span>
<span class="p">}</span>

<span class="nt">window</span><span class="p">#</span><span class="nn">vim-main-window</span> <span class="nt">notebook</span> <span class="nt">header</span> <span class="p">{</span>
    <span class="k">background-color</span><span class="p">:</span> <span class="mh">#1E272C</span><span class="p">;</span>
    <span class="k">border-bottom-width</span><span class="p">:</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="nt">window</span><span class="p">#</span><span class="nn">vim-main-window</span> <span class="nt">notebook</span> <span class="nt">tab</span> <span class="p">{</span>
    <span class="k">border-bottom-width</span><span class="p">:</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="nt">window</span><span class="p">#</span><span class="nn">vim-main-window</span> <span class="nt">notebook</span> <span class="nt">tab</span> <span class="nt">label</span> <span class="p">{</span>
    <span class="k">padding-left</span><span class="p">:</span><span class="mi">5</span><span class="kt">px</span><span class="p">;</span>
    <span class="k">padding-right</span><span class="p">:</span><span class="mi">5</span><span class="kt">px</span><span class="p">;</span>
    <span class="k">padding-top</span><span class="p">:</span><span class="mi">1</span><span class="kt">px</span><span class="p">;</span>
    <span class="k">padding-bottom</span><span class="p">:</span><span class="mi">2</span><span class="kt">px</span><span class="p">;</span>
    <span class="k">color</span><span class="p">:</span> <span class="mh">#7CBDC6</span><span class="p">;</span>
<span class="p">}</span>
<span class="nt">window</span><span class="p">#</span><span class="nn">vim-main-window</span> <span class="nt">notebook</span> <span class="nt">tab</span><span class="p">:</span><span class="nd">checked</span> <span class="nt">label</span> <span class="p">{</span>
    <span class="k">background-color</span><span class="p">:</span> <span class="mh">#7CBDC6</span><span class="p">;</span>
    <span class="k">color</span><span class="p">:</span> <span class="mh">#1E272C</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>查看GTK 3程序的样式结构的方法是用GTK Inspector：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash"><span class="nv">GTK_DEBUG</span><span class="o">=</span>interactive gvim
</code></pre></td></tr></table>
</div>
</div>]]></description></item><item><title>小确幸，用Vim编辑当前命令行</title><link>http://0x3f.org/post/edit-command-with-vim/</link><pubDate>Mon, 26 Dec 2016 11:58:00 +0000</pubDate><author>作者</author><guid>http://0x3f.org/post/edit-command-with-vim/</guid><description><![CDATA[<p>修改很长的命令是件痛苦的事，在Linux下，可以通过快捷键<code>Ctrl+X Ctrl+E</code>调用<code>$EDITOR</code>快速编辑当前命令行的内容，保存退出后，结果会呈现在光标下。</p>
<p>不过在Mac OS的iTerm2下，似乎是因为<code>Ctrl+X</code>被占用而不能生效。误打误撞地发现了另外一个方法，使用oh-my-zsh并且开启了vi mode的话，先进入vi mode，然后输入<code>v</code>，同样可以实现这样的功能。</p>
]]></description></item><item><title>Archlinux安装过程中的几个坑</title><link>http://0x3f.org/post/pits-of-archlinux/</link><pubDate>Mon, 17 Oct 2016 13:14:00 +0000</pubDate><author>作者</author><guid>http://0x3f.org/post/pits-of-archlinux/</guid><description><![CDATA[<h2 id="安装方案">安装方案</h2>
<p><a href="https://mirrors.ustc.edu.cn/archlinux/iso/archboot/latest/" target="_blank" rel="noopener noreffer">Archboot</a>是比官方镜像更友好的安装媒介，此外还有<a href="https://github.com/helmuthdu/aui" target="_blank" rel="noopener noreffer">AUI</a>和<a href="https://arch-anywhere.org" target="_blank" rel="noopener noreffer">Arch Anywhere</a>，没有试过。</p>
<h2 id="分区">分区</h2>
<p>Archboot使用parted处理分区任务。</p>
<p>第一个分区不能从sector 0开始，否则安装完成后系统玩法启动，报如下错误：</p>
<blockquote>
<p>no operating system found</p>
</blockquote>
<p>正确的姿势：</p>
<blockquote>
<p>(parted) mkpart primary 2048s 512</p>
</blockquote>
<p>以上假设第一个分区用来挂载/boot，分配512M。</p>
<p>还需要设置/boot所在的分区可启动：</p>
<blockquote>
<p>(parted) set 1 boot on</p>
</blockquote>
<h2 id="启动引导器">启动引导器</h2>
<p>GRUB的兼容性比较好。</p>
<p>如果是syslinux，对于没有单独对/boot分区并且根分区使用ext4的情况，会无法启动，报如下错误：</p>
<blockquote>
<p>failed to load ldlinux.c32</p>
</blockquote>
<p>此时，应对/boot单独分区并使用fat格式。</p>
<h2 id="图形界面">图形界面</h2>
<p>安装X不会连带安装显卡驱动，要单独安装，否则启动图形界面会黑屏。</p>
<p>在VirtualBox中安装时，驱动在「virtualbox-guest-utils」。</p>
]]></description></item><item><title>在i3wm状态栏显示股票信息</title><link>http://0x3f.org/post/show-stocks-in-i3status/</link><pubDate>Fri, 12 Jun 2015 17:39:00 +0000</pubDate><author>作者</author><guid>http://0x3f.org/post/show-stocks-in-i3status/</guid><description><![CDATA[<p>效果如图：</p>
<p></p>
<p>创建脚本，并赋可执行权限：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash"><span class="cp">#!/bin/sh
</span><span class="cp"></span><span class="c1"># shell script to prepend i3status with more stuff</span>

<span class="nv">STOCK_SCRIPT</span><span class="o">=</span><span class="sb">`</span>realpath <span class="s2">&#34;</span><span class="nv">$0</span><span class="s2">&#34;</span><span class="p">|</span>xargs dirname<span class="sb">`</span>/stock.php

i3status <span class="p">|</span> <span class="k">while</span> :
<span class="k">do</span>
    <span class="nv">stock_info</span><span class="o">=</span><span class="s2">&#34;&#34;</span>
    <span class="k">if</span> <span class="o">[[</span> -x <span class="s2">&#34;</span><span class="nv">$STOCK_SCRIPT</span><span class="s2">&#34;</span> <span class="o">]]</span><span class="p">;</span> <span class="k">then</span>
        <span class="nv">stock_info</span><span class="o">=</span><span class="sb">`</span><span class="nv">$STOCK_SCRIPT</span><span class="sb">`</span>
    <span class="k">fi</span>

    <span class="nb">read</span> line

    <span class="c1"># if output_format = i3bar in i3status.conf</span>
    <span class="nv">stock_info</span><span class="o">=</span><span class="s2">&#34;[{ \&#34;full_text\&#34;: \&#34;</span><span class="si">${</span><span class="nv">stock_info</span><span class="si">}</span><span class="s2">\&#34; },&#34;</span>
    <span class="nb">echo</span> <span class="s2">&#34;</span><span class="si">${</span><span class="nv">line</span><span class="p">/[/</span><span class="nv">$stock_info</span><span class="si">}</span><span class="s2">&#34;</span> <span class="o">||</span> <span class="nb">exit</span> <span class="m">1</span>

    <span class="c1"># # if not output_format = i3bar in i3status.conf</span>
    <span class="c1"># echo &#34;$stock_info | $line&#34; || exit 1</span>
<span class="k">done</span>
</code></pre></td></tr></table>
</div>
</div><p>如果i3status.conf中启用了JSON格式输出（支持颜色），应启用上面脚本中第一块的代码，否则使用后面的。启动JSON格式输出的内容具体如下：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-javascript" data-lang="javascript"><span class="nx">general</span> <span class="p">{</span>
    <span class="nx">colors</span> <span class="o">=</span> <span class="kc">true</span>
    <span class="nx">output_format</span> <span class="o">=</span> <span class="nx">i3bar</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>在i3wm的配置文件中用以上脚本替换i3status：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-javascript" data-lang="javascript"><span class="nx">bar</span> <span class="p">{</span>

    <span class="err">#</span> <span class="p">...</span>

    <span class="err">#</span> <span class="nx">status_command</span> <span class="nx">i3status</span>
    <span class="nx">status_command</span> <span class="o">~</span><span class="err">/.i3/myi3status.sh</span>

    <span class="err">#</span> <span class="p">...</span>

<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>在和上面脚本同路径下创建脚本：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span><span class="lnt">141
</span><span class="lnt">142
</span><span class="lnt">143
</span><span class="lnt">144
</span><span class="lnt">145
</span><span class="lnt">146
</span><span class="lnt">147
</span><span class="lnt">148
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-php" data-lang="php">#!/bin/env php
<span class="cp">&lt;?php</span>
<span class="k">class</span> <span class="nc">PinYin</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">static</span> <span class="k">function</span> <span class="nf">utf8To</span><span class="p">(</span><span class="nv">$ss</span><span class="p">,</span> <span class="nv">$isfirst</span> <span class="o">=</span> <span class="k">false</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="nx">self</span><span class="o">::</span><span class="na">convert</span><span class="p">(</span><span class="nx">self</span><span class="o">::</span><span class="na">utf8ToGB2312</span><span class="p">(</span><span class="nv">$ss</span><span class="p">),</span> <span class="nv">$isfirst</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">static</span> <span class="k">function</span> <span class="nf">utf8ToGB2312</span><span class="p">(</span><span class="nv">$ss</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="nx">iconv</span><span class="p">(</span><span class="s1">&#39;UTF-8&#39;</span><span class="p">,</span> <span class="s1">&#39;GB2312//IGNORE&#39;</span><span class="p">,</span> <span class="nv">$ss</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="c1">// 字符串必须为GB2312编码
</span><span class="c1"></span>    <span class="k">public</span> <span class="k">static</span> <span class="k">function</span> <span class="nf">convert</span><span class="p">(</span><span class="nv">$ss</span><span class="p">,</span> <span class="nv">$isfirst</span> <span class="o">=</span> <span class="k">false</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nv">$res</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
        <span class="nv">$len</span> <span class="o">=</span> <span class="nx">strlen</span><span class="p">(</span><span class="nv">$ss</span><span class="p">);</span>
        <span class="nv">$pinyinArr</span> <span class="o">=</span> <span class="nx">self</span><span class="o">::</span><span class="na">get_pinyin_array</span><span class="p">();</span>
        <span class="k">for</span> <span class="p">(</span><span class="nv">$i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="nv">$i</span><span class="o">&lt;</span><span class="nv">$len</span><span class="p">;</span> <span class="nv">$i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
            <span class="nv">$ascii</span> <span class="o">=</span> <span class="nx">ord</span><span class="p">(</span><span class="nv">$ss</span><span class="p">[</span><span class="nv">$i</span><span class="p">]);</span>
            <span class="k">if</span> <span class="p">(</span><span class="nv">$ascii</span> <span class="o">&gt;</span> <span class="mh">0x80</span><span class="p">)</span> <span class="p">{</span>
                <span class="nv">$asciiB</span> <span class="o">=</span> <span class="nx">ord</span><span class="p">(</span><span class="nv">$ss</span><span class="p">[</span><span class="o">++</span><span class="nv">$i</span><span class="p">]);</span>
                <span class="nv">$ascii</span> <span class="o">=</span> <span class="nv">$ascii</span> <span class="o">*</span> <span class="mi">256</span> <span class="o">+</span> <span class="nv">$asciiB</span> <span class="o">-</span> <span class="mi">65536</span><span class="p">;</span>
            <span class="p">}</span>

            <span class="k">if</span> <span class="p">(</span><span class="nv">$ascii</span> <span class="o">&lt;</span> <span class="mi">255</span> <span class="o">&amp;&amp;</span> <span class="nv">$ascii</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">if</span> <span class="p">((</span><span class="nv">$ascii</span> <span class="o">&gt;=</span> <span class="mi">48</span> <span class="o">&amp;&amp;</span> <span class="nv">$ascii</span> <span class="o">&lt;=</span> <span class="mi">57</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="nv">$ascii</span> <span class="o">&gt;=</span> <span class="mi">97</span> <span class="o">&amp;&amp;</span> <span class="nv">$ascii</span> <span class="o">&lt;=</span> <span class="mi">122</span><span class="p">))</span> <span class="p">{</span>
                    <span class="nv">$res</span> <span class="o">.=</span> <span class="nv">$ss</span><span class="p">[</span><span class="nv">$i</span><span class="p">];</span> <span class="c1">// 0-9 a-z
</span><span class="c1"></span>                <span class="p">}</span> <span class="k">elseif</span> <span class="p">(</span><span class="nv">$ascii</span> <span class="o">&gt;=</span> <span class="mi">65</span> <span class="o">&amp;&amp;</span> <span class="nv">$ascii</span> <span class="o">&lt;=</span> <span class="mi">90</span><span class="p">)</span> <span class="p">{</span>
                    <span class="nv">$res</span> <span class="o">.=</span> <span class="nx">strtolower</span><span class="p">(</span><span class="nv">$ss</span><span class="p">[</span><span class="nv">$i</span><span class="p">]);</span> <span class="c1">// A-Z
</span><span class="c1"></span>                <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                    <span class="nv">$res</span> <span class="o">.=</span> <span class="s1">&#39;_&#39;</span><span class="p">;</span>
                <span class="p">}</span>
            <span class="p">}</span> <span class="k">elseif</span> <span class="p">(</span><span class="nv">$ascii</span> <span class="o">&lt;</span> <span class="o">-</span><span class="mi">20319</span> <span class="o">||</span> <span class="nv">$ascii</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">10247</span><span class="p">)</span> <span class="p">{</span>
                <span class="nv">$res</span> <span class="o">.=</span> <span class="s1">&#39;_&#39;</span><span class="p">;</span>
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                <span class="k">foreach</span> <span class="p">(</span><span class="nv">$pinyinArr</span> <span class="k">as</span> <span class="nv">$py</span><span class="o">=&gt;</span><span class="nv">$asc</span><span class="p">)</span> <span class="p">{</span>
                    <span class="k">if</span> <span class="p">(</span><span class="nv">$asc</span> <span class="o">&lt;=</span> <span class="nv">$ascii</span><span class="p">)</span> <span class="p">{</span>
                        <span class="nv">$res</span> <span class="o">.=</span> <span class="nv">$isfirst</span> <span class="o">?</span> <span class="nv">$py</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">:</span> <span class="nv">$py</span><span class="p">;</span>
                        <span class="k">break</span><span class="p">;</span>
                    <span class="p">}</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="nv">$res</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">static</span> <span class="k">function</span> <span class="nf">toFirst</span><span class="p">(</span><span class="nv">$ss</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nv">$ascii</span> <span class="o">=</span> <span class="nx">ord</span><span class="p">(</span><span class="nv">$ss</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
        <span class="k">if</span> <span class="p">(</span><span class="nv">$ascii</span> <span class="o">&gt;</span> <span class="mh">0xE0</span><span class="p">)</span> <span class="p">{</span>
            <span class="nv">$ss</span> <span class="o">=</span> <span class="nx">self</span><span class="o">::</span><span class="na">utf8ToGB2312</span><span class="p">(</span><span class="nv">$ss</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="nv">$ss</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="nv">$ss</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>
        <span class="p">}</span> <span class="k">elseif</span> <span class="p">(</span><span class="nv">$ascii</span> <span class="o">&lt;</span> <span class="mh">0x80</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="nv">$ascii</span> <span class="o">&gt;=</span> <span class="mi">65</span> <span class="o">&amp;&amp;</span> <span class="nv">$ascii</span> <span class="o">&lt;=</span> <span class="mi">90</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">return</span> <span class="nx">strtolower</span><span class="p">(</span><span class="nv">$ss</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
            <span class="p">}</span> <span class="k">elseif</span> <span class="p">(</span><span class="nv">$ascii</span> <span class="o">&gt;=</span> <span class="mi">97</span> <span class="o">&amp;&amp;</span> <span class="nv">$ascii</span> <span class="o">&lt;=</span> <span class="mi">122</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">return</span> <span class="nv">$ss</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                <span class="k">return</span> <span class="k">false</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="p">(</span><span class="nx">strlen</span><span class="p">(</span><span class="nv">$ss</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="k">false</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="nv">$asc</span> <span class="o">=</span> <span class="nx">ord</span><span class="p">(</span><span class="nv">$ss</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">*</span> <span class="mi">256</span> <span class="o">+</span> <span class="nx">ord</span><span class="p">(</span><span class="nv">$ss</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">-</span> <span class="mi">65536</span><span class="p">;</span>

        <span class="k">if</span><span class="p">(</span><span class="nv">$asc</span><span class="o">&gt;=-</span><span class="mi">20319</span> <span class="o">&amp;&amp;</span> <span class="nv">$asc</span><span class="o">&lt;=-</span><span class="mi">20284</span><span class="p">)</span> <span class="k">return</span> <span class="s1">&#39;a&#39;</span><span class="p">;</span>
        <span class="k">if</span><span class="p">(</span><span class="nv">$asc</span><span class="o">&gt;=-</span><span class="mi">20283</span> <span class="o">&amp;&amp;</span> <span class="nv">$asc</span><span class="o">&lt;=-</span><span class="mi">19776</span><span class="p">)</span> <span class="k">return</span> <span class="s1">&#39;b&#39;</span><span class="p">;</span>
        <span class="k">if</span><span class="p">(</span><span class="nv">$asc</span><span class="o">&gt;=-</span><span class="mi">19775</span> <span class="o">&amp;&amp;</span> <span class="nv">$asc</span><span class="o">&lt;=-</span><span class="mi">19219</span><span class="p">)</span> <span class="k">return</span> <span class="s1">&#39;c&#39;</span><span class="p">;</span>
        <span class="k">if</span><span class="p">(</span><span class="nv">$asc</span><span class="o">&gt;=-</span><span class="mi">19218</span> <span class="o">&amp;&amp;</span> <span class="nv">$asc</span><span class="o">&lt;=-</span><span class="mi">18711</span><span class="p">)</span> <span class="k">return</span> <span class="s1">&#39;d&#39;</span><span class="p">;</span>
        <span class="k">if</span><span class="p">(</span><span class="nv">$asc</span><span class="o">&gt;=-</span><span class="mi">18710</span> <span class="o">&amp;&amp;</span> <span class="nv">$asc</span><span class="o">&lt;=-</span><span class="mi">18527</span><span class="p">)</span> <span class="k">return</span> <span class="s1">&#39;e&#39;</span><span class="p">;</span>
        <span class="k">if</span><span class="p">(</span><span class="nv">$asc</span><span class="o">&gt;=-</span><span class="mi">18526</span> <span class="o">&amp;&amp;</span> <span class="nv">$asc</span><span class="o">&lt;=-</span><span class="mi">18240</span><span class="p">)</span> <span class="k">return</span> <span class="s1">&#39;f&#39;</span><span class="p">;</span>
        <span class="k">if</span><span class="p">(</span><span class="nv">$asc</span><span class="o">&gt;=-</span><span class="mi">18239</span> <span class="o">&amp;&amp;</span> <span class="nv">$asc</span><span class="o">&lt;=-</span><span class="mi">17923</span><span class="p">)</span> <span class="k">return</span> <span class="s1">&#39;g&#39;</span><span class="p">;</span>
        <span class="k">if</span><span class="p">(</span><span class="nv">$asc</span><span class="o">&gt;=-</span><span class="mi">17922</span> <span class="o">&amp;&amp;</span> <span class="nv">$asc</span><span class="o">&lt;=-</span><span class="mi">17418</span><span class="p">)</span> <span class="k">return</span> <span class="s1">&#39;h&#39;</span><span class="p">;</span>
        <span class="k">if</span><span class="p">(</span><span class="nv">$asc</span><span class="o">&gt;=-</span><span class="mi">17417</span> <span class="o">&amp;&amp;</span> <span class="nv">$asc</span><span class="o">&lt;=-</span><span class="mi">16475</span><span class="p">)</span> <span class="k">return</span> <span class="s1">&#39;j&#39;</span><span class="p">;</span>
        <span class="k">if</span><span class="p">(</span><span class="nv">$asc</span><span class="o">&gt;=-</span><span class="mi">16474</span> <span class="o">&amp;&amp;</span> <span class="nv">$asc</span><span class="o">&lt;=-</span><span class="mi">16213</span><span class="p">)</span> <span class="k">return</span> <span class="s1">&#39;k&#39;</span><span class="p">;</span>
        <span class="k">if</span><span class="p">(</span><span class="nv">$asc</span><span class="o">&gt;=-</span><span class="mi">16212</span> <span class="o">&amp;&amp;</span> <span class="nv">$asc</span><span class="o">&lt;=-</span><span class="mi">15641</span><span class="p">)</span> <span class="k">return</span> <span class="s1">&#39;l&#39;</span><span class="p">;</span>
        <span class="k">if</span><span class="p">(</span><span class="nv">$asc</span><span class="o">&gt;=-</span><span class="mi">15640</span> <span class="o">&amp;&amp;</span> <span class="nv">$asc</span><span class="o">&lt;=-</span><span class="mi">15166</span><span class="p">)</span> <span class="k">return</span> <span class="s1">&#39;m&#39;</span><span class="p">;</span>
        <span class="k">if</span><span class="p">(</span><span class="nv">$asc</span><span class="o">&gt;=-</span><span class="mi">15165</span> <span class="o">&amp;&amp;</span> <span class="nv">$asc</span><span class="o">&lt;=-</span><span class="mi">14923</span><span class="p">)</span> <span class="k">return</span> <span class="s1">&#39;n&#39;</span><span class="p">;</span>
        <span class="k">if</span><span class="p">(</span><span class="nv">$asc</span><span class="o">&gt;=-</span><span class="mi">14922</span> <span class="o">&amp;&amp;</span> <span class="nv">$asc</span><span class="o">&lt;=-</span><span class="mi">14915</span><span class="p">)</span> <span class="k">return</span> <span class="s1">&#39;o&#39;</span><span class="p">;</span>
        <span class="k">if</span><span class="p">(</span><span class="nv">$asc</span><span class="o">&gt;=-</span><span class="mi">14914</span> <span class="o">&amp;&amp;</span> <span class="nv">$asc</span><span class="o">&lt;=-</span><span class="mi">14631</span><span class="p">)</span> <span class="k">return</span> <span class="s1">&#39;p&#39;</span><span class="p">;</span>
        <span class="k">if</span><span class="p">(</span><span class="nv">$asc</span><span class="o">&gt;=-</span><span class="mi">14630</span> <span class="o">&amp;&amp;</span> <span class="nv">$asc</span><span class="o">&lt;=-</span><span class="mi">14150</span><span class="p">)</span> <span class="k">return</span> <span class="s1">&#39;q&#39;</span><span class="p">;</span>
        <span class="k">if</span><span class="p">(</span><span class="nv">$asc</span><span class="o">&gt;=-</span><span class="mi">14149</span> <span class="o">&amp;&amp;</span> <span class="nv">$asc</span><span class="o">&lt;=-</span><span class="mi">14091</span><span class="p">)</span> <span class="k">return</span> <span class="s1">&#39;r&#39;</span><span class="p">;</span>
        <span class="k">if</span><span class="p">(</span><span class="nv">$asc</span><span class="o">&gt;=-</span><span class="mi">14090</span> <span class="o">&amp;&amp;</span> <span class="nv">$asc</span><span class="o">&lt;=-</span><span class="mi">13319</span><span class="p">)</span> <span class="k">return</span> <span class="s1">&#39;s&#39;</span><span class="p">;</span>
        <span class="k">if</span><span class="p">(</span><span class="nv">$asc</span><span class="o">&gt;=-</span><span class="mi">13318</span> <span class="o">&amp;&amp;</span> <span class="nv">$asc</span><span class="o">&lt;=-</span><span class="mi">12839</span><span class="p">)</span> <span class="k">return</span> <span class="s1">&#39;t&#39;</span><span class="p">;</span>
        <span class="k">if</span><span class="p">(</span><span class="nv">$asc</span><span class="o">&gt;=-</span><span class="mi">12838</span> <span class="o">&amp;&amp;</span> <span class="nv">$asc</span><span class="o">&lt;=-</span><span class="mi">12557</span><span class="p">)</span> <span class="k">return</span> <span class="s1">&#39;w&#39;</span><span class="p">;</span>
        <span class="k">if</span><span class="p">(</span><span class="nv">$asc</span><span class="o">&gt;=-</span><span class="mi">12556</span> <span class="o">&amp;&amp;</span> <span class="nv">$asc</span><span class="o">&lt;=-</span><span class="mi">11848</span><span class="p">)</span> <span class="k">return</span> <span class="s1">&#39;x&#39;</span><span class="p">;</span>
        <span class="k">if</span><span class="p">(</span><span class="nv">$asc</span><span class="o">&gt;=-</span><span class="mi">11847</span> <span class="o">&amp;&amp;</span> <span class="nv">$asc</span><span class="o">&lt;=-</span><span class="mi">11056</span><span class="p">)</span> <span class="k">return</span> <span class="s1">&#39;y&#39;</span><span class="p">;</span>
        <span class="k">if</span><span class="p">(</span><span class="nv">$asc</span><span class="o">&gt;=-</span><span class="mi">11055</span> <span class="o">&amp;&amp;</span> <span class="nv">$asc</span><span class="o">&lt;=-</span><span class="mi">10247</span><span class="p">)</span> <span class="k">return</span> <span class="s1">&#39;z&#39;</span><span class="p">;</span>
        <span class="k">return</span> <span class="k">false</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">static</span> <span class="k">function</span> <span class="nf">get_pinyin_array</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="k">static</span> <span class="nv">$pyArr</span><span class="p">;</span>
        <span class="k">if</span><span class="p">(</span><span class="nx">isset</span><span class="p">(</span><span class="nv">$pyArr</span><span class="p">))</span> <span class="k">return</span> <span class="nv">$pyArr</span><span class="p">;</span>

        <span class="nv">$kk</span> <span class="o">=</span> <span class="s1">&#39;a|ai|an|ang|ao|ba|bai|ban|bang|bao|bei|ben|beng|bi|bian|biao|bie|bin|bing|bo|bu|ca|cai|can|cang|cao|ce|ceng|cha|chai|chan|chang|chao|che|chen|cheng|chi|chong|chou|chu|chuai|chuan|chuang|chui|chun|chuo|ci|cong|cou|cu|cuan|cui|cun|cuo|da|dai|dan|dang|dao|de|deng|di|dian|diao|die|ding|diu|dong|dou|du|duan|dui|dun|duo|e|en|er|fa|fan|fang|fei|fen|feng|fo|fou|fu|ga|gai|gan|gang|gao|ge|gei|gen|geng|gong|gou|gu|gua|guai|guan|guang|gui|gun|guo|ha|hai|han|hang|hao|he|hei|hen|heng|hong|hou|hu|hua|huai|huan|huang|hui|hun|huo|ji|jia|jian|jiang|jiao|jie|jin|jing|jiong|jiu|ju|juan|jue|jun|ka|kai|kan|kang|kao|ke|ken|keng|kong|kou|ku|kua|kuai|kuan|kuang|kui|kun|kuo|la|lai|lan|lang|lao|le|lei|leng|li|lia|lian|liang|liao|lie|lin|ling|liu|long|lou|lu|lv|luan|lue|lun|luo|ma|mai|man|mang|mao|me|mei|men|meng|mi|mian|miao|mie|min|ming|miu|mo|mou|mu|na|nai|nan|nang|nao|ne|nei|nen|neng|ni|nian|niang|niao|nie|nin|ning|niu|nong|nu|nv|nuan|nue|nuo|o|ou|pa|pai|pan|pang|pao|pei|pen|peng|pi|pian|piao|pie|pin|ping|po|pu|qi|qia|qian|qiang|qiao|qie|qin|qing|qiong|qiu|qu|quan|que|qun|ran|rang|rao|re|ren|reng|ri|rong|rou|ru|ruan|rui|run|ruo|sa|sai|san|sang|sao|se|sen|seng|sha|shai|shan|shang|shao|she|shen|sheng|shi|shou|shu|shua|shuai|shuan|shuang|shui|shun|shuo|si|song|sou|su|suan|sui|sun|suo|ta|tai|tan|tang|tao|te|teng|ti|tian|tiao|tie|ting|tong|tou|tu|tuan|tui|tun|tuo|wa|wai|wan|wang|wei|wen|weng|wo|wu|xi|xia|xian|xiang|xiao|xie|xin|xing|xiong|xiu|xu|xuan|xue|xun|ya|yan|yang|yao|ye|yi|yin|ying|yo|yong|you|yu|yuan|yue|yun|za|zai|zan|zang|zao|ze|zei|zen|zeng|zha|zhai|zhan|zhang|zhao|zhe|zhen|zheng|zhi|zhong|zhou|zhu|zhua|zhuai|zhuan|zhuang|zhui|zhun|zhuo|zi|zong|zou|zu|zuan|zui|zun|zuo&#39;</span><span class="p">;</span>
        <span class="nv">$vv</span> <span class="o">=</span> <span class="s1">&#39;-20319|-20317|-20304|-20295|-20292|-20283|-20265|-20257|-20242|-20230|-20051|-20036|-20032|-20026|-20002|-19990|-19986|-19982|-19976|-19805|-19784|-19775|-19774|-19763|-19756|-19751|-19746|-19741|-19739|-19728|-19725|-19715|-19540|-19531|-19525|-19515|-19500|-19484|-19479|-19467|-19289|-19288|-19281|-19275|-19270|-19263|-19261|-19249|-19243|-19242|-19238|-19235|-19227|-19224|-19218|-19212|-19038|-19023|-19018|-19006|-19003|-18996|-18977|-18961|-18952|-18783|-18774|-18773|-18763|-18756|-18741|-18735|-18731|-18722|-18710|-18697|-18696|-18526|-18518|-18501|-18490|-18478|-18463|-18448|-18447|-18446|-18239|-18237|-18231|-18220|-18211|-18201|-18184|-18183|-18181|-18012|-17997|-17988|-17970|-17964|-17961|-17950|-17947|-17931|-17928|-17922|-17759|-17752|-17733|-17730|-17721|-17703|-17701|-17697|-17692|-17683|-17676|-17496|-17487|-17482|-17468|-17454|-17433|-17427|-17417|-17202|-17185|-16983|-16970|-16942|-16915|-16733|-16708|-16706|-16689|-16664|-16657|-16647|-16474|-16470|-16465|-16459|-16452|-16448|-16433|-16429|-16427|-16423|-16419|-16412|-16407|-16403|-16401|-16393|-16220|-16216|-16212|-16205|-16202|-16187|-16180|-16171|-16169|-16158|-16155|-15959|-15958|-15944|-15933|-15920|-15915|-15903|-15889|-15878|-15707|-15701|-15681|-15667|-15661|-15659|-15652|-15640|-15631|-15625|-15454|-15448|-15436|-15435|-15419|-15416|-15408|-15394|-15385|-15377|-15375|-15369|-15363|-15362|-15183|-15180|-15165|-15158|-15153|-15150|-15149|-15144|-15143|-15141|-15140|-15139|-15128|-15121|-15119|-15117|-15110|-15109|-14941|-14937|-14933|-14930|-14929|-14928|-14926|-14922|-14921|-14914|-14908|-14902|-14894|-14889|-14882|-14873|-14871|-14857|-14678|-14674|-14670|-14668|-14663|-14654|-14645|-14630|-14594|-14429|-14407|-14399|-14384|-14379|-14368|-14355|-14353|-14345|-14170|-14159|-14151|-14149|-14145|-14140|-14137|-14135|-14125|-14123|-14122|-14112|-14109|-14099|-14097|-14094|-14092|-14090|-14087|-14083|-13917|-13914|-13910|-13907|-13906|-13905|-13896|-13894|-13878|-13870|-13859|-13847|-13831|-13658|-13611|-13601|-13406|-13404|-13400|-13398|-13395|-13391|-13387|-13383|-13367|-13359|-13356|-13343|-13340|-13329|-13326|-13318|-13147|-13138|-13120|-13107|-13096|-13095|-13091|-13076|-13068|-13063|-13060|-12888|-12875|-12871|-12860|-12858|-12852|-12849|-12838|-12831|-12829|-12812|-12802|-12607|-12597|-12594|-12585|-12556|-12359|-12346|-12320|-12300|-12120|-12099|-12089|-12074|-12067|-12058|-12039|-11867|-11861|-11847|-11831|-11798|-11781|-11604|-11589|-11536|-11358|-11340|-11339|-11324|-11303|-11097|-11077|-11067|-11055|-11052|-11045|-11041|-11038|-11024|-11020|-11019|-11018|-11014|-10838|-10832|-10815|-10800|-10790|-10780|-10764|-10587|-10544|-10533|-10519|-10331|-10329|-10328|-10322|-10315|-10309|-10307|-10296|-10281|-10274|-10270|-10262|-10260|-10256|-10254&#39;</span><span class="p">;</span>
        <span class="nv">$key</span> <span class="o">=</span> <span class="nx">explode</span><span class="p">(</span><span class="s1">&#39;|&#39;</span><span class="p">,</span> <span class="nv">$kk</span><span class="p">);</span>
        <span class="nv">$val</span> <span class="o">=</span> <span class="nx">explode</span><span class="p">(</span><span class="s1">&#39;|&#39;</span><span class="p">,</span> <span class="nv">$vv</span><span class="p">);</span>
        <span class="nv">$pyArr</span> <span class="o">=</span> <span class="nx">array_combine</span><span class="p">(</span><span class="nv">$key</span><span class="p">,</span> <span class="nv">$val</span><span class="p">);</span>
        <span class="nx">arsort</span><span class="p">(</span><span class="nv">$pyArr</span><span class="p">);</span>

        <span class="k">return</span> <span class="nv">$pyArr</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="nx">define</span><span class="p">(</span><span class="s1">&#39;STOCKS_FILE&#39;</span><span class="p">,</span> <span class="nv">$_SERVER</span><span class="p">[</span><span class="s1">&#39;HOME&#39;</span><span class="p">]</span><span class="o">.</span><span class="s1">&#39;/.stocks&#39;</span><span class="p">);</span>

<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">file_exists</span><span class="p">(</span><span class="nx">STOCKS_FILE</span><span class="p">))</span> <span class="p">{</span>
    <span class="k">exit</span><span class="p">(</span><span class="s1">&#39;File not found: &#39;</span><span class="o">.</span><span class="nx">STOCKS_FILE</span><span class="p">);</span>
<span class="p">}</span>
<span class="nv">$stockCodeArr</span> <span class="o">=</span> <span class="nx">explode</span><span class="p">(</span><span class="s2">&#34;</span><span class="se">\n</span><span class="s2">&#34;</span><span class="p">,</span> <span class="nx">trim</span><span class="p">(</span><span class="nx">file_get_contents</span><span class="p">(</span><span class="nx">STOCKS_FILE</span><span class="p">)));</span>
<span class="k">if</span> <span class="p">(</span><span class="k">empty</span><span class="p">(</span><span class="nv">$stockCodeArr</span><span class="p">))</span> <span class="p">{</span>
    <span class="k">exit</span><span class="p">(</span><span class="s1">&#39;No stock code found.&#39;</span><span class="p">);</span>
<span class="p">}</span>

<span class="nv">$context</span> <span class="o">=</span> <span class="nx">stream_context_create</span><span class="p">(</span>
    <span class="p">[</span>
        <span class="s1">&#39;http&#39;</span><span class="o">=&gt;</span><span class="p">[</span>
            <span class="s1">&#39;method&#39;</span><span class="o">=&gt;</span><span class="s2">&#34;GET&#34;</span><span class="p">,</span>
            <span class="s1">&#39;timeout&#39;</span> <span class="o">=&gt;</span> <span class="mi">3</span>
        <span class="p">]</span>
    <span class="p">]</span>
<span class="p">);</span>
<span class="nv">$response</span> <span class="o">=</span> <span class="nx">file_get_contents</span><span class="p">(</span><span class="s2">&#34;http://hq.sinajs.cn/list=&#34;</span><span class="o">.</span><span class="nx">implode</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">,</span> <span class="nv">$stockCodeArr</span><span class="p">),</span> <span class="k">false</span><span class="p">,</span> <span class="nv">$context</span><span class="p">);</span>
<span class="k">if</span> <span class="p">(</span><span class="k">empty</span><span class="p">(</span><span class="nv">$response</span><span class="p">))</span> <span class="p">{</span>
    <span class="k">exit</span><span class="p">(</span><span class="s1">&#39;Failed fetching stock info with API.&#39;</span><span class="p">);</span>
<span class="p">}</span>

<span class="nv">$result</span> <span class="o">=</span> <span class="p">[];</span>
<span class="nv">$lines</span> <span class="o">=</span> <span class="nx">explode</span><span class="p">(</span><span class="s2">&#34;</span><span class="se">\n</span><span class="s2">&#34;</span><span class="p">,</span> <span class="nx">trim</span><span class="p">(</span><span class="nx">iconv</span><span class="p">(</span><span class="s1">&#39;gbk&#39;</span><span class="p">,</span> <span class="s1">&#39;utf-8&#39;</span><span class="p">,</span> <span class="nv">$response</span><span class="p">)));</span>
<span class="k">foreach</span> <span class="p">(</span><span class="nv">$lines</span> <span class="k">as</span> <span class="nv">$line</span><span class="p">)</span> <span class="p">{</span>
    <span class="nv">$matches</span> <span class="o">=</span> <span class="p">[];</span>
    <span class="nx">preg_match</span><span class="p">(</span><span class="s1">&#39;/&#34;.*&#34;/&#39;</span><span class="p">,</span> <span class="nv">$line</span><span class="p">,</span> <span class="nv">$matches</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$matches</span><span class="p">))</span> <span class="p">{</span>
        <span class="nv">$stock</span> <span class="o">=</span> <span class="nx">explode</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">,</span> <span class="nx">trim</span><span class="p">(</span><span class="nv">$matches</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;&#34;&#39;</span><span class="p">));</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">empty</span><span class="p">(</span><span class="nv">$stock</span><span class="p">))</span> <span class="p">{</span>
            <span class="nv">$result</span><span class="p">[]</span> <span class="o">=</span> <span class="nx">strtoupper</span><span class="p">(</span><span class="nx">PinYin</span><span class="o">::</span><span class="na">utf8To</span><span class="p">(</span><span class="nv">$stock</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="k">true</span><span class="p">))</span><span class="o">.</span><span class="s2">&#34;: </span><span class="si">{</span>$stock[3]<span class="si">}</span><span class="s2">, </span><span class="si">{</span>$stock[4]<span class="si">}</span><span class="s2">, </span><span class="si">{</span>$stock[5]<span class="si">}</span><span class="s2">&#34;</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
<span class="k">echo</span> <span class="nx">implode</span><span class="p">(</span><span class="s1">&#39;; &#39;</span><span class="p">,</span> <span class="nv">$result</span><span class="p">);</span>
</code></pre></td></tr></table>
</div>
</div><p>脚本从~/.stocks中读取股票代码：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-javascript" data-lang="javascript"><span class="nx">sh601985</span>
<span class="nx">sz002024</span>
</code></pre></td></tr></table>
</div>
</div>]]></description></item><item><title>自动重映射键盘</title><link>http://0x3f.org/post/auto-remap-keyboard/</link><pubDate>Fri, 17 Apr 2015 18:02:00 +0000</pubDate><author>作者</author><guid>http://0x3f.org/post/auto-remap-keyboard/</guid><description><![CDATA[<p>每次键盘拔出再插入时，键盘映射都会失效，要重新执行映射，而且要对不同的键盘应用不同的映射方案。试过直接添加udev规则，即使指定X Display和Xauthority也不成功。所以用pyudev写个脚本（<a href="https://github.com/xbot/shell/blob/master/udev.py" target="_blank" rel="noopener noreffer">最新版本</a>）：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span><span class="lnt">77
</span><span class="lnt">78
</span><span class="lnt">79
</span><span class="lnt">80
</span><span class="lnt">81
</span><span class="lnt">82
</span><span class="lnt">83
</span><span class="lnt">84
</span><span class="lnt">85
</span><span class="lnt">86
</span><span class="lnt">87
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"><span class="ch">#!/usr/bin/env python2</span>
<span class="c1"># encoding: utf-8</span>

<span class="s2">&#34;&#34;&#34;
</span><span class="s2">File:        udev.py
</span><span class="s2">Description: udev monitor script.
</span><span class="s2">Author:      Donie Leigh
</span><span class="s2">Email:       donie.leigh at gmail.com
</span><span class="s2">&#34;&#34;&#34;</span>

<span class="kn">import</span> <span class="nn">glib</span><span class="o">,</span> <span class="nn">os</span><span class="o">,</span> <span class="nn">time</span>
<span class="kn">from</span> <span class="nn">pyudev</span> <span class="kn">import</span> <span class="n">Context</span><span class="p">,</span> <span class="n">Monitor</span>

<span class="n">PID_FILE</span> <span class="o">=</span> <span class="s2">&#34;/tmp/udev_monitor.pid&#34;</span>

<span class="k">def</span> <span class="nf">remap_pokerii</span><span class="p">(</span><span class="n">device</span><span class="p">):</span>
    <span class="s2">&#34;&#34;&#34; Do keyboard remapping when PokerII is plugged in.
</span><span class="s2">    &#34;&#34;&#34;</span>
    <span class="k">if</span> <span class="n">device</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;ID_VENDOR_ID&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;0f39&#39;</span> \
            <span class="ow">and</span> <span class="n">device</span><span class="o">.</span><span class="n">action</span> <span class="o">==</span> <span class="s1">&#39;add&#39;</span><span class="p">:</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s1">&#39;setxkbmap&#39;</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s1">&#39;xmodmap ~/.Xmodmap&#39;</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">remap_filco</span><span class="p">(</span><span class="n">device</span><span class="p">):</span>
    <span class="s2">&#34;&#34;&#34; Do keyboard remapping when Filco is plugged in.
</span><span class="s2">    &#34;&#34;&#34;</span>
    <span class="k">if</span> <span class="n">device</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;ID_VENDOR_ID&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;04d9&#39;</span> \
            <span class="ow">and</span> <span class="n">device</span><span class="o">.</span><span class="n">action</span> <span class="o">==</span> <span class="s1">&#39;add&#39;</span><span class="p">:</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s1">&#39;setxkbmap&#39;</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s1">&#39;xmodmap ~/.Xmodmap&#39;</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">is_pid_running</span><span class="p">(</span><span class="n">pid</span><span class="p">):</span>
    <span class="s2">&#34;&#34;&#34; Check if the given pid is running.
</span><span class="s2">    :pid: int
</span><span class="s2">    :returns: bool
</span><span class="s2">    &#34;&#34;&#34;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">os</span><span class="o">.</span><span class="n">kill</span><span class="p">(</span><span class="n">pid</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">OSError</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">False</span>
    <span class="k">return</span> <span class="bp">True</span>

<span class="k">def</span> <span class="nf">write_pid_or_die</span><span class="p">():</span>
    <span class="s2">&#34;&#34;&#34; Write the current pid into pid file or exists if there is already a instance running.
</span><span class="s2">    :returns: void
</span><span class="s2">    &#34;&#34;&#34;</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">PID_FILE</span><span class="p">):</span>
        <span class="n">pid</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">open</span><span class="p">(</span><span class="n">PID_FILE</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>
        <span class="k">if</span> <span class="n">is_pid_running</span><span class="p">(</span><span class="n">pid</span><span class="p">):</span>
            <span class="k">print</span><span class="p">(</span><span class="s2">&#34;Process {0} is still running.&#34;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">pid</span><span class="p">))</span>
            <span class="k">raise</span> <span class="ne">SystemExit</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">PID_FILE</span><span class="p">)</span>

    <span class="nb">open</span><span class="p">(</span><span class="n">PID_FILE</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getpid</span><span class="p">()))</span>

<span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="kn">from</span> <span class="nn">pyudev.glib</span> <span class="kn">import</span> <span class="n">MonitorObserver</span>
        <span class="k">def</span> <span class="nf">device_event</span><span class="p">(</span><span class="n">observer</span><span class="p">,</span> <span class="n">device</span><span class="p">):</span>
            <span class="n">remap_pokerii</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
            <span class="n">remap_filco</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="kn">from</span> <span class="nn">pyudev.glib</span> <span class="kn">import</span> <span class="n">GUDevMonitorObserver</span> <span class="k">as</span> <span class="n">MonitorObserver</span>
        <span class="k">def</span> <span class="nf">device_event</span><span class="p">(</span><span class="n">observer</span><span class="p">,</span> <span class="n">action</span><span class="p">,</span> <span class="n">device</span><span class="p">):</span>
            <span class="n">remap_pokerii</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
            <span class="n">remap_filco</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>

    <span class="n">context</span> <span class="o">=</span> <span class="n">Context</span><span class="p">()</span>
    <span class="n">monitor</span> <span class="o">=</span> <span class="n">Monitor</span><span class="o">.</span><span class="n">from_netlink</span><span class="p">(</span><span class="n">context</span><span class="p">)</span>

    <span class="n">monitor</span><span class="o">.</span><span class="n">filter_by</span><span class="p">(</span><span class="n">subsystem</span><span class="o">=</span><span class="s1">&#39;usb&#39;</span><span class="p">)</span>
    <span class="n">observer</span> <span class="o">=</span> <span class="n">MonitorObserver</span><span class="p">(</span><span class="n">monitor</span><span class="p">)</span>

    <span class="n">observer</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="s1">&#39;device-event&#39;</span><span class="p">,</span> <span class="n">device_event</span><span class="p">)</span>
    <span class="n">monitor</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>

    <span class="n">glib</span><span class="o">.</span><span class="n">MainLoop</span><span class="p">()</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">write_pid_or_die</span><span class="p">()</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">main</span><span class="p">()</span>
    <span class="k">except</span> <span class="ne">KeyboardInterrupt</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s2">&#34;Game over.&#34;</span><span class="p">)</span>
</code></pre></td></tr></table>
</div>
</div><p>有个坑，监测到键盘插入事件后要等一秒再应用映射，否则不成功。</p>
<p>这里只用了设备的Vendor ID，可以直接用lsusb看。看更多的设备属性的命令如下：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash"><span class="c1"># 监视设备变动</span>
udevadm monitor --environment --udev

<span class="c1"># 查看设备属性</span>
udevadm info -a -n <span class="o">[</span>device name<span class="o">]</span>

<span class="c1"># 查看文件所属设备的属性</span>
udevadm info -a -p <span class="o">[</span>file name<span class="o">]</span>
</code></pre></td></tr></table>
</div>
</div>]]></description></item><item><title>再次调整磁盘分区</title><link>http://0x3f.org/post/adjust-disk-partitions-again/</link><pubDate>Fri, 03 Apr 2015 14:44:00 +0000</pubDate><author>作者</author><guid>http://0x3f.org/post/adjust-disk-partitions-again/</guid><description><![CDATA[<p>自从<a href="/post/adjust-disk-partitions-in-archlinux/" rel="">上次</a>调整磁盘分区，一直把根目录和主目录分别挂在一个物理分区下，即使系统挂了或者换发行版也不影响主目录。最近根分区很紧张，干脆把两个分区合并了。</p>
<p>先用UNetBootin安装Puppy Linux到U盘，需要手工修改U盘里的syslinux.cfg，把“pmedia=<strong>cd</strong>”改成“pmedia=<strong>usbflash</strong>”，然后用U盘启动。</p>
<p>把主目录的内容完整复制到移动硬盘：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash"><span class="c1"># 挂载主目录</span>
mkdir /mnt/oldhome
mount -t ext4 /dev/sda2 /mnt/oldhome

<span class="c1"># 挂载移动硬盘</span>
mkdir /mnt/bakdisk
mount -t ext4 /dev/sdc1 /mnt/bakdisk

<span class="c1"># 复制主目录</span>
cp -a /mnt/oldhome /mnt/bakdisk/

<span class="c1"># 取消挂载主目录</span>
umount /mnt/oldhome
</code></pre></td></tr></table>
</div>
</div><p>用gparted删除主目录分区，合并到根分区。然后恢复主目录：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash"><span class="c1"># 挂载根分区</span>
mkdir /mnt/newroot
mount -t ext4 /dev/sda1 /mnt/newroot

<span class="c1"># 恢复主目录</span>
cp -a /mnt/bakdisk/* /mnt/newroot/

<span class="c1"># 修改fstab，取消主目录的挂载</span>
vim /mnt/newroot/etc/fstab

<span class="c1"># 取消挂载</span>
umount /mnt/bakdisk
umount /mnt/newroot
</code></pre></td></tr></table>
</div>
</div>]]></description></item><item><title>ZSH下新安装的程序无法自动补全的解决方法</title><link>http://0x3f.org/post/how-to-auto-complete-newly-installed-command-in-zsh/</link><pubDate>Wed, 12 Nov 2014 22:15:00 +0000</pubDate><author>作者</author><guid>http://0x3f.org/post/how-to-auto-complete-newly-installed-command-in-zsh/</guid><description><![CDATA[<p>Zsh默认开启了对PATH变量的缓存，这是导致新安装的程序无法立即使用自动补全的原因。</p>
<p>其实只要PATH变量不太复杂，安装的程序不太多，完全没必要开启缓存，实际上我把缓存关掉后完全没有感觉到补全的速度有什么变化。</p>
<p>方法如下，在.zshrc中增加一行：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash">zstyle <span class="s1">&#39;:completion:*&#39;</span> rehash <span class="nb">true</span>
</code></pre></td></tr></table>
</div>
</div><p>也可以在必要的时间手工执行命令<strong>rehash</strong>，也是个临时解决方法。</p>
]]></description></item><item><title>使用lsyncd同步文件</title><link>http://0x3f.org/post/live-syncing-daemon/</link><pubDate>Wed, 18 Jun 2014 14:03:00 +0000</pubDate><author>作者</author><guid>http://0x3f.org/post/live-syncing-daemon/</guid><description><![CDATA[<p>lsyncd全称“Live Syncing Daemon”，是Linux下的文件自动同步工具，同时支持SSH、rsync的实现方式。相对于rsync+inotify，它速度更快，也更稳定。</p>
<p>对于SSH的方式，需要目标机器中已启动SSHD，并把源机器上的公钥加到目标机器root用户的authorized_keys中，私钥应放在源机器上运行lsyncd的用户的.ssh目录中，密钥放错了用户，会导致无法同步。</p>
<p>然后就是在源机器上创建配置文件，lsyncd的配置文件是个lua脚本：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-lua" data-lang="lua"><span class="n">settings</span><span class="p">{</span>
    <span class="n">pidfile</span> <span class="o">=</span> <span class="s2">&#34;/var/log/lsyncd/lsyncd.pid&#34;</span><span class="p">,</span>
    <span class="n">logfile</span> <span class="o">=</span> <span class="s2">&#34;/var/log/lsyncd/lsyncd.log&#34;</span><span class="p">,</span>
    <span class="n">statusFile</span> <span class="o">=</span> <span class="s2">&#34;/var/log/lsyncd/lsyncd-status.log&#34;</span><span class="p">,</span>
    <span class="n">statusInterval</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
    <span class="n">maxDelays</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
    <span class="c1">-- nodaemon = true,</span>
<span class="p">}</span>

<span class="n">sync</span><span class="p">{</span>
    <span class="n">default.rsyncssh</span><span class="p">,</span>
    <span class="n">source</span> <span class="o">=</span> <span class="s2">&#34;/home/monk/workspace&#34;</span><span class="p">,</span>
    <span class="n">host</span> <span class="o">=</span> <span class="s2">&#34;192.168.1.3&#34;</span><span class="p">,</span>
    <span class="n">targetdir</span> <span class="o">=</span> <span class="s2">&#34;/var/www/workspace&#34;</span><span class="p">,</span>
    <span class="n">exclude</span><span class="o">=</span><span class="p">{</span> <span class="s2">&#34;.*&#34;</span><span class="p">,</span> <span class="s2">&#34;*.tmp&#34;</span> <span class="p">},</span>
    <span class="n">rsync</span> <span class="o">=</span> <span class="p">{</span>
        <span class="n">compress</span> <span class="o">=</span> <span class="kc">false</span><span class="p">,</span>
        <span class="n">_extra</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&#34;--bwlimit=50000&#34;</span><span class="p">},</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>然后启动lsyncd：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash">sudo lsyncd /etc/lsyncd.conf
</code></pre></td></tr></table>
</div>
</div>]]></description></item><item><title>使用存取控制表在Linux用户间共享文件</title><link>http://0x3f.org/post/share-file-using-access-control-lists/</link><pubDate>Wed, 19 Mar 2014 22:38:00 +0000</pubDate><author>作者</author><guid>http://0x3f.org/post/share-file-using-access-control-lists/</guid><description><![CDATA[<p>我用Dropbox在两台电脑间同步个人维基数据，将数据目录从Web Server下软连接到Dropbox里，而对Dropbox目录的备份实际上只包含那个软连接，没有内容，结果当把备份拷贝到另一台电脑上并打开Dropbox后，维基数据被清空了！我积累多年的笔记差一点儿完蛋，幸亏单独备份过维基。然后改将维基数据放到Dropbox里，然后软连接到Web Server下，新问题出现了，Web Server是以http身份运行的，对用户主目录没有权限，当然也不能访问主目录下的Dropbox目录。</p>
<p>最简单的办法是将主目录、Dropbox、维基目录的权限全部设成777，显然，这样做太不安全。另一种方法是把Dropbox用NFS输出，然后挂载到Web Server下，这么做太蛋疼。最合适的解决方案是Access Control List（存取控制表），它可以为文件和目录设置具体到单个用户或用户组的存取权限，实现像Windows下的文件（目录）共享权限设置那样的效果，而且比后者更强大、灵活。</p>
<p>使用ACL首先需要目录的挂载选项中包含acl，不过一般缺省都包含这一项。</p>
<p>ACL包含两个命令：getfacl和setfacl，前者用来查看目录或文件的存取控制表，后者用来操作它。</p>
<p>首先，把维基目录的所有者改成http，并设置目录权限为770：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash">chown -R http:http ~/Dropbox/wiki
chmod -R <span class="m">770</span> ~/Dropbox/wiki
</code></pre></td></tr></table>
</div>
</div><p>这时Web Server还是不能访问维基目录，使用getfacl查看用户主目录的ACL：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash">getfacl ~
</code></pre></td></tr></table>
</div>
</div><p>显示结果如下：</p>
<blockquote>
<p>getfacl: Removing leading &lsquo;/&rsquo; from absolute path names<br>
# file: home/taoqi<br>
# owner: taoqi<br>
# group: users<br>
user::rwx<br>
user:root:&ndash;x<br>
group::&mdash;<br>
mask::&ndash;x<br>
other::&mdash;</p>
</blockquote>
<p>显然，要给http用户访问该目录的权限：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash">setfacl -m u:http:x ~
</code></pre></td></tr></table>
</div>
</div><p>再查看ACL，发现增加了一条：</p>
<blockquote>
<p>user:http:&ndash;x</p>
</blockquote>
<p>同理，给Dropbox目录也加上这一条规则之后，Web Server就可以访问维基数据目录了。</p>
]]></description></item></channel></rss>