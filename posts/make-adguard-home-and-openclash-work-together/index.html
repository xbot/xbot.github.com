<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta property="og:title" content="让 AdGuard Home 和 OpenClash 协同工作"><meta property="og:description" content="家庭网络环境 使用 OpenWrt （以下简称 OP ）做旁路网关 OP 内建 OpenClash （以下简称 OC ）访问不存在的网站 OP 内建 WireGuard （以下简称 WG ）做内网穿透 使用 AdGuard Home （以下简称 AH ）做内网 DNS 和广告过滤 之前遇到的问题 不管怎样配置，内网和 WG 下的内网主机名解析和科学上网这 4 种场景总有至少一个不工作。
期间创建过一个虚拟机做独立的 WG Server ，内建 SmartDNS （以下简称 SD ）做 AH 的上游，其它场景工作得很好，只是无法通过旁路网关访问不存在的网站。
解决方法 首先如果要正常使用 OC ，就必须使用它的 DNS 解析。
同时，又要达到使用 AH 做内网主机名解析和广告过滤的目的，所以要把 OC 设成 AH 的唯一上游。
然后最棘手的问题来了。如果把 AH 设成 dnsmasq 的上游， WG 下不能解析内网主机名。如果把 AH 设成监听 53 端口，则内网无法解析主机名。
想到之前在独立的 WG Server 上用 SD 在两种场景下都可以正常解析，就试着用它代替 dnsmasq ，结果柳暗花明，所以场景都跑通了。"><meta property="og:type" content="article"><meta property="og:url" content="http://0x3f.org/posts/make-adguard-home-and-openclash-work-together/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2022-03-06T12:12:10+08:00"><meta property="article:modified_time" content="2022-03-06T12:12:10+08:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="让 AdGuard Home 和 OpenClash 协同工作"><meta name=twitter:description content="家庭网络环境 使用 OpenWrt （以下简称 OP ）做旁路网关 OP 内建 OpenClash （以下简称 OC ）访问不存在的网站 OP 内建 WireGuard （以下简称 WG ）做内网穿透 使用 AdGuard Home （以下简称 AH ）做内网 DNS 和广告过滤 之前遇到的问题 不管怎样配置，内网和 WG 下的内网主机名解析和科学上网这 4 种场景总有至少一个不工作。
期间创建过一个虚拟机做独立的 WG Server ，内建 SmartDNS （以下简称 SD ）做 AH 的上游，其它场景工作得很好，只是无法通过旁路网关访问不存在的网站。
解决方法 首先如果要正常使用 OC ，就必须使用它的 DNS 解析。
同时，又要达到使用 AH 做内网主机名解析和广告过滤的目的，所以要把 OC 设成 AH 的唯一上游。
然后最棘手的问题来了。如果把 AH 设成 dnsmasq 的上游， WG 下不能解析内网主机名。如果把 AH 设成监听 53 端口，则内网无法解析主机名。
想到之前在独立的 WG Server 上用 SD 在两种场景下都可以正常解析，就试着用它代替 dnsmasq ，结果柳暗花明，所以场景都跑通了。"><script type=application/javascript>var doNotTrack=!1;doNotTrack||(function(e,t,n,s,o,i,a){e.GoogleAnalyticsObject=o,e[o]=e[o]||function(){(e[o].q=e[o].q||[]).push(arguments)},e[o].l=1*new Date,i=t.createElement(n),a=t.getElementsByTagName(n)[0],i.async=1,i.src=s,a.parentNode.insertBefore(i,a)}(window,document,"script","https://www.google-analytics.com/analytics.js","ga"),ga("create","UA-93233020-1","auto"),ga("send","pageview"))</script><meta name=theme-color media="(prefers-color-scheme: light)" content="#ffffff"><meta name=theme-color media="(prefers-color-scheme: dark)" content="#262d33"><title>晴耕雨讀 - 让 AdGuard Home 和 OpenClash 协同工作</title><link rel="shortcut icon" href=/favicon.ico type=image/x-icon><link rel=preconnect href=https://fonts.googleapis.com><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@400;500;600;700&display=swap" rel=stylesheet><link rel=stylesheet href=/minima.1666195048.css><script defer type=text/javascript src=/minima.1666195048.js></script></head><script>let theme_2b_used=window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light";try{if(!("theme"in localStorage)){const e="";(e==="dark"||e==="light")&&(theme_2b_used=e),localStorage.theme=theme_2b_used}document.querySelector("html").classList.add(localStorage.theme)}catch(e){console.error(e)}</script><body class="sm:mx-5 sm:my-0"><header class="flex justify-between items-center mb-6 sm:my-3"><div class="flex items-center"><div id=theme-switcher class="text-4xl cursor-pointer">🌚</div></div><nav class="flex items-center
whitespace-nowrap overflow-x-auto overflow-y-hidden"><a class=ml-5 href=/>主頁</a>
<a class=ml-5 href=/posts>文章</a>
<a class=ml-5 href=/tags>標籤</a>
<a class=ml-5 href=/categories>分類</a>
<a class=ml-5 href=/about>關於</a></nav></header><h1 class="mt-6 mb-6">让 AdGuard Home 和 OpenClash 协同工作</h1><div class="mb-3 text-xs flex justify-between sm:flex-col"><div>Posted at &mdash; Mar 06, 2022</div><div class=sm:mt-4><a class=not-first:ml-3 href=/tags/OpenWrt>#OpenWrt</a>
<a class=not-first:ml-3 href=/tags/WireGuard>#WireGuard</a>
<a class=not-first:ml-3 href=/tags/OpenClash>#OpenClash</a>
<a class=not-first:ml-3 href=/tags/%e7%bf%bb%e5%a2%99>#翻墙</a>
<a class=not-first:ml-3 href=/tags/HomeLab>#HomeLab</a>
<a class=not-first:ml-3 href=/tags/AdGuard>#AdGuard</a></div></div><main><p></p><article class=md><h1 id=家庭网络环境>家庭网络环境</h1><ul><li>使用 OpenWrt （<em>以下简称 OP</em> ）做旁路网关</li><li>OP 内建 OpenClash （<em>以下简称 OC</em> ）访问不存在的网站</li><li>OP 内建 WireGuard （<em>以下简称 WG</em> ）做内网穿透</li><li>使用 AdGuard Home （<em>以下简称 AH</em> ）做内网 DNS 和广告过滤</li></ul><h1 id=之前遇到的问题>之前遇到的问题</h1><p>不管怎样配置，内网和 WG 下的内网主机名解析和科学上网这 4 种场景总有至少一个不工作。</p><p>期间创建过一个虚拟机做独立的 WG Server ，内建 SmartDNS （<em>以下简称 SD</em> ）做 AH 的上游，其它场景工作得很好，只是无法通过旁路网关访问不存在的网站。</p><h1 id=解决方法>解决方法</h1><p>首先如果要正常使用 OC ，就必须使用它的 DNS 解析。</p><p>同时，又要达到使用 AH 做内网主机名解析和广告过滤的目的，所以要把 OC 设成 AH 的唯一上游。</p><p>然后最棘手的问题来了。如果把 AH 设成 dnsmasq 的上游， WG 下不能解析内网主机名。如果把 AH 设成监听 53 端口，则内网无法解析主机名。</p><p>想到之前在独立的 WG Server 上用 SD 在两种场景下都可以正常解析，就试着用它代替 dnsmasq ，结果柳暗花明，所以场景都跑通了。</p><h1 id=遗留的问题>遗留的问题</h1><ol><li>OP 内置的 AH 在监听 53 端口时，为什么内网无法通过它解析？（<em>与 SD 一样，监听的是“:::53”</em>）</li><li>OP 内置的 AH 作为 dnsmasq 的上游时，为什么内网可以解析而 WG 不能？</li></ol></article></main><script>const repo="xbot/blog-comments",issueTerm="pathname",theme=localStorage.theme?`github-${localStorage.theme}`:"preferred-color-scheme",script=document.createElement("script");script.src="https://utteranc.es/client.js",script.async=!0,script.crossOrigin="anonymous",script.setAttribute("repo",repo),script.setAttribute("issue-term",issueTerm),script.setAttribute("theme",theme),script.setAttribute("label","comment"),document.querySelector("main").appendChild(script)</script><footer class="mt-8 flex sm:flex-col-reverse justify-between items-center"><p class="mt-0 text-sm">© 淘气 2022 |
<a href=https://gohugo.io target=_blank rel="noopener noreferrer">Hugo</a> on
<a href=https://github.com/mivinci/hugo-theme-minima target=_blank rel="noopener noreferrer">Minima</a></p><p class="flex items-center mt-0"><a class="icon mx-2" href=https://github.com/xbot title=github><svg fill="#63636f" width="18" role="img" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><title>GitHub</title><path d="M12 .297c-6.63.0-12 5.373-12 12 0 5.303 3.438 9.8 8.205 11.385.6.113.82-.258.82-.577.0-.285-.01-1.04-.015-2.04-3.338.724-4.042-1.61-4.042-1.61C4.422 18.07 3.633 17.7 3.633 17.7c-1.087-.744.084-.729.084-.729 1.205.084 1.838 1.236 1.838 1.236 1.07 1.835 2.809 1.305 3.495.998.108-.776.417-1.305.76-1.605-2.665-.3-5.466-1.332-5.466-5.93.0-1.31.465-2.38 1.235-3.22-.135-.303-.54-1.523.105-3.176.0.0 1.005-.322 3.3 1.23.96-.267 1.98-.399 3-.405 1.02.006 2.04.138 3 .405 2.28-1.552 3.285-1.23 3.285-1.23.645 1.653.24 2.873.12 3.176.765.84 1.23 1.91 1.23 3.22.0 4.61-2.805 5.625-5.475 5.92.42.36.81 1.096.81 2.22.0 1.606-.015 2.896-.015 3.286.0.315.21.69.825.57C20.565 22.092 24 17.592 24 12.297c0-6.627-5.373-12-12-12"/></svg></a><a class="icon mx-2" href=/index.xml title=rss><svg fill="#63636f" t="1626591563876" viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" p-id="1984" width="18" height="16"><path d="M128 768a128 128 0 100 256 128 128 0 000-256zM0 368v176c265.104.0 480 214.912 480 480h176c0-362.32-293.696-656-656-656zM0 0v176c468.336.0 848 379.664 848 848h176C1024 458.464 565.536.0.0.0z" p-id="1985"/></svg></a></p></footer></body></html>