<!doctype html><html lang=en><head><meta charset=UTF-8><meta name=viewport content="width=device-width,initial-scale=1"><meta property="og:url" content="http://0x3f.org/posts/flamework-active-record/"><meta property="og:site_name" content="晴耕雨讀"><meta property="og:title" content="PHP框架实战（五）：ORM与ActiveRecord"><meta property="og:description" content="简述 Model是MVC框架中最复杂的部分，它要提供与业务逻辑相关的数据及数据处理方法的封装，一般要提供数据对象、数据库连接、事务管理、SQL语句构造、数据CRUD、高级通用业务逻辑等一系列功能。由于Model与Controller和View是解耦的，并且本身具备很高的通用性和复杂性，所以有很多独立的实现。本文希望能通过开发一个简单的ActiveRecord，验证这种Model实现方案的原理和过程。
ORM：对象关系映射 ORM的全称是Object Relational Mapping，即对象关系映射。它是为了解决关系数据库的数学模型和编程语言的对象模型之间的阻抗不匹配问题而提出的解决方案。
阻抗不匹配是个逼格很高的词。
阻抗是指电路中的电容、电感、电阻对交流电的障碍作用，就像电阻对直流电的障碍作用。两个系统传递信号可以形象地看成电压的传递，公式为：
U(out) * Z(in)
U(in) = ————————–
Z(in) + Z(out)
即输入电压等于输出电压与输入阻抗的积除以输入阻抗与输出阻抗的和。
理想情况肯定是输入电压等于输出电压，这时信号是没有失真的，也就是要求Z(in)与Z(in)+Z(out)之商无限逼近1，这个过程就叫阻抗匹配。关系型数据库是建立在数学模型的基础上，而编程语言中的对象是建立在人对客观世界认知的具象模型上。说白了，阻抗不匹配问题就是说因这两种模型不一致而导致的问题。
ORM通过建立表与对象、列与属性（这只是一般情况）之间的映射关系而解决问题，这可以实现像操作对象一样对数据库中的数据进行增删改查，简化了开发过程。不过ORM的缺点是不能很好地处理复杂数据关系，会出现效率低下的问题，因此必要时仍然需要直接使用SQL。
ActiveRecord ActiveRecord是Ruby on Rails提出的一个概念，其实就是ORM的一种实现，它是对象类型、数据、CRUD方法的合体，使对数据的操作以更具象化的方式实现。下面介绍在Flamework中实现一个简单的ActiveRecord的过程。
首先实现数据库的接口，提供数据库连接、查询、执行SQL语句、事务管理等基本功能。这里使用PDO实现：
1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 131 132 133 134 <?php namespace org\x3f\flamework\base; /** * Database connection above PDO * * @author Donie Leigh <donie.leigh@gmail.com> * @link http://0x3f.org * @copyright Copyright &amp;copy; 2013-2014 Donie Leigh * @license BSD (3-terms) * @since 1.0 */ class DBConnection { /** * @var PDO Database connection * @since 1.0 */ private $_c; /** * @var array PDO options * @since 1.0 */ private $_options = array( 'connection_string' => 'sqlite::memory:', 'username' => null, 'password' => null, 'pdo_options' => null, ); /** * @var PDOStatement Last PDO statement * @since 1.0 */ private $_lastStmt; public function __construct($options) { $this->_options = array_merge($this->_options, $options); } /** * Init DB connection * @param string $dsn DB connection string * @param string $user DB user name * @param string $password DB password * @param array $options PDO options * @return void * @since 1.0 */ private function _connectDB($dsn, $user='', $password='', $options=array()) { if ($this->_c == null) { $this->_c = new \PDO($dsn, $user, $password, $options); } } /** * Execute sql statement * @param mixed $sql SQL statement or template * @param array $params Parameters for SQL template * @return bool * @since 1.0 */ public function execute($sql, $params=array()) { $this->_connectDB( $this->_options['connection_string'], $this->_options['username'], $this->_options['password'], $this->_options['driver_options'] ); $stmt = $this->_c->prepare($sql); $this->_lastStmt = $stmt; return $stmt->execute($params); } /** * Fetch rows * @return array Associative array holding data rows * @since 1.0 */ public function rows($sql, $params=array()) { $this->execute($sql, $params); $stmt = $this->getLastStmt(); $rows = array(); while ($row = $stmt->fetch(\PDO::FETCH_ASSOC)) { $rows[] = $row; } return $rows; } /** * Return the last PDO statement * @return PDOStatement * @since 1.0 */ public function getLastStmt() { return $this->_lastStmt; } /** * Begin transaction * @return void * @since 1.0 */ public function beginTransaction() { $this->_c->beginTransaction(); } /** * Commit the current transaction * @return void * @since 1.0 */ public function commit() { $this->_c->commit(); } /** * Rollback the current transaction * @return void * @since 1.0 */ public function rollback() { $this->_c->rollBack(); } } ?> 然后实现ActiveRecord类："><meta property="og:locale" content="zh_cn"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2014-01-01T20:45:00+00:00"><meta property="article:modified_time" content="2014-01-01T20:45:00+00:00"><meta property="article:tag" content="PHP"><meta property="article:tag" content="Flamework"><meta property="article:tag" content="框架"><meta property="article:tag" content="编程"><meta property="article:tag" content="计算机"><meta name=twitter:card content="summary"><meta name=twitter:title content="PHP框架实战（五）：ORM与ActiveRecord"><meta name=twitter:description content="简述 Model是MVC框架中最复杂的部分，它要提供与业务逻辑相关的数据及数据处理方法的封装，一般要提供数据对象、数据库连接、事务管理、SQL语句构造、数据CRUD、高级通用业务逻辑等一系列功能。由于Model与Controller和View是解耦的，并且本身具备很高的通用性和复杂性，所以有很多独立的实现。本文希望能通过开发一个简单的ActiveRecord，验证这种Model实现方案的原理和过程。
ORM：对象关系映射 ORM的全称是Object Relational Mapping，即对象关系映射。它是为了解决关系数据库的数学模型和编程语言的对象模型之间的阻抗不匹配问题而提出的解决方案。
阻抗不匹配是个逼格很高的词。
阻抗是指电路中的电容、电感、电阻对交流电的障碍作用，就像电阻对直流电的障碍作用。两个系统传递信号可以形象地看成电压的传递，公式为：
U(out) * Z(in)
U(in) = ————————–
Z(in) + Z(out)
即输入电压等于输出电压与输入阻抗的积除以输入阻抗与输出阻抗的和。
理想情况肯定是输入电压等于输出电压，这时信号是没有失真的，也就是要求Z(in)与Z(in)+Z(out)之商无限逼近1，这个过程就叫阻抗匹配。关系型数据库是建立在数学模型的基础上，而编程语言中的对象是建立在人对客观世界认知的具象模型上。说白了，阻抗不匹配问题就是说因这两种模型不一致而导致的问题。
ORM通过建立表与对象、列与属性（这只是一般情况）之间的映射关系而解决问题，这可以实现像操作对象一样对数据库中的数据进行增删改查，简化了开发过程。不过ORM的缺点是不能很好地处理复杂数据关系，会出现效率低下的问题，因此必要时仍然需要直接使用SQL。
ActiveRecord ActiveRecord是Ruby on Rails提出的一个概念，其实就是ORM的一种实现，它是对象类型、数据、CRUD方法的合体，使对数据的操作以更具象化的方式实现。下面介绍在Flamework中实现一个简单的ActiveRecord的过程。
首先实现数据库的接口，提供数据库连接、查询、执行SQL语句、事务管理等基本功能。这里使用PDO实现：
1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 131 132 133 134 <?php namespace org\x3f\flamework\base; /** * Database connection above PDO * * @author Donie Leigh <donie.leigh@gmail.com> * @link http://0x3f.org * @copyright Copyright &amp;copy; 2013-2014 Donie Leigh * @license BSD (3-terms) * @since 1.0 */ class DBConnection { /** * @var PDO Database connection * @since 1.0 */ private $_c; /** * @var array PDO options * @since 1.0 */ private $_options = array( 'connection_string' => 'sqlite::memory:', 'username' => null, 'password' => null, 'pdo_options' => null, ); /** * @var PDOStatement Last PDO statement * @since 1.0 */ private $_lastStmt; public function __construct($options) { $this->_options = array_merge($this->_options, $options); } /** * Init DB connection * @param string $dsn DB connection string * @param string $user DB user name * @param string $password DB password * @param array $options PDO options * @return void * @since 1.0 */ private function _connectDB($dsn, $user='', $password='', $options=array()) { if ($this->_c == null) { $this->_c = new \PDO($dsn, $user, $password, $options); } } /** * Execute sql statement * @param mixed $sql SQL statement or template * @param array $params Parameters for SQL template * @return bool * @since 1.0 */ public function execute($sql, $params=array()) { $this->_connectDB( $this->_options['connection_string'], $this->_options['username'], $this->_options['password'], $this->_options['driver_options'] ); $stmt = $this->_c->prepare($sql); $this->_lastStmt = $stmt; return $stmt->execute($params); } /** * Fetch rows * @return array Associative array holding data rows * @since 1.0 */ public function rows($sql, $params=array()) { $this->execute($sql, $params); $stmt = $this->getLastStmt(); $rows = array(); while ($row = $stmt->fetch(\PDO::FETCH_ASSOC)) { $rows[] = $row; } return $rows; } /** * Return the last PDO statement * @return PDOStatement * @since 1.0 */ public function getLastStmt() { return $this->_lastStmt; } /** * Begin transaction * @return void * @since 1.0 */ public function beginTransaction() { $this->_c->beginTransaction(); } /** * Commit the current transaction * @return void * @since 1.0 */ public function commit() { $this->_c->commit(); } /** * Rollback the current transaction * @return void * @since 1.0 */ public function rollback() { $this->_c->rollBack(); } } ?> 然后实现ActiveRecord类："><meta name=theme-color media="(prefers-color-scheme: light)" content="#ffffff"><meta name=theme-color media="(prefers-color-scheme: dark)" content="#181818"><title>晴耕雨讀 - PHP框架实战（五）：ORM与ActiveRecord
</title><link rel="shortcut icon" href=/favicon.ico type=image/x-icon><link rel=stylesheet href=/minima.91848781a7679600f0ad1ad577e7da4fbb28b9f3fdc9a82126197659405bb483.css integrity="sha256-kYSHgadnlgDwrRrVd+faT7soufP9yaghJhl2WUBbtIM="><script defer type=text/javascript src=/minima.5f772103e807a34ef8ab63c3c53905fbf70689fa70d121085c7d0e84087effea.js integrity="sha256-X3chA+gHo074q2PDxTkF+/cGifpw0SEIXH0OhAh+/+o="></script></head><script>const theme_config="system",theme_light=theme_config==="system"?"light":theme_config;let theme=window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":theme_light;console.debug(theme);try{localStorage.setItem("theme",theme),window.minima_theme=theme,document.querySelector("html").classList.add(theme)}catch(e){console.error(e)}</script><body><header class="mt-3 mb-8"><div class="container mx-auto"><nav class="flex justify-between items-center"><div class="flex items-center"><div id=theme-switch class="text-2xl cursor-pointer">🌝</div></div><ul class="flex items-center text-base font-semibold
whitespace-nowrap overflow-x-auto overflow-y-hidden"><li class="ml-2 mr-2"><a href=/>首页</a></li><li class="ml-2 mr-2"><a href=/posts>文章</a></li><li class="ml-2 mr-2"><a href=/tags>标签</a></li><li class="ml-2 mr-2"><a href=/about>关于</a></li><li class="ml-2 mr-2"><a href=/search>🔍</a></li></ul></nav></div></header><main class="container mx-auto"><h1 class="text-4xl font-extrabold mt-6">搜索</h1><p class="text-sm mb-6">Powered by <a href=https://fusejs.io target=_blank>fuse.js</a>.</p><div class=search><input class=mb-4 autofocus autocomplete=off id=search-input type=search placeholder="输入关键词 ↵"><ul id=search-result></ul></div></main><footer class="mt-8 mb-8"><div class="container mx-auto"><div class="mt-8 flex flex-col-reverse sm:flex-row sm:justify-between items-center"><div class="text-center sm:text-left"><p class="mt-0 text-sm">© 2007-2024 鬼马妖刀</p><p class="mt-0 text-xs">Built with <a href=https://gohugo.io target=_blank rel="noopener noreferrer">Hugo</a> v0.146.3
and <a href=https://github.com/mivinci/hugo-theme-minima target=_blank rel="noopener noreferrer">Minima</a></p></div><p class="flex items-center mt-0"><a class="icon ml-1 mr-1" href=mailto:donie.leigh@gmail.com title=email><svg width="18" height="18" viewBox="0 0 24 21" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 4h16c1.1.0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1.0-2-.9-2-2V6c0-1.1.9-2 2-2z"/><path d="M22 6l-10 7L2 6"/></svg>
</a><a class="icon ml-1 mr-1" href=https://github.com/xbot title=github><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">stroke-linecap="round" stroke-linejoin="round"><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37.0 00-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44.0 0020 4.77 5.07 5.07.0 0019.91 1S18.73.65 16 2.48a13.38 13.38.0 00-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07.0 005 4.77 5.44 5.44.0 003.5 8.55c0 5.42 3.3 6.61 6.44 7A3.37 3.37.0 009 18.13V22"/></svg>
</a><a class="icon ml-1 mr-1" href=/index.xml title=rss><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 11a9 9 0 019 9M4 4a16 16 0 0116 16"/><circle cx="5" cy="19" r="1"/></svg></a></p></div></div></footer></body></html>