<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta property="og:title" content="Laravel Horizon 简介"><meta property="og:description" content="简介 Horizon 针对 Laravel 的 Redis 队列，增加了可视化、进程池等特性。
特性 可视化仪表板 Worker 进程池的维护和调度 词汇表 master supervisor: 主进程，通过 proc_open() 启动 supervisor 子进程。 environments: 可以按 APP_ENV 针对不同环境创建多套配置。 supervisors: Horizon 自己的进程池概念，与托管后台进程的软件 Supervisor 没有关系。 workers: 队列消费者进程，每个 supervisor 中包含多个 worker。 负载均衡策略 false 一个 supervisor 下的所有 worker 全部用于按队列名称的顺序逐个队列消费任务。
simple 一个 supervisor 下的所有 worker 被平均分配给每个队列。
auto 一个 supervisor 下空闲的 worker 会被优先分配给负载最高的队列。同时保证空闲队列有配置项 minProcesses 数量的 worker 待命。
超时提醒 如果一个队列执行任务的时间超过预先配置的时间限制，horizon 将终止该任务并可以通过短信、邮件或 Slack 发送通知。
Horizon 每分钟查询一次执行任务的时间超过配置值的队列：
每 5 分钟发送一次通知：
吞吐量和平均耗时统计 需要通过定时任务周期性执行 artisan horizon:snapshot 命令生成统计数据并存储到 Redis 中。"><meta property="og:type" content="article"><meta property="og:url" content="http://0x3f.org/posts/an-introduction-of-laravel-horizon/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2022-08-06T20:22:36+08:00"><meta property="article:modified_time" content="2022-08-06T20:22:36+08:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="Laravel Horizon 简介"><meta name=twitter:description content="简介 Horizon 针对 Laravel 的 Redis 队列，增加了可视化、进程池等特性。
特性 可视化仪表板 Worker 进程池的维护和调度 词汇表 master supervisor: 主进程，通过 proc_open() 启动 supervisor 子进程。 environments: 可以按 APP_ENV 针对不同环境创建多套配置。 supervisors: Horizon 自己的进程池概念，与托管后台进程的软件 Supervisor 没有关系。 workers: 队列消费者进程，每个 supervisor 中包含多个 worker。 负载均衡策略 false 一个 supervisor 下的所有 worker 全部用于按队列名称的顺序逐个队列消费任务。
simple 一个 supervisor 下的所有 worker 被平均分配给每个队列。
auto 一个 supervisor 下空闲的 worker 会被优先分配给负载最高的队列。同时保证空闲队列有配置项 minProcesses 数量的 worker 待命。
超时提醒 如果一个队列执行任务的时间超过预先配置的时间限制，horizon 将终止该任务并可以通过短信、邮件或 Slack 发送通知。
Horizon 每分钟查询一次执行任务的时间超过配置值的队列：
每 5 分钟发送一次通知：
吞吐量和平均耗时统计 需要通过定时任务周期性执行 artisan horizon:snapshot 命令生成统计数据并存储到 Redis 中。"><script type=application/javascript>var doNotTrack=!1;doNotTrack||(function(e,t,n,s,o,i,a){e.GoogleAnalyticsObject=o,e[o]=e[o]||function(){(e[o].q=e[o].q||[]).push(arguments)},e[o].l=1*new Date,i=t.createElement(n),a=t.getElementsByTagName(n)[0],i.async=1,i.src=s,a.parentNode.insertBefore(i,a)}(window,document,"script","https://www.google-analytics.com/analytics.js","ga"),ga("create","UA-93233020-1","auto"),ga("send","pageview"))</script><meta name=theme-color media="(prefers-color-scheme: light)" content="#ffffff"><meta name=theme-color media="(prefers-color-scheme: dark)" content="#262d33"><title>晴耕雨讀 - Laravel Horizon 简介</title><link rel="shortcut icon" href=/favicon.ico type=image/x-icon><link rel=preconnect href=https://fonts.googleapis.com><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@400;500;600;700&display=swap" rel=stylesheet><link rel=stylesheet href=/minima.1692610202.css><script defer type=text/javascript src=/minima.1692610202.js></script></head><script>let theme_2b_used=window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light";try{if(!("theme"in localStorage)){const e="";(e==="dark"||e==="light")&&(theme_2b_used=e),localStorage.theme=theme_2b_used}document.querySelector("html").classList.add(localStorage.theme)}catch(e){console.error(e)}</script><body class="sm:mx-5 sm:my-0"><header class="flex justify-between items-center mb-6 sm:my-3"><div class="flex items-center"><div id=theme-switcher class="text-4xl cursor-pointer">🌚</div></div><nav class="flex items-center
whitespace-nowrap overflow-x-auto overflow-y-hidden"><a class=ml-5 href=/>主頁</a>
<a class=ml-5 href=/posts>文章</a>
<a class=ml-5 href=/tags>標籤</a>
<a class=ml-5 href=/categories>分類</a>
<a class=ml-5 href=/about>關於</a></nav></header><h1 class="mt-6 mb-6">Laravel Horizon 简介</h1><div class="mb-3 text-xs flex justify-between sm:flex-col"><div>Posted at &mdash; Aug 06, 2022</div><div class=sm:mt-4><a class=not-first:ml-3 href=/tags/%e7%bc%96%e7%a8%8b>#编程</a>
<a class=not-first:ml-3 href=/tags/Laravel>#Laravel</a>
<a class=not-first:ml-3 href=/tags/PHP>#PHP</a></div></div><main><p></p><article class=md><h2 id=简介>简介</h2><p>Horizon 针对 Laravel 的 Redis 队列，增加了可视化、进程池等特性。</p><h2 id=特性>特性</h2><h3 id=可视化仪表板>可视化仪表板</h3><p><img src=https://raw.githubusercontent.com/xbot/image-hosting/master/blog/2022-08-06-20-27-48-xu94E4.jpg alt=2022-08-06-20-27-48-xu94E4></p><h3 id=worker-进程池的维护和调度>Worker 进程池的维护和调度</h3><h4 id=词汇表>词汇表</h4><ul><li>master supervisor: 主进程，通过 <code>proc_open()</code> 启动 supervisor 子进程。</li><li>environments: 可以按 <code>APP_ENV</code> 针对不同环境创建多套配置。</li><li>supervisors: Horizon 自己的进程池概念，与托管后台进程的软件 Supervisor 没有关系。</li><li>workers: 队列消费者进程，每个 supervisor 中包含多个 worker。</li></ul><h4 id=负载均衡策略>负载均衡策略</h4><h5 id=false>false</h5><p>一个 supervisor 下的所有 worker 全部用于按队列名称的顺序逐个队列消费任务。</p><h5 id=simple>simple</h5><p>一个 supervisor 下的所有 worker 被平均分配给每个队列。</p><h5 id=auto>auto</h5><p>一个 supervisor 下空闲的 worker 会被优先分配给负载最高的队列。同时保证空闲队列有配置项 minProcesses 数量的 worker 待命。</p><h3 id=超时提醒>超时提醒</h3><p>如果一个队列执行任务的时间超过预先配置的时间限制，horizon 将终止该任务并可以通过短信、邮件或 Slack 发送通知。</p><p>Horizon 每分钟查询一次执行任务的时间超过配置值的队列：</p><p><img src=https://raw.githubusercontent.com/xbot/image-hosting/master/blog/2022-08-06-20-30-29-t2RJyM.jpg alt=2022-08-06-20-30-29-t2RJyM></p><p>每 5 分钟发送一次通知：</p><p><img src=https://raw.githubusercontent.com/xbot/image-hosting/master/blog/2022-08-06-20-31-03-USbLPG.jpg alt=2022-08-06-20-31-03-USbLPG></p><h3 id=吞吐量和平均耗时统计>吞吐量和平均耗时统计</h3><p>需要通过定时任务周期性执行 <code>artisan horizon:snapshot</code> 命令生成统计数据并存储到 Redis 中。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=line><span class=cl><span class=nv>$schedule</span><span class=o>-&gt;</span><span class=na>command</span><span class=p>(</span><span class=s1>&#39;horizon:snapshot&#39;</span><span class=p>)</span><span class=o>-&gt;</span><span class=na>everyFiveMinutes</span><span class=p>()</span>
</span></span></code></pre></td></tr></table></div></div><p>按 Job 查看统计图表：</p><p><img src=https://raw.githubusercontent.com/xbot/image-hosting/master/blog/2022-08-06-20-31-30-lW3rbM.jpg alt=2022-08-06-20-31-30-lW3rbM></p><h3 id=标签>标签</h3><p>如果任务中包含了 Eloquent model, Horizon 会自动使用这个 model 的 ID 给任务打标签。也可以通过覆盖 tags() 方法自己定义：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=line><span class=cl><span class=k>public</span> <span class=k>function</span> <span class=nf>tags</span><span class=p>()</span><span class=o>:</span> <span class=k>array</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=p>[</span><span class=s1>&#39;tests&#39;</span><span class=p>,</span> <span class=s1>&#39;test:&#39;</span> <span class=o>.</span> <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>id</span><span class=p>];</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>通过标签监控和查看任务的执行情况：</p><p><img src=https://raw.githubusercontent.com/xbot/image-hosting/master/blog/2022-08-06-20-31-59-9fuSot.jpg alt=2022-08-06-20-31-59-9fuSot></p><h2 id=问题>问题</h2><h3 id=horizon-不消费队列>Horizon 不消费队列</h3><h4 id=问题的表现>问题的表现</h4><ul><li><code>artisan horizon</code> 启动后不消费队列</li><li>dashboard 中看不到 supervisor-1
<img src=https://raw.githubusercontent.com/xbot/image-hosting/master/blog/2022-08-06-20-32-36-suv4Se.jpg alt=2022-08-06-20-32-36-suv4Se></li><li><code>artisan horizon:list</code> 可以看到 supervisor-1
<img src=https://raw.githubusercontent.com/xbot/image-hosting/master/blog/2022-08-06-20-34-22-Rkz4kE.jpg alt=2022-08-06-20-34-22-Rkz4kE></li><li><code>artisan horizon:supervisors</code> 查不到 supervisor-1
<img src=https://raw.githubusercontent.com/xbot/image-hosting/master/blog/2022-08-06-20-35-05-2s5FVk.jpg alt=2022-08-06-20-35-05-2s5FVk></li><li>Redis 中 Horizon 的元数据存储在两个目录中
<img src=https://raw.githubusercontent.com/xbot/image-hosting/master/blog/2022-08-06-20-35-32-lfcXqI.jpg alt=2022-08-06-20-35-32-lfcXqI></li></ul><h3 id=原因>原因</h3><p>Laravel 在 <code>.env</code> 之外会根据 <code>APP_ENV</code> 加载对应环境的 dotenv 文件：</p><p><img src=https://raw.githubusercontent.com/xbot/image-hosting/master/blog/2022-08-06-20-35-56-fWubbM.jpg alt=2022-08-06-20-35-56-fWubbM></p><p>Horizon 先启动 master 进程，之后 master 启动 supervisor 进程。</p><p>在 master 启动时，由于 <code>.env</code> 文件还没有被加载，所以 <code>APP_ENV</code> 为空，导致 <code>.env.local</code> 没有被加载。由于 <code>.env</code> 中没有设置 <code>APP_NAME</code> ，所以 Horizon 在取 prefix 的时候得到了默认值 <code>laravel</code> 。</p><p>在 supervisor 进程被启动时，由于 master 进程已经加载了 <code>.env</code> 文件，所以 <code>.env.local</code> 被加载。由于 <code>.env.local</code> 中设置了 <code>APP_NAME</code> ，所以 Horizon 在取 prefix 的时候得到了配置值 <code>retail</code> 。</p><p>所以 master 进程的元数据被存储到 <code>laravel_horizon</code> 下，supervisor 进程的元数据被存储到 <code>retail_horizon</code> 下。</p><h3 id=解决>解决</h3><ul><li>.env 中设置 APP_NAME</li><li><code>artisan horizon --env local</code></li></ul></article></main><script>const repo="xbot/blog-comments",issueTerm="pathname",theme=localStorage.theme?`github-${localStorage.theme}`:"preferred-color-scheme",script=document.createElement("script");script.src="https://utteranc.es/client.js",script.async=!0,script.crossOrigin="anonymous",script.setAttribute("repo",repo),script.setAttribute("issue-term",issueTerm),script.setAttribute("theme",theme),script.setAttribute("label","comment"),document.querySelector("main").appendChild(script)</script><footer class="mt-8 flex sm:flex-col-reverse justify-between items-center"><p class="mt-0 text-sm">© 淘气 2022 |
<a href=https://gohugo.io target=_blank rel="noopener noreferrer">Hugo</a> on
<a href=https://github.com/mivinci/hugo-theme-minima target=_blank rel="noopener noreferrer">Minima</a></p><p class="flex items-center mt-0"><a class="icon mx-2" href=https://github.com/xbot title=github><svg fill="#63636f" width="18" role="img" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><title>GitHub</title><path d="M12 .297c-6.63.0-12 5.373-12 12 0 5.303 3.438 9.8 8.205 11.385.6.113.82-.258.82-.577.0-.285-.01-1.04-.015-2.04-3.338.724-4.042-1.61-4.042-1.61C4.422 18.07 3.633 17.7 3.633 17.7c-1.087-.744.084-.729.084-.729 1.205.084 1.838 1.236 1.838 1.236 1.07 1.835 2.809 1.305 3.495.998.108-.776.417-1.305.76-1.605-2.665-.3-5.466-1.332-5.466-5.93.0-1.31.465-2.38 1.235-3.22-.135-.303-.54-1.523.105-3.176.0.0 1.005-.322 3.3 1.23.96-.267 1.98-.399 3-.405 1.02.006 2.04.138 3 .405 2.28-1.552 3.285-1.23 3.285-1.23.645 1.653.24 2.873.12 3.176.765.84 1.23 1.91 1.23 3.22.0 4.61-2.805 5.625-5.475 5.92.42.36.81 1.096.81 2.22.0 1.606-.015 2.896-.015 3.286.0.315.21.69.825.57C20.565 22.092 24 17.592 24 12.297c0-6.627-5.373-12-12-12"/></svg></a><a class="icon mx-2" href=/index.xml title=rss><svg fill="#63636f" t="1626591563876" viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" p-id="1984" width="18" height="16"><path d="M128 768a128 128 0 100 256 128 128 0 000-256zM0 368v176c265.104.0 480 214.912 480 480h176c0-362.32-293.696-656-656-656zM0 0v176c468.336.0 848 379.664 848 848h176C1024 458.464 565.536.0.0.0z" p-id="1985"/></svg></a></p></footer></body></html>