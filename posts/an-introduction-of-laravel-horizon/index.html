<!doctype html><html lang=en><head><meta charset=UTF-8><meta name=viewport content="width=device-width,initial-scale=1"><meta property="og:url" content="http://0x3f.org/posts/an-introduction-of-laravel-horizon/"><meta property="og:site_name" content="晴耕雨讀"><meta property="og:title" content="Laravel Horizon 简介"><meta property="og:description" content="简介 Horizon 针对 Laravel 的 Redis 队列，增加了可视化、进程池等特性。
特性 可视化仪表板 Worker 进程池的维护和调度 词汇表 master supervisor: 主进程，通过 proc_open() 启动 supervisor 子进程。 environments: 可以按 APP_ENV 针对不同环境创建多套配置。 supervisors: Horizon 自己的进程池概念，与托管后台进程的软件 Supervisor 没有关系。 workers: 队列消费者进程，每个 supervisor 中包含多个 worker。 负载均衡策略 false 一个 supervisor 下的所有 worker 全部用于按队列名称的顺序逐个队列消费任务。
simple 一个 supervisor 下的所有 worker 被平均分配给每个队列。
auto 一个 supervisor 下空闲的 worker 会被优先分配给负载最高的队列。同时保证空闲队列有配置项 minProcesses 数量的 worker 待命。
超时提醒 如果一个队列执行任务的时间超过预先配置的时间限制，horizon 将终止该任务并可以通过短信、邮件或 Slack 发送通知。
Horizon 每分钟查询一次执行任务的时间超过配置值的队列：
每 5 分钟发送一次通知：
吞吐量和平均耗时统计 需要通过定时任务周期性执行 artisan horizon:snapshot 命令生成统计数据并存储到 Redis 中。"><meta property="og:locale" content="zh_cn"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2022-08-06T20:22:36+08:00"><meta property="article:modified_time" content="2022-08-06T20:22:36+08:00"><meta property="article:tag" content="编程"><meta property="article:tag" content="Laravel"><meta property="article:tag" content="PHP"><meta property="article:tag" content="计算机"><meta name=twitter:card content="summary"><meta name=twitter:title content="Laravel Horizon 简介"><meta name=twitter:description content="简介 Horizon 针对 Laravel 的 Redis 队列，增加了可视化、进程池等特性。
特性 可视化仪表板 Worker 进程池的维护和调度 词汇表 master supervisor: 主进程，通过 proc_open() 启动 supervisor 子进程。 environments: 可以按 APP_ENV 针对不同环境创建多套配置。 supervisors: Horizon 自己的进程池概念，与托管后台进程的软件 Supervisor 没有关系。 workers: 队列消费者进程，每个 supervisor 中包含多个 worker。 负载均衡策略 false 一个 supervisor 下的所有 worker 全部用于按队列名称的顺序逐个队列消费任务。
simple 一个 supervisor 下的所有 worker 被平均分配给每个队列。
auto 一个 supervisor 下空闲的 worker 会被优先分配给负载最高的队列。同时保证空闲队列有配置项 minProcesses 数量的 worker 待命。
超时提醒 如果一个队列执行任务的时间超过预先配置的时间限制，horizon 将终止该任务并可以通过短信、邮件或 Slack 发送通知。
Horizon 每分钟查询一次执行任务的时间超过配置值的队列：
每 5 分钟发送一次通知：
吞吐量和平均耗时统计 需要通过定时任务周期性执行 artisan horizon:snapshot 命令生成统计数据并存储到 Redis 中。"><meta name=theme-color media="(prefers-color-scheme: light)" content="#ffffff"><meta name=theme-color media="(prefers-color-scheme: dark)" content="#181818"><title>晴耕雨讀 - Laravel Horizon 简介
</title><link rel="shortcut icon" href=/favicon.ico type=image/x-icon><link rel=stylesheet href=/minima.91848781a7679600f0ad1ad577e7da4fbb28b9f3fdc9a82126197659405bb483.css integrity="sha256-kYSHgadnlgDwrRrVd+faT7soufP9yaghJhl2WUBbtIM="><script defer type=text/javascript src=/minima.5f772103e807a34ef8ab63c3c53905fbf70689fa70d121085c7d0e84087effea.js integrity="sha256-X3chA+gHo074q2PDxTkF+/cGifpw0SEIXH0OhAh+/+o="></script></head><script>const theme_config="system",theme_light=theme_config==="system"?"light":theme_config;let theme=window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":theme_light;console.debug(theme);try{localStorage.setItem("theme",theme),window.minima_theme=theme,document.querySelector("html").classList.add(theme)}catch(e){console.error(e)}</script><body><header class="mt-3 mb-8"><div class="container mx-auto"><nav class="flex justify-between items-center"><div class="flex items-center"><div id=theme-switch class="text-2xl cursor-pointer">🌝</div></div><ul class="flex items-center text-base font-semibold
whitespace-nowrap overflow-x-auto overflow-y-hidden"><li class="ml-2 mr-2"><a href=/>首页</a></li><li class="ml-2 mr-2"><a href=/posts>文章</a></li><li class="ml-2 mr-2"><a href=/tags>标签</a></li><li class="ml-2 mr-2"><a href=/about>关于</a></li><li class="ml-2 mr-2"><a href=/search>🔍</a></li></ul></nav></div></header><div class="container mx-auto"><h1 class="text-4xl font-extrabold mt-6 mb-6">Laravel Horizon 简介</h1><div class="mb-3 text-sm flex justify-between"><div>发布于 &mdash; 2022 年 08 月 06 日</div><div><a class=ml-1 href=/tags/%e7%bc%96%e7%a8%8b>#编程</a>
<a class=ml-1 href=/tags/Laravel>#Laravel</a>
<a class=ml-1 href=/tags/PHP>#PHP</a>
<a class=ml-1 href=/tags/%e8%ae%a1%e7%ae%97%e6%9c%ba>#计算机</a></div></div><main class=mb-8><p></p><article class=md><h2 id=简介>简介</h2><p>Horizon 针对 Laravel 的 Redis 队列，增加了可视化、进程池等特性。</p><h2 id=特性>特性</h2><h3 id=可视化仪表板>可视化仪表板</h3><p><img src=https://raw.githubusercontent.com/xbot/image-hosting/master/blog/2022-08-06-20-27-48-xu94E4.jpg alt=2022-08-06-20-27-48-xu94E4></p><h3 id=worker-进程池的维护和调度>Worker 进程池的维护和调度</h3><h4 id=词汇表>词汇表</h4><ul><li>master supervisor: 主进程，通过 <code>proc_open()</code> 启动 supervisor 子进程。</li><li>environments: 可以按 <code>APP_ENV</code> 针对不同环境创建多套配置。</li><li>supervisors: Horizon 自己的进程池概念，与托管后台进程的软件 Supervisor 没有关系。</li><li>workers: 队列消费者进程，每个 supervisor 中包含多个 worker。</li></ul><h4 id=负载均衡策略>负载均衡策略</h4><h5 id=false>false</h5><p>一个 supervisor 下的所有 worker 全部用于按队列名称的顺序逐个队列消费任务。</p><h5 id=simple>simple</h5><p>一个 supervisor 下的所有 worker 被平均分配给每个队列。</p><h5 id=auto>auto</h5><p>一个 supervisor 下空闲的 worker 会被优先分配给负载最高的队列。同时保证空闲队列有配置项 minProcesses 数量的 worker 待命。</p><h3 id=超时提醒>超时提醒</h3><p>如果一个队列执行任务的时间超过预先配置的时间限制，horizon 将终止该任务并可以通过短信、邮件或 Slack 发送通知。</p><p>Horizon 每分钟查询一次执行任务的时间超过配置值的队列：</p><p><img src=https://raw.githubusercontent.com/xbot/image-hosting/master/blog/2022-08-06-20-30-29-t2RJyM.jpg alt=2022-08-06-20-30-29-t2RJyM></p><p>每 5 分钟发送一次通知：</p><p><img src=https://raw.githubusercontent.com/xbot/image-hosting/master/blog/2022-08-06-20-31-03-USbLPG.jpg alt=2022-08-06-20-31-03-USbLPG></p><h3 id=吞吐量和平均耗时统计>吞吐量和平均耗时统计</h3><p>需要通过定时任务周期性执行 <code>artisan horizon:snapshot</code> 命令生成统计数据并存储到 Redis 中。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=line><span class=cl><span class=nv>$schedule</span><span class=o>-&gt;</span><span class=na>command</span><span class=p>(</span><span class=s1>&#39;horizon:snapshot&#39;</span><span class=p>)</span><span class=o>-&gt;</span><span class=na>everyFiveMinutes</span><span class=p>()</span>
</span></span></code></pre></td></tr></table></div></div><p>按 Job 查看统计图表：</p><p><img src=https://raw.githubusercontent.com/xbot/image-hosting/master/blog/2022-08-06-20-31-30-lW3rbM.jpg alt=2022-08-06-20-31-30-lW3rbM></p><h3 id=标签>标签</h3><p>如果任务中包含了 Eloquent model, Horizon 会自动使用这个 model 的 ID 给任务打标签。也可以通过覆盖 tags() 方法自己定义：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=line><span class=cl><span class=k>public</span> <span class=k>function</span> <span class=nf>tags</span><span class=p>()</span><span class=o>:</span> <span class=k>array</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=p>[</span><span class=s1>&#39;tests&#39;</span><span class=p>,</span> <span class=s1>&#39;test:&#39;</span> <span class=o>.</span> <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>id</span><span class=p>];</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>通过标签监控和查看任务的执行情况：</p><p><img src=https://raw.githubusercontent.com/xbot/image-hosting/master/blog/2022-08-06-20-31-59-9fuSot.jpg alt=2022-08-06-20-31-59-9fuSot></p><h2 id=问题>问题</h2><h3 id=horizon-不消费队列>Horizon 不消费队列</h3><h4 id=问题的表现>问题的表现</h4><ul><li><code>artisan horizon</code> 启动后不消费队列</li><li>dashboard 中看不到 supervisor-1
<img src=https://raw.githubusercontent.com/xbot/image-hosting/master/blog/2022-08-06-20-32-36-suv4Se.jpg alt=2022-08-06-20-32-36-suv4Se></li><li><code>artisan horizon:list</code> 可以看到 supervisor-1
<img src=https://raw.githubusercontent.com/xbot/image-hosting/master/blog/2022-08-06-20-34-22-Rkz4kE.jpg alt=2022-08-06-20-34-22-Rkz4kE></li><li><code>artisan horizon:supervisors</code> 查不到 supervisor-1
<img src=https://raw.githubusercontent.com/xbot/image-hosting/master/blog/2022-08-06-20-35-05-2s5FVk.jpg alt=2022-08-06-20-35-05-2s5FVk></li><li>Redis 中 Horizon 的元数据存储在两个目录中
<img src=https://raw.githubusercontent.com/xbot/image-hosting/master/blog/2022-08-06-20-35-32-lfcXqI.jpg alt=2022-08-06-20-35-32-lfcXqI></li></ul><h3 id=原因>原因</h3><p>Laravel 在 <code>.env</code> 之外会根据 <code>APP_ENV</code> 加载对应环境的 dotenv 文件：</p><p><img src=https://raw.githubusercontent.com/xbot/image-hosting/master/blog/2022-08-06-20-35-56-fWubbM.jpg alt=2022-08-06-20-35-56-fWubbM></p><p>Horizon 先启动 master 进程，之后 master 启动 supervisor 进程。</p><p>在 master 启动时，由于 <code>.env</code> 文件还没有被加载，所以 <code>APP_ENV</code> 为空，导致 <code>.env.local</code> 没有被加载。由于 <code>.env</code> 中没有设置 <code>APP_NAME</code> ，所以 Horizon 在取 prefix 的时候得到了默认值 <code>laravel</code> 。</p><p>在 supervisor 进程被启动时，由于 master 进程已经加载了 <code>.env</code> 文件，所以 <code>.env.local</code> 被加载。由于 <code>.env.local</code> 中设置了 <code>APP_NAME</code> ，所以 Horizon 在取 prefix 的时候得到了配置值 <code>retail</code> 。</p><p>所以 master 进程的元数据被存储到 <code>laravel_horizon</code> 下，supervisor 进程的元数据被存储到 <code>retail_horizon</code> 下。</p><h3 id=解决>解决</h3><ul><li>.env 中设置 APP_NAME</li><li><code>artisan horizon --env local</code></li></ul></article></main><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.13.11/dist/katex.min.css integrity=sha384-Um5gpz1odJg5Z4HAmzPtgZKdTBHZdw8S29IecapCSB31ligYPhHQZMIlWLYQGVoc crossorigin=anonymous><script defer src=https://cdn.jsdelivr.net/npm/katex@0.13.11/dist/katex.min.js integrity=sha384-YNHdsYkH6gMx9y3mRkmcJ2mFUjTd0qNQQvY9VYZgQd7DcN7env35GzlmFaZ23JGp crossorigin=anonymous></script><script defer src=https://cdn.jsdelivr.net/npm/katex@0.13.11/dist/contrib/auto-render.min.js integrity=sha384-vZTG03m+2yp6N6BNi5iM4rW4oIwk5DfcNdFfxkk9ZWpDriOkXX8voJBFrAO7MpVl crossorigin=anonymous></script><script>document.addEventListener("DOMContentLoaded",function(){renderMathInElement(document.body,{delimiters:[{left:"$$",right:"$$",display:!0},{left:"$",right:"$",display:!1},{left:"\\(",right:"\\)",display:!1},{left:"\\[",right:"\\]",display:!0}],throwOnError:!1})})</script><script src=https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js crossorigin=anonymous></script><script>mermaid.init(void 0,"code.language-mermaid")</script><div id=comment></div><script>const s=document.createElement("script");s.src="https://utteranc.es/client.js",s.crossOrigin="anonymous",s.async=!0,s.setAttribute("repo","xbot/blog-comments"),s.setAttribute("issue-term","pathname"),s.setAttribute("label","comment"),s.setAttribute("theme","github-"+window.minima_theme),document.getElementById("comment").appendChild(s)</script></div><footer class="mt-8 mb-8"><div class="container mx-auto"><div class="mt-8 flex flex-col-reverse sm:flex-row sm:justify-between items-center"><div class="text-center sm:text-left"><p class="mt-0 text-sm">© 2007-2024 鬼马妖刀</p><p class="mt-0 text-xs">Built with <a href=https://gohugo.io target=_blank rel="noopener noreferrer">Hugo</a> v0.140.1
and <a href=https://github.com/mivinci/hugo-theme-minima target=_blank rel="noopener noreferrer">Minima</a></p></div><p class="flex items-center mt-0"><a class="icon ml-1 mr-1" href=mailto:donie.leigh@gmail.com title=email><svg width="18" height="18" viewBox="0 0 24 21" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 4h16c1.1.0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1.0-2-.9-2-2V6c0-1.1.9-2 2-2z"/><path d="M22 6l-10 7L2 6"/></svg>
</a><a class="icon ml-1 mr-1" href=https://github.com/xbot title=github><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">stroke-linecap="round" stroke-linejoin="round"><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37.0 00-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44.0 0020 4.77 5.07 5.07.0 0019.91 1S18.73.65 16 2.48a13.38 13.38.0 00-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07.0 005 4.77 5.44 5.44.0 003.5 8.55c0 5.42 3.3 6.61 6.44 7A3.37 3.37.0 009 18.13V22"/></svg>
</a><a class="icon ml-1 mr-1" href=/index.xml title=rss><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 11a9 9 0 019 9M4 4a16 16 0 0116 16"/><circle cx="5" cy="19" r="1"/></svg></a></p></div></div></footer></body></html>