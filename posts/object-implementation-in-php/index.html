<!doctype html><html lang=en><head><meta charset=UTF-8><meta name=viewport content="width=device-width,initial-scale=1"><meta property="og:url" content="http://0x3f.org/posts/object-implementation-in-php/"><meta property="og:site_name" content="æ™´è€•é›¨è®€"><meta property="og:title" content="PHPå¯¹è±¡çš„å®ç°å’Œæ“ä½œ"><meta property="og:description" content="Objectçš„å­˜å‚¨ç»“æ„ å¯¹è±¡å®ä¾‹ç”¨zvalå­˜å‚¨ã€‚zval->type == IS_OBJECTï¼Œzval->value->objå­˜å‚¨zend_object_valueç±»å‹çš„ç»“æ„ä½“å˜é‡ã€‚
1 2 3 4 typedef struct _zend_object_value { zend_object_handle handle; const zend_object_handlers *handlers; } zend_object_value; zend_object_handleæ˜¯ä¸€ä¸ªunsigned intï¼Œæ˜¯å¯¹è±¡çš„IDã€‚zend_object_handlerså­˜å‚¨å¯¹è±¡æ‰€æœ‰çš„è¡Œä¸ºã€‚
Objectçš„å®ä¾‹åŒ–è¿‡ç¨‹ Objectçš„åˆå§‹åŒ–ç”¨ä»¥ä¸‹å‡ ä¸ªå®å‡½æ•°ï¼š
object_init(zval *arg) object_init_ex(zval *arg, zend_class_entry *class_type) object_and_properties_init(zval *arg, zend_class_entry *class_type, HashTable *properties) åº•å±‚éƒ½æ˜¯è°ƒç”¨_object_and_properties_init(zval *arg, zend_class_entry *class_type, HashTable *properties)å®ç°ã€‚è¿™ä¸ªå‡½æ•°åšä»¥ä¸‹å‡ ä»¶äº‹ï¼š
æ£€æŸ¥ç±»æ˜¯å¦å¯å®ä¾‹åŒ–ï¼ˆä¾‹å¦‚æ¥å£ã€æŠ½è±¡ç±»ç­‰ä¸å…è®¸åˆå§‹åŒ–ï¼‰ å¤„ç†ç±»å¸¸é‡ æ£€æŸ¥ç±»æ˜¯å¦å­˜åœ¨è‡ªå®šä¹‰å®ä¾‹åŒ–é€»è¾‘ è‹¥å­˜åœ¨ï¼Œè°ƒç”¨è‡ªå®šä¹‰å®ä¾‹åŒ–é€»è¾‘ è‹¥ä¸å­˜åœ¨ï¼Œè°ƒç”¨ç¼ºçœçš„å‡½æ•°zend_objects_new(zend_object **object, zend_class_entry *class_type) æŠŠå®ä¾‹åŒ–çš„zend_objectç±»å‹çš„æ•°æ®å­˜å…¥zvalä¸­ zend_objects_new()åšè¿™äº›äº‹ï¼š
åˆ†é…ä¸€ä¸ªzend_objectç±»å‹çš„å†…å­˜ç©ºé—´ åˆå§‹åŒ–zend_objectç±»å‹æ•°æ® æŠŠzend_objectç±»å‹æ•°æ®å­˜å…¥å¯¹è±¡ä»“åº“ï¼ˆObjects Storeï¼‰ zend_objects_store_put(void *object, zend_objects_store_dtor_t dtor, zend_objects_free_object_storage_t free_storage, zend_objects_store_clone_t cloneï¼‰ zend_objectçš„å­˜å‚¨ç»“æ„ 1 2 3 4 5 6 typedef struct _zend_object { zend_class_entry *ce; HashTable *properties; zval **properties_table; HashTable *guards; /* protects from __get/__set ... recursion */ } zend_object; ceæ˜¯ç±»çš„å®šä¹‰ã€‚properties_tableå­˜å‚¨ç±»é‡Œé¢„å®šä¹‰çš„å±æ€§ã€‚propertieså­˜å‚¨éé¢„å®šä¹‰å±æ€§ã€‚"><meta property="og:locale" content="zh_cn"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2015-04-29T23:00:00+00:00"><meta property="article:modified_time" content="2015-04-29T23:00:00+00:00"><meta property="article:tag" content="PHP"><meta property="article:tag" content="æºç "><meta property="article:tag" content="è®¡ç®—æœº"><meta name=twitter:card content="summary"><meta name=twitter:title content="PHPå¯¹è±¡çš„å®ç°å’Œæ“ä½œ"><meta name=twitter:description content="Objectçš„å­˜å‚¨ç»“æ„ å¯¹è±¡å®ä¾‹ç”¨zvalå­˜å‚¨ã€‚zval->type == IS_OBJECTï¼Œzval->value->objå­˜å‚¨zend_object_valueç±»å‹çš„ç»“æ„ä½“å˜é‡ã€‚
1 2 3 4 typedef struct _zend_object_value { zend_object_handle handle; const zend_object_handlers *handlers; } zend_object_value; zend_object_handleæ˜¯ä¸€ä¸ªunsigned intï¼Œæ˜¯å¯¹è±¡çš„IDã€‚zend_object_handlerså­˜å‚¨å¯¹è±¡æ‰€æœ‰çš„è¡Œä¸ºã€‚
Objectçš„å®ä¾‹åŒ–è¿‡ç¨‹ Objectçš„åˆå§‹åŒ–ç”¨ä»¥ä¸‹å‡ ä¸ªå®å‡½æ•°ï¼š
object_init(zval *arg) object_init_ex(zval *arg, zend_class_entry *class_type) object_and_properties_init(zval *arg, zend_class_entry *class_type, HashTable *properties) åº•å±‚éƒ½æ˜¯è°ƒç”¨_object_and_properties_init(zval *arg, zend_class_entry *class_type, HashTable *properties)å®ç°ã€‚è¿™ä¸ªå‡½æ•°åšä»¥ä¸‹å‡ ä»¶äº‹ï¼š
æ£€æŸ¥ç±»æ˜¯å¦å¯å®ä¾‹åŒ–ï¼ˆä¾‹å¦‚æ¥å£ã€æŠ½è±¡ç±»ç­‰ä¸å…è®¸åˆå§‹åŒ–ï¼‰ å¤„ç†ç±»å¸¸é‡ æ£€æŸ¥ç±»æ˜¯å¦å­˜åœ¨è‡ªå®šä¹‰å®ä¾‹åŒ–é€»è¾‘ è‹¥å­˜åœ¨ï¼Œè°ƒç”¨è‡ªå®šä¹‰å®ä¾‹åŒ–é€»è¾‘ è‹¥ä¸å­˜åœ¨ï¼Œè°ƒç”¨ç¼ºçœçš„å‡½æ•°zend_objects_new(zend_object **object, zend_class_entry *class_type) æŠŠå®ä¾‹åŒ–çš„zend_objectç±»å‹çš„æ•°æ®å­˜å…¥zvalä¸­ zend_objects_new()åšè¿™äº›äº‹ï¼š
åˆ†é…ä¸€ä¸ªzend_objectç±»å‹çš„å†…å­˜ç©ºé—´ åˆå§‹åŒ–zend_objectç±»å‹æ•°æ® æŠŠzend_objectç±»å‹æ•°æ®å­˜å…¥å¯¹è±¡ä»“åº“ï¼ˆObjects Storeï¼‰ zend_objects_store_put(void *object, zend_objects_store_dtor_t dtor, zend_objects_free_object_storage_t free_storage, zend_objects_store_clone_t cloneï¼‰ zend_objectçš„å­˜å‚¨ç»“æ„ 1 2 3 4 5 6 typedef struct _zend_object { zend_class_entry *ce; HashTable *properties; zval **properties_table; HashTable *guards; /* protects from __get/__set ... recursion */ } zend_object; ceæ˜¯ç±»çš„å®šä¹‰ã€‚properties_tableå­˜å‚¨ç±»é‡Œé¢„å®šä¹‰çš„å±æ€§ã€‚propertieså­˜å‚¨éé¢„å®šä¹‰å±æ€§ã€‚"><meta name=theme-color media="(prefers-color-scheme: light)" content="#ffffff"><meta name=theme-color media="(prefers-color-scheme: dark)" content="#181818"><title>æ™´è€•é›¨è®€ - PHPå¯¹è±¡çš„å®ç°å’Œæ“ä½œ</title><link rel="shortcut icon" href=/favicon.ico type=image/x-icon><link rel=stylesheet href=/minima.91848781a7679600f0ad1ad577e7da4fbb28b9f3fdc9a82126197659405bb483.css integrity="sha256-kYSHgadnlgDwrRrVd+faT7soufP9yaghJhl2WUBbtIM="><script defer type=text/javascript src=/minima.5f772103e807a34ef8ab63c3c53905fbf70689fa70d121085c7d0e84087effea.js integrity="sha256-X3chA+gHo074q2PDxTkF+/cGifpw0SEIXH0OhAh+/+o="></script></head><script>const theme_config="system",theme_light=theme_config==="system"?"light":theme_config;let theme=window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":theme_light;console.debug(theme);try{localStorage.setItem("theme",theme),window.minima_theme=theme,document.querySelector("html").classList.add(theme)}catch(e){console.error(e)}</script><body><header class="mt-3 mb-8"><div class="container mx-auto"><nav class="flex justify-between items-center"><div class="flex items-center"><div id=theme-switch class="text-2xl cursor-pointer">ğŸŒ</div></div><ul class="flex items-center text-base font-semibold
whitespace-nowrap overflow-x-auto overflow-y-hidden"><li class="ml-2 mr-2"><a href=/>é¦–é¡µ</a></li><li class="ml-2 mr-2"><a href=/posts>æ–‡ç« </a></li><li class="ml-2 mr-2"><a href=/tags>æ ‡ç­¾</a></li><li class="ml-2 mr-2"><a href=/about>å…³äº</a></li><li class="ml-2 mr-2"><a href=/search>ğŸ”</a></li></ul></nav></div></header><div class="container mx-auto"><h1 class="text-4xl font-extrabold mt-6 mb-6">PHPå¯¹è±¡çš„å®ç°å’Œæ“ä½œ</h1><div class="mb-3 text-sm flex justify-between"><div>å‘å¸ƒäº &mdash; 2015 å¹´ 04 æœˆ 29 æ—¥</div><div><a class=ml-1 href=/tags/PHP>#PHP</a>
<a class=ml-1 href=/tags/%e6%ba%90%e7%a0%81>#æºç </a>
<a class=ml-1 href=/tags/%e8%ae%a1%e7%ae%97%e6%9c%ba>#è®¡ç®—æœº</a></div></div><main class=mb-8><p></p><article class=md><h2 id=objectçš„å­˜å‚¨ç»“æ„>Objectçš„å­˜å‚¨ç»“æ„</h2><p>å¯¹è±¡å®ä¾‹ç”¨zvalå­˜å‚¨ã€‚zval->type == IS_OBJECTï¼Œzval->value->objå­˜å‚¨zend_object_valueç±»å‹çš„ç»“æ„ä½“å˜é‡ã€‚</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=k>typedef</span> <span class=k>struct</span> <span class=n>_zend_object_value</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>zend_object_handle</span> <span class=n>handle</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>const</span> <span class=n>zend_object_handlers</span> <span class=o>*</span><span class=n>handlers</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span> <span class=n>zend_object_value</span><span class=p>;</span>
</span></span></code></pre></td></tr></table></div></div><p>zend_object_handleæ˜¯ä¸€ä¸ªunsigned intï¼Œæ˜¯å¯¹è±¡çš„IDã€‚zend_object_handlerså­˜å‚¨å¯¹è±¡æ‰€æœ‰çš„è¡Œä¸ºã€‚</p><h2 id=objectçš„å®ä¾‹åŒ–è¿‡ç¨‹>Objectçš„å®ä¾‹åŒ–è¿‡ç¨‹</h2><p>Objectçš„åˆå§‹åŒ–ç”¨ä»¥ä¸‹å‡ ä¸ªå®å‡½æ•°ï¼š</p><ul><li>object_init(zval *arg)</li><li>object_init_ex(zval *arg, zend_class_entry *class_type)</li><li>object_and_properties_init(zval *arg, zend_class_entry *class_type, HashTable *properties)</li></ul><p>åº•å±‚éƒ½æ˜¯è°ƒç”¨_object_and_properties_init(zval *arg, zend_class_entry *class_type, HashTable *properties)å®ç°ã€‚è¿™ä¸ªå‡½æ•°åšä»¥ä¸‹å‡ ä»¶äº‹ï¼š</p><ul><li>æ£€æŸ¥ç±»æ˜¯å¦å¯å®ä¾‹åŒ–ï¼ˆä¾‹å¦‚æ¥å£ã€æŠ½è±¡ç±»ç­‰ä¸å…è®¸åˆå§‹åŒ–ï¼‰</li><li>å¤„ç†ç±»å¸¸é‡</li><li>æ£€æŸ¥ç±»æ˜¯å¦å­˜åœ¨è‡ªå®šä¹‰å®ä¾‹åŒ–é€»è¾‘<ul><li>è‹¥å­˜åœ¨ï¼Œè°ƒç”¨è‡ªå®šä¹‰å®ä¾‹åŒ–é€»è¾‘</li><li>è‹¥ä¸å­˜åœ¨ï¼Œè°ƒç”¨ç¼ºçœçš„å‡½æ•°zend_objects_new(zend_object **object, zend_class_entry *class_type)</li></ul></li><li>æŠŠå®ä¾‹åŒ–çš„zend_objectç±»å‹çš„æ•°æ®å­˜å…¥zvalä¸­</li></ul><p>zend_objects_new()åšè¿™äº›äº‹ï¼š</p><ul><li>åˆ†é…ä¸€ä¸ªzend_objectç±»å‹çš„å†…å­˜ç©ºé—´</li><li>åˆå§‹åŒ–zend_objectç±»å‹æ•°æ®</li><li>æŠŠzend_objectç±»å‹æ•°æ®å­˜å…¥å¯¹è±¡ä»“åº“ï¼ˆObjects Storeï¼‰<ul><li>zend_objects_store_put(void *object, zend_objects_store_dtor_t dtor, zend_objects_free_object_storage_t free_storage, zend_objects_store_clone_t cloneï¼‰</li></ul></li></ul><h2 id=zend_objectçš„å­˜å‚¨ç»“æ„>zend_objectçš„å­˜å‚¨ç»“æ„</h2><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=k>typedef</span> <span class=k>struct</span> <span class=n>_zend_object</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>zend_class_entry</span> <span class=o>*</span><span class=n>ce</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>HashTable</span> <span class=o>*</span><span class=n>properties</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>zval</span> <span class=o>**</span><span class=n>properties_table</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>HashTable</span> <span class=o>*</span><span class=n>guards</span><span class=p>;</span> <span class=cm>/* protects from __get/__set ... recursion */</span>
</span></span><span class=line><span class=cl><span class=p>}</span> <span class=n>zend_object</span><span class=p>;</span>
</span></span></code></pre></td></tr></table></div></div><p>ceæ˜¯ç±»çš„å®šä¹‰ã€‚properties_tableå­˜å‚¨ç±»é‡Œé¢„å®šä¹‰çš„å±æ€§ã€‚propertieså­˜å‚¨éé¢„å®šä¹‰å±æ€§ã€‚</p><p>guardså­˜å‚¨å±æ€§ååˆ°zend_guardç»“æ„çš„æ˜ å°„å…³ç³»ã€‚</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=k>typedef</span> <span class=k>struct</span> <span class=n>_zend_guard</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>zend_bool</span> <span class=n>in_get</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>zend_bool</span> <span class=n>in_set</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>zend_bool</span> <span class=n>in_unset</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>zend_bool</span> <span class=n>in_isset</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>zend_bool</span> <span class=n>dummy</span><span class=p>;</span> <span class=cm>/* sizeof(zend_guard) must not be equal to sizeof(void*) */</span>
</span></span><span class=line><span class=cl><span class=p>}</span> <span class=n>zend_guard</span><span class=p>;</span>
</span></span></code></pre></td></tr></table></div></div><p>æ­¤ç»“æ„ç”¨äºåœ¨æ“ä½œå±æ€§æ—¶ï¼Œé˜²æ­¢é€’å½’è°ƒç”¨ã€‚ä¾‹å¦‚ç»™å¯¹è±¡ä¸€ä¸ªæ–°å±æ€§èµ‹å€¼æ—¶ï¼Œ__set()å‡½æ•°ç†è®ºä¸Šä¼šé€’å½’è°ƒç”¨è‡ªå·±ï¼Œæ‰€ä»¥æ­¤ç»“æ„ç”¨äºåˆ¤æ–­è¯¥å±æ€§æ˜¯å¦å·²åœ¨__set()ä¸­ã€‚</p><h2 id=å±æ€§çš„å­˜å‚¨ç»“æ„>å±æ€§çš„å­˜å‚¨ç»“æ„</h2><p>åœ¨zend_objectçš„å­˜å‚¨ç»“æ„é‡Œï¼Œå“ˆå¸Œè¡¨propertieså­˜å‚¨ç±»çš„éé¢„å®šä¹‰å±æ€§çš„åç§°å’Œå€¼ã€‚</p><p>å¯¹äºé¢„å®šä¹‰çš„å±æ€§ï¼Œç”±äºPHPçš„å“ˆå¸Œè¡¨çš„å­˜å‚¨å¼€é”€å¾ˆå¤§ï¼Œæ‰€ä»¥æŠŠå±æ€§ä¿¡æ¯ï¼ˆå³ä¸‹é¢çš„zend_property_infoç»“æ„ä½“ï¼‰å­˜å‚¨åœ¨zend_class_entryé‡Œï¼Œå¯¹è±¡é‡Œç”¨Cçš„æ•°ç»„å­˜å‚¨æ‰€æœ‰é¢„å®šä¹‰å±æ€§çš„zvalçš„æŒ‡é’ˆï¼Œå¹¶æŠŠåç§»é‡è®°å½•åœ¨å±æ€§ä¿¡æ¯é‡Œï¼Œè¿™å°±æ˜¯properties_tableã€‚</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=k>typedef</span> <span class=k>struct</span> <span class=n>_zend_property_info</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>zend_uint</span> <span class=n>flags</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>const</span> <span class=kt>char</span> <span class=o>*</span><span class=n>name</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=n>name_length</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>ulong</span> <span class=n>h</span><span class=p>;</span>                 <span class=cm>/* hash of name */</span>
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=n>offset</span><span class=p>;</span>              <span class=cm>/* storage offset */</span>
</span></span><span class=line><span class=cl>    <span class=k>const</span> <span class=kt>char</span> <span class=o>*</span><span class=n>doc_comment</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=n>doc_comment_len</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>zend_class_entry</span> <span class=o>*</span><span class=n>ce</span><span class=p>;</span>    <span class=cm>/* CE of declaring class */</span>
</span></span><span class=line><span class=cl><span class=p>}</span> <span class=n>zend_property_info</span><span class=p>;</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=å±æ€§åçš„ç¼–ç >å±æ€§åçš„ç¼–ç </h3><p>åœ¨ç±»çš„ç»§æ‰¿å…³ç³»ä¸­ï¼ŒåŒåä¸åŒç±»å‹ï¼ˆpublicï¼Œprivateç­‰ï¼‰çš„å±æ€§å„è‡ªå•ç‹¬å­˜å‚¨ï¼Œæ‰€ä»¥å±æ€§ååœ¨åº•å±‚æ˜¯ç»è¿‡ç¼–ç çš„ï¼Œè§„åˆ™å¦‚ä¸‹ï¼š</p><blockquote><p>class Foo { private $prop; } => &ldquo;\0Foo\0prop&rdquo;<br>class Bar { private $prop; } => &ldquo;\0Bar\0prop&rdquo;<br>class Rab { protected $prop; } => &ldquo;\0*\0prop&rdquo;<br>class Oof { public $prop; } => &ldquo;prop&rdquo;</p></blockquote><p>å¤§éƒ¨åˆ†æƒ…å†µä¸‹ï¼Œå¯¹å±æ€§æ“ä½œçš„APIè‡ªåŠ¨å¤„ç†å±æ€§åçš„ç¼–ç ã€‚åªæœ‰å½“éœ€è¦ç›´æ¥è®¿é—®property_info->nameæˆ–zobj->propertiesæ—¶æ‰éœ€è¦è‡ªè¡Œå¤„ç†ï¼Œæ­¤æ—¶ä½¿ç”¨zend_(un)mangle_property_name()å‡½æ•°ã€‚</p><h2 id=objects-storeçš„å­˜å‚¨ç»“æ„>Objects Storeçš„å­˜å‚¨ç»“æ„</h2><p>å¯¹è±¡ä»“åº“æ˜¯ä¸€ä¸ªå¯å˜æ•°ç»„ï¼Œå­˜å‚¨å¤šä¸ªzend_object_store_bucketç»“æ„ã€‚</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=k>typedef</span> <span class=k>struct</span> <span class=n>_zend_objects_store</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>zend_object_store_bucket</span> <span class=o>*</span><span class=n>object_buckets</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>zend_uint</span> <span class=n>top</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>zend_uint</span> <span class=n>size</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=n>free_list_head</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span> <span class=n>zend_objects_store</span><span class=p>;</span>
</span></span></code></pre></td></tr></table></div></div><p>sizeæ˜¯å¯¹è±¡ä»“åº“çš„å®¹é‡ã€‚topæ˜¯ä¸‹ä¸€ä¸ªå¯ç”¨çš„å¯¹è±¡å¥æŸ„ï¼Œå¯¹è±¡å¥æŸ„ä»1å¼€å§‹ï¼Œä»¥ä¿è¯æ‰€æœ‰å¥æŸ„éƒ½ä¸ºçœŸã€‚å¯¹è±¡ä»“åº“é€šè¿‡æ¯ä¸ªBucketçš„free_listç»“æ„ç»´æŠ¤ä¸€ä¸ªå¯ç”¨çš„Bucketé“¾è¡¨ï¼Œfree_list_headè®°å½•é“¾è¡¨çš„å¤´éƒ¨ã€‚</p><h3 id=zend_object_store_bucketçš„å­˜å‚¨ç»“æ„>zend_object_store_bucketçš„å­˜å‚¨ç»“æ„</h3><p>æ¯ä¸ªå¯¹è±¡çš„ä¿¡æ¯å­˜å‚¨åœ¨ä¸€ä¸ªbucketé‡Œã€‚</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=k>typedef</span> <span class=k>struct</span> <span class=n>_zend_object_store_bucket</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>zend_bool</span> <span class=n>destructor_called</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>zend_bool</span> <span class=n>valid</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>union</span> <span class=n>_store_bucket</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>struct</span> <span class=n>_store_object</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=kt>void</span> <span class=o>*</span><span class=n>object</span><span class=p>;</span>
</span></span><span class=line><span class=cl>            <span class=kt>zend_objects_store_dtor_t</span> <span class=n>dtor</span><span class=p>;</span>
</span></span><span class=line><span class=cl>            <span class=kt>zend_objects_free_object_storage_t</span> <span class=n>free_storage</span><span class=p>;</span>
</span></span><span class=line><span class=cl>            <span class=kt>zend_objects_store_clone_t</span> <span class=n>clone</span><span class=p>;</span>
</span></span><span class=line><span class=cl>            <span class=k>const</span> <span class=n>zend_object_handlers</span> <span class=o>*</span><span class=n>handlers</span><span class=p>;</span>
</span></span><span class=line><span class=cl>            <span class=n>zend_uint</span> <span class=n>refcount</span><span class=p>;</span>
</span></span><span class=line><span class=cl>            <span class=n>gc_root_buffer</span> <span class=o>*</span><span class=n>buffered</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span> <span class=n>obj</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=k>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=kt>int</span> <span class=n>next</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span> <span class=n>free_list</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span> <span class=n>bucket</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span> <span class=n>zend_object_store_bucket</span><span class=p>;</span>
</span></span></code></pre></td></tr></table></div></div><p>æ¡¶è¢«å ç”¨çš„æ—¶å€™ï¼Œvalidä¸º1ï¼Œå¦åˆ™ä¸º0ã€‚</p><p>å¯¹è±¡è¢«é”€æ¯æ—¶ï¼Œdtorè¢«è°ƒç”¨åï¼Œdestructor_calledè¢«ç½®ä¸º1ï¼Œé˜²æ­¢åœ¨è¢«freeæ—¶é‡å¤è°ƒç”¨dtorï¼Œå…·ä½“è§<strong>Objectçš„äºŒé˜¶é”€æ¯é€»è¾‘</strong>ã€‚</p><p>_store_objecté‡Œå­˜å‚¨å¯¹è±¡çš„ä¸»è¦ä¿¡æ¯ã€‚zend_objects_store_put()ä¼ å…¥çš„zend_objectç»“æ„ä½“å­˜å‚¨åœ¨objecté‡Œã€‚dtorå’Œfree_storageè§<strong>Objectçš„äºŒé˜¶é”€æ¯é€»è¾‘</strong>ã€‚cloneæ˜¯å¯¹è±¡çš„å…‹éš†å‡½æ•°ã€‚handlerså­˜å‚¨å¯¹è±¡çš„ä¸€ç³»åˆ—æ“ä½œå‡½æ•°ï¼Œç¼ºçœä¸ºstd_object_handlersã€‚refcountæ˜¯å¯¹è±¡çš„å¼•ç”¨è®¡æ•°ã€‚bufferedæ˜¯åƒåœ¾å›æ”¶éœ€è¦ç”¨åˆ°çš„æ•°æ®ã€‚</p><p>free_listè®°å½•å¯¹è±¡ä»“åº“ä¸­å¯ç”¨çš„Bucketé“¾è¡¨ä¸­ä¸‹ä¸€ä¸ªå¯ç”¨çš„Bucketã€‚</p><h3 id=object-storeçš„æ“ä½œ>Object Storeçš„æ“ä½œ</h3><ul><li>zend_objects_store_put()ï¼šæ³¨å†Œå¯¹è±¡åˆ°ä»“åº“</li><li>zend_object_store_get_object_by_handle()ï¼šé€šè¿‡å¯¹è±¡å¥æŸ„å–å¯¹è±¡</li><li>zend_object_store_get_object()ï¼šé€šè¿‡zvalå–å¯¹è±¡ï¼Œè¿”å›void*</li><li>zend_objects_get_address()ï¼šå’Œzend_object_store_get_object()ä¸€æ ·ï¼Œä½†è¿”å›zend_object*</li></ul><h2 id=objectçš„äºŒé˜¶é”€æ¯é€»è¾‘>Objectçš„äºŒé˜¶é”€æ¯é€»è¾‘</h2><p>å¯¹è±¡çš„é”€æ¯åˆ†ä¸¤ä¸ªæ­¥éª¤ï¼Œä¸€æ˜¯å¯¹è±¡çš„ææ„ï¼Œä¸€æ˜¯å†…å­˜çš„é‡Šæ”¾ã€‚å‰è€…è°ƒç”¨å¯¹è±¡çš„dtorï¼Œåè€…è°ƒç”¨free_storageã€‚ä¸€èˆ¬å…ˆææ„ï¼Œå†é‡Šæ”¾å†…å­˜ï¼Œä½†ä¸¤è€…å¯å„è‡ªåˆ†å¼€æ‰§è¡Œã€‚</p><p>dtorä¸­å¯ä»¥æ‰§è¡Œç”¨æˆ·ç©ºé—´çš„PHPä»£ç ï¼Œä¸»è¦æ˜¯PHPç±»çš„__destruct()ã€‚PHPè„šæœ¬æ‰§è¡Œå®Œæˆåé”€æ¯å¯¹è±¡å¹¶ç»“æŸè¿›ç¨‹ï¼ˆexecutor shutdownï¼‰ï¼Œåœ¨è¿™ä¸ªè¿‡ç¨‹è¿›è¡Œåˆ°ä¸€åŠçš„æ—¶å€™æ‰§è¡Œç”¨æˆ·ç©ºé—´ä»£ç å¯èƒ½ä¼šå‡ºé—®é¢˜ï¼Œæ‰€ä»¥è¿™ä¹ˆåŒºåˆ«ä¸»è¦æ˜¯ä¸ºäº†åœ¨è¿›ç¨‹ç»“æŸè¿‡ç¨‹ä¸­ä¸ä¼šè°ƒç”¨ç”¨æˆ·ç©ºé—´ä»£ç ã€‚</p><p>æ­¤å¤–ï¼Œdtorå¹¶ä¸æ˜¯å¿…é¡»æ‰§è¡Œçš„ï¼Œå¦‚æœä¸€ä¸ªå¯¹è±¡çš„dtorè°ƒç”¨çš„ç”¨æˆ·ç©ºé—´ä»£ç é‡Œæ‰§è¡Œäº†die()ï¼Œåç»­å¯¹è±¡çš„dtorä¸ä¼šè¢«æ‰§è¡Œã€‚æ‰€ä»¥å¤§éƒ¨åˆ†æƒ…å†µä¸‹ï¼Œå¼€å‘è€…å¯ä»¥è‡ªå®šä¹‰free_storageå‡½æ•°ï¼Œè€Œä½¿ç”¨ç¼ºçœçš„zend_objects_destroy_objectä½œä¸ºdtorã€‚</p></article></main><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.13.11/dist/katex.min.css integrity=sha384-Um5gpz1odJg5Z4HAmzPtgZKdTBHZdw8S29IecapCSB31ligYPhHQZMIlWLYQGVoc crossorigin=anonymous><script defer src=https://cdn.jsdelivr.net/npm/katex@0.13.11/dist/katex.min.js integrity=sha384-YNHdsYkH6gMx9y3mRkmcJ2mFUjTd0qNQQvY9VYZgQd7DcN7env35GzlmFaZ23JGp crossorigin=anonymous></script><script defer src=https://cdn.jsdelivr.net/npm/katex@0.13.11/dist/contrib/auto-render.min.js integrity=sha384-vZTG03m+2yp6N6BNi5iM4rW4oIwk5DfcNdFfxkk9ZWpDriOkXX8voJBFrAO7MpVl crossorigin=anonymous></script><script>document.addEventListener("DOMContentLoaded",function(){renderMathInElement(document.body,{delimiters:[{left:"$$",right:"$$",display:!0},{left:"$",right:"$",display:!1},{left:"\\(",right:"\\)",display:!1},{left:"\\[",right:"\\]",display:!0}],throwOnError:!1})})</script><script src=https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js crossorigin=anonymous></script><script>mermaid.init(0[0],"code.language-mermaid")</script><div id=comment></div><script>const s=document.createElement("script");s.src="https://utteranc.es/client.js",s.crossOrigin="anonymous",s.async=!0,s.setAttribute("repo","xbot/blog-comments"),s.setAttribute("issue-term","pathname"),s.setAttribute("label","comment"),s.setAttribute("theme","github-"+window.minima_theme),document.getElementById("comment").appendChild(s)</script></div><footer class="mt-8 mb-8"><div class="container mx-auto"><div class="mt-8 flex flex-col-reverse sm:flex-row sm:justify-between items-center"><div class="text-center sm:text-left"><p class="mt-0 text-sm">Â© 2007-2024 é¬¼é©¬å¦–åˆ€</p><p class="mt-0 text-xs">Built with <a href=https://gohugo.io target=_blank rel="noopener noreferrer">Hugo</a> v0.155.3
and <a href=https://github.com/mivinci/hugo-theme-minima target=_blank rel="noopener noreferrer">Minima</a></p></div><p class="flex items-center mt-0"><a class="icon ml-1 mr-1" href=mailto:donie.leigh@gmail.com title=email><svg width="18" height="18" viewBox="0 0 24 21" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 4h16c1.1.0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1.0-2-.9-2-2V6c0-1.1.9-2 2-2z"/><path d="M22 6l-10 7L2 6"/></svg>
</a><a class="icon ml-1 mr-1" href=https://github.com/xbot title=github><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">stroke-linecap="round" stroke-linejoin="round"><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37.0 00-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44.0 0020 4.77 5.07 5.07.0 0019.91 1S18.73.65 16 2.48a13.38 13.38.0 00-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07.0 005 4.77 5.44 5.44.0 003.5 8.55c0 5.42 3.3 6.61 6.44 7A3.37 3.37.0 009 18.13V22"/></svg>
</a><a class="icon ml-1 mr-1" href=/index.xml title=rss><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 11a9 9 0 019 9M4 4a16 16 0 0116 16"/><circle cx="5" cy="19" r="1"/></svg></a></p></div></div></footer></body></html>