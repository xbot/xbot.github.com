<!doctype html><html lang=en><head><meta charset=UTF-8><meta name=viewport content="width=device-width,initial-scale=1"><meta property="og:url" content="http://0x3f.org/posts/flamework-error-auto-handling/"><meta property="og:site_name" content="晴耕雨讀"><meta property="og:title" content="PHP框架实战（二）：错误和异常的自动处理"><meta property="og:description" content="目标 实现错误和异常的自动捕获和处理。
获取代码 1 git checkout v0.2 设计与实现 使用set_error_handler()和set_exception_handler()两个函数注册错误和异常的处理方法，并在两个处理方法中先调用用户自定义的错误和异常处理逻辑，如果自定义逻辑不存在或者返回false，继续调用框架缺省的处理逻辑，输出错误信息到页面。
1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 131 132 133 134 135 136 137 138 139 140 141 142 143 144 <?php class WebApplication { // ... /** * @var boolean Whether to enable error auto-handling, default to true * @since 1.0 */ public $enableErrorHandling = true; /** * @var boolean Whether to enable exception auto-handling, default to true * @since 1.0 */ public $enableExceptionHandling = true; /** * @var callable Error handler * @since 1.0 */ public $errorHandler; /** * @var callable Exception handler * @since 1.0 */ public $exceptionHandler; /** * @var boolean Whether to enable debug mode, default to false * @since 1.0 */ public $debug = false; /** * @param string $config */ public function __construct($config) { // ... $this->initErrorHandlers(); } /** * Initialize auto-handling for errors and exceptions * @return void * @since 1.0 */ public function initErrorHandlers() { if ($this->enableErrorHandling == true) set_error_handler(array($this, 'handleError'), error_reporting()); if ($this->enableExceptionHandling == true) set_exception_handler(array($this, 'handleException')); } /** * Handle errors * @param int $code * @param string $message * @param string $file * @param int $line * @return void * @since 1.0 */ public function handleError($code, $message, $file, $line) { // prevent recursive errors restore_error_handler(); restore_exception_handler(); $msg = &#34;Error $code: $message ($file:$line)&#34;; Flame::error($msg); // let errorHandler() return true to prevent displayError() if (is_callable($this->errorHandler) && call_user_func($this->errorHandler, $code, $message, $file, $line) !== true) $this->displayError($code, $message, $file, $line); exit(1); } /** * Handle exceptions * @param Exception $exception * @return void * @since 1.0 */ public function handleException($exception) { // prevent recursive errors restore_error_handler(); restore_exception_handler(); $msg = get_class($exception).': '.$exception->getMessage().' ('.$exception->getFile().':'.$exception->getLine().&#34;\n&#34;.$exception->getTraceAsString(); Flame::error($msg); // let exceptionHandler() return true to prevent displayException() if (is_callable($this->exceptionHandler) && call_user_func($this->exceptionHandler, $exception) !== true) $this->displayException($exception); exit(1); } /** * Display error information * @param int $code * @param string $message * @param string $file * @param int $line * @return void * @since 1.0 */ public function displayError($code, $message, $file, $line) { if ($this->debug == true) { echo &#34;<h1>Error $code</h1>&#34;; echo &#34;<p>$message in ($file:$line)</p>&#34;; echo '<pre>'; debug_print_backtrace(); echo '</pre>'; } else { echo &#34;<h1>Error $code</h1>&#34;; echo &#34;<p>$message</p>&#34;; } } /** * Display exception information * @param Exception $exception * @return void * @since 1.0 */ public function displayException($exception) { if ($this->debug == true) { echo '<h1>'.get_class($exception).'</h1>'; echo '<p>'.$exception->getMessage().' ('.$exception->getFile().':'.$exception->getLine().')</p>'; echo '<pre>'.$exception->getTraceAsString().'</pre>'; } else { echo '<h1>'.get_class($exception).'</h1>'; echo '<p>'.$exception->getMessage().'</p>'; } } // ... } ?> “handleError()”和“handleException()”中先调用了“restore_error_handler()”和“restore_exception_handler()”，用于防止递归处理。"><meta property="og:locale" content="zh_cn"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2013-12-28T13:40:00+00:00"><meta property="article:modified_time" content="2013-12-28T13:40:00+00:00"><meta property="article:tag" content="PHP"><meta property="article:tag" content="Flamework"><meta property="article:tag" content="框架"><meta property="article:tag" content="编程"><meta property="article:tag" content="计算机"><meta name=twitter:card content="summary"><meta name=twitter:title content="PHP框架实战（二）：错误和异常的自动处理"><meta name=twitter:description content="目标 实现错误和异常的自动捕获和处理。
获取代码 1 git checkout v0.2 设计与实现 使用set_error_handler()和set_exception_handler()两个函数注册错误和异常的处理方法，并在两个处理方法中先调用用户自定义的错误和异常处理逻辑，如果自定义逻辑不存在或者返回false，继续调用框架缺省的处理逻辑，输出错误信息到页面。
1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 131 132 133 134 135 136 137 138 139 140 141 142 143 144 <?php class WebApplication { // ... /** * @var boolean Whether to enable error auto-handling, default to true * @since 1.0 */ public $enableErrorHandling = true; /** * @var boolean Whether to enable exception auto-handling, default to true * @since 1.0 */ public $enableExceptionHandling = true; /** * @var callable Error handler * @since 1.0 */ public $errorHandler; /** * @var callable Exception handler * @since 1.0 */ public $exceptionHandler; /** * @var boolean Whether to enable debug mode, default to false * @since 1.0 */ public $debug = false; /** * @param string $config */ public function __construct($config) { // ... $this->initErrorHandlers(); } /** * Initialize auto-handling for errors and exceptions * @return void * @since 1.0 */ public function initErrorHandlers() { if ($this->enableErrorHandling == true) set_error_handler(array($this, 'handleError'), error_reporting()); if ($this->enableExceptionHandling == true) set_exception_handler(array($this, 'handleException')); } /** * Handle errors * @param int $code * @param string $message * @param string $file * @param int $line * @return void * @since 1.0 */ public function handleError($code, $message, $file, $line) { // prevent recursive errors restore_error_handler(); restore_exception_handler(); $msg = &#34;Error $code: $message ($file:$line)&#34;; Flame::error($msg); // let errorHandler() return true to prevent displayError() if (is_callable($this->errorHandler) && call_user_func($this->errorHandler, $code, $message, $file, $line) !== true) $this->displayError($code, $message, $file, $line); exit(1); } /** * Handle exceptions * @param Exception $exception * @return void * @since 1.0 */ public function handleException($exception) { // prevent recursive errors restore_error_handler(); restore_exception_handler(); $msg = get_class($exception).': '.$exception->getMessage().' ('.$exception->getFile().':'.$exception->getLine().&#34;\n&#34;.$exception->getTraceAsString(); Flame::error($msg); // let exceptionHandler() return true to prevent displayException() if (is_callable($this->exceptionHandler) && call_user_func($this->exceptionHandler, $exception) !== true) $this->displayException($exception); exit(1); } /** * Display error information * @param int $code * @param string $message * @param string $file * @param int $line * @return void * @since 1.0 */ public function displayError($code, $message, $file, $line) { if ($this->debug == true) { echo &#34;<h1>Error $code</h1>&#34;; echo &#34;<p>$message in ($file:$line)</p>&#34;; echo '<pre>'; debug_print_backtrace(); echo '</pre>'; } else { echo &#34;<h1>Error $code</h1>&#34;; echo &#34;<p>$message</p>&#34;; } } /** * Display exception information * @param Exception $exception * @return void * @since 1.0 */ public function displayException($exception) { if ($this->debug == true) { echo '<h1>'.get_class($exception).'</h1>'; echo '<p>'.$exception->getMessage().' ('.$exception->getFile().':'.$exception->getLine().')</p>'; echo '<pre>'.$exception->getTraceAsString().'</pre>'; } else { echo '<h1>'.get_class($exception).'</h1>'; echo '<p>'.$exception->getMessage().'</p>'; } } // ... } ?> “handleError()”和“handleException()”中先调用了“restore_error_handler()”和“restore_exception_handler()”，用于防止递归处理。"><meta name=theme-color media="(prefers-color-scheme: light)" content="#ffffff"><meta name=theme-color media="(prefers-color-scheme: dark)" content="#181818"><title>晴耕雨讀 - PHP框架实战（二）：错误和异常的自动处理
</title><link rel="shortcut icon" href=/favicon.ico type=image/x-icon><link rel=stylesheet href=/minima.91848781a7679600f0ad1ad577e7da4fbb28b9f3fdc9a82126197659405bb483.css integrity="sha256-kYSHgadnlgDwrRrVd+faT7soufP9yaghJhl2WUBbtIM="><script defer type=text/javascript src=/minima.5f772103e807a34ef8ab63c3c53905fbf70689fa70d121085c7d0e84087effea.js integrity="sha256-X3chA+gHo074q2PDxTkF+/cGifpw0SEIXH0OhAh+/+o="></script></head><script>const theme_config="system",theme_light=theme_config==="system"?"light":theme_config;let theme=window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":theme_light;console.debug(theme);try{localStorage.setItem("theme",theme),window.minima_theme=theme,document.querySelector("html").classList.add(theme)}catch(e){console.error(e)}</script><body><header class="mt-3 mb-8"><div class="container mx-auto"><nav class="flex justify-between items-center"><div class="flex items-center"><div id=theme-switch class="text-2xl cursor-pointer">🌝</div></div><ul class="flex items-center text-base font-semibold
whitespace-nowrap overflow-x-auto overflow-y-hidden"><li class="ml-2 mr-2"><a href=/>首页</a></li><li class="ml-2 mr-2"><a href=/posts>文章</a></li><li class="ml-2 mr-2"><a href=/tags>标签</a></li><li class="ml-2 mr-2"><a href=/about>关于</a></li><li class="ml-2 mr-2"><a href=/search>🔍</a></li></ul></nav></div></header><main class="container mx-auto"><h2 class="text-3xl font-bold mb-3">PHP框架实战（二）：错误和异常的自动处理</h2><ul class=list-disc></ul></nav></main><footer class="mt-8 mb-8"><div class="container mx-auto"><div class="mt-8 flex flex-col-reverse sm:flex-row sm:justify-between items-center"><div class="text-center sm:text-left"><p class="mt-0 text-sm">© 2007-2024 鬼马妖刀</p><p class="mt-0 text-xs">Built with <a href=https://gohugo.io target=_blank rel="noopener noreferrer">Hugo</a> v0.146.3
and <a href=https://github.com/mivinci/hugo-theme-minima target=_blank rel="noopener noreferrer">Minima</a></p></div><p class="flex items-center mt-0"><a class="icon ml-1 mr-1" href=mailto:donie.leigh@gmail.com title=email><svg width="18" height="18" viewBox="0 0 24 21" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 4h16c1.1.0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1.0-2-.9-2-2V6c0-1.1.9-2 2-2z"/><path d="M22 6l-10 7L2 6"/></svg>
</a><a class="icon ml-1 mr-1" href=https://github.com/xbot title=github><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">stroke-linecap="round" stroke-linejoin="round"><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37.0 00-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44.0 0020 4.77 5.07 5.07.0 0019.91 1S18.73.65 16 2.48a13.38 13.38.0 00-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07.0 005 4.77 5.44 5.44.0 003.5 8.55c0 5.42 3.3 6.61 6.44 7A3.37 3.37.0 009 18.13V22"/></svg>
</a><a class="icon ml-1 mr-1" href=/index.xml title=rss><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 11a9 9 0 019 9M4 4a16 16 0 0116 16"/><circle cx="5" cy="19" r="1"/></svg></a></p></div></div></footer></body></html>